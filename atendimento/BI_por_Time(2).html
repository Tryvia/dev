<!doctype html>
<html lang="pt-br">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BI por Time ‚Äî Grupo Tratativa</title>

<!-- Favicon inline para evitar erro 404 -->
<link rel="icon" type="image/png" href="tryvia.png" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Modular CSS Architecture -->
<link rel="stylesheet" href="styles/bi-dashboard.css">
<link rel="stylesheet" href="styles/sidebar.css">
<link rel="stylesheet" href="styles/sidebar-premium.css">
<link rel="stylesheet" href="styles/presentation-premium.css">
<link rel="stylesheet" href="styles/reports-premium.css">
<link rel="stylesheet" href="styles/topbar.css">
<link rel="stylesheet" href="styles/cards.css">
<link rel="stylesheet" href="styles/charts.css">
<link rel="stylesheet" href="styles/modals.css">
<link rel="stylesheet" href="styles/presentation.css">
<link rel="stylesheet" href="styles/animations.css">
<link rel="stylesheet" href="styles/responsive.css">
<style>
/* Animations */
@keyframes fadeInSlide {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Critical inline styles for faster first paint - keep minimal for best performance */
body {
  background: #0f0f0f;
  color: #e4e4e7;
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
}

/* Select dropdowns - Fix for dark theme */
.bi-select {
  background: #1e1e2e !important;
  color: #e4e4e7 !important;
  border: 1px solid #3f3f5a !important;
  border-radius: 8px;
  padding: 0.75rem 1rem;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
}
.bi-select:hover {
  border-color: #667eea !important;
  background: #252536 !important;
}
.bi-select:focus {
  outline: none;
  border-color: #667eea !important;
  box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
}

/* Scrollbar global - previne flickering */
*::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
*::-webkit-scrollbar-track {
  background: #1e1e2e;
  border-radius: 4px;
}
*::-webkit-scrollbar-thumb {
  background: #52525b;
  border-radius: 4px;
  border: 2px solid #1e1e2e;
}
*::-webkit-scrollbar-thumb:hover {
  background: #71717a;
}
/* Firefox scrollbar */
* {
  scrollbar-width: thin;
  scrollbar-color: #52525b #1e1e2e;
}
/* Prevenir reflow em elementos com hover */
[onmouseover] {
  will-change: transform, box-shadow;
  backface-visibility: hidden;
}
.bi-select option {
  background: #1e1e2e !important;
  color: #e4e4e7 !important;
  padding: 0.5rem;
}
.bi-select option:hover,
.bi-select option:focus,
.bi-select option:checked {
  background: #667eea !important;
  color: white !important;
}

/* The rest of the styles are loaded from modular CSS files */
</style>

</head>
<body>
  <!-- Toggle Button (outside sidebar for visibility) -->
  <div class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" role="button" aria-label="Alternar menu lateral" tabindex="0" onkeypress="if(event.key==='Enter')toggleSidebar()">
    <span id="toggleIcon" aria-hidden="true">‚Äπ</span>
  </div>
  
  <!-- Sidebar Premium -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="tryvia.png" alt="Tryvia" onerror="this.outerHTML='<div style=\'font-size:2rem;color:#8b5cf6;font-weight:700;\'>‚ó≠</div>'">
      </div>
    </div>
    <div class="sidebar-content">
      <div class="sidebar-section">
        <div class="sidebar-section-title">Menu Principal</div>
        <div class="sidebar-item active" onclick="showTickets()" data-tooltip="Tickets">
          <span class="sidebar-item-icon">üé´</span>
          <span>Tickets</span>
        </div>
        <div class="sidebar-item" onclick="showBIAnalytics()" data-tooltip="BI Analytics">
          <span class="sidebar-item-icon">üìä</span>
          <span>BI Analytics</span>
        </div>
        <div class="sidebar-item" onclick="showPresentationSetup()" data-tooltip="Apresenta√ß√£o">
          <span class="sidebar-item-icon">üé¨</span>
          <span>Apresenta√ß√£o</span>
        </div>
        <div class="sidebar-item" onclick="showInsights()" data-tooltip="Insights">
          <span class="sidebar-item-icon">üí°</span>
          <span>Insights</span>
        </div>
        <div class="sidebar-item" onclick="showReports()" data-tooltip="Relat√≥rios">
          <span class="sidebar-item-icon">üìã</span>
          <span>Relat√≥rios</span>
        </div>
        <div class="sidebar-item" onclick="showGlossary()" data-tooltip="Gloss√°rio">
          <span class="sidebar-item-icon">üìñ</span>
          <span>Gloss√°rio</span>
        </div>
        <div class="sidebar-item" id="sidebarAnnotationsBtn" onclick="window.annotationsModule?.openPanel()" data-tooltip="Anota√ß√µes">
          <span class="sidebar-item-icon">üìù</span>
          <span>Anota√ß√µes</span>
          <span class="sidebar-badge" id="sidebarAnnotationsBadge" style="display:none">0</span>
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-section-title">Configura√ß√µes</div>
        <div class="sidebar-item" onclick="showThemes()" data-tooltip="Temas">
          <span class="sidebar-item-icon">üé®</span>
          <span>Temas</span>
        </div>
        <div class="sidebar-item" onclick="showPreferences()" data-tooltip="Prefer√™ncias">
          <span class="sidebar-item-icon">‚öôÔ∏è</span>
          <span>Prefer√™ncias</span>
        </div>
      </div>
    </div>
    <div style="padding:1rem;">
      <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none;" />
    </div>
  </aside>

  <!-- Main Wrapper -->
  <div class="main-wrapper">
    <!-- Top Bar -->
    <header class="topbar">
      <div class="topbar-title">An√°lise de Tickets por Time</div>
      <div class="topbar-controls" style="display:flex;align-items:center;gap:1rem;">
        <button onclick="GlobalSearch && GlobalSearch.open()" title="Busca Global (Ctrl+K)" style="
          background: rgba(59,130,246,0.1);
          border: 1px solid rgba(59,130,246,0.3);
          color: #a1a1aa;
          padding: 0.5rem 1rem;
          border-radius: 8px;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-size: 0.85rem;
          transition: all 0.15s;
        " onmouseover="this.style.background='rgba(59,130,246,0.2)';this.style.color='#e4e4e7';" onmouseout="this.style.background='rgba(59,130,246,0.1)';this.style.color='#a1a1aa';">
          Buscar <kbd style="background:#27272a;padding:0.15rem 0.4rem;border-radius:4px;font-size:0.7rem;margin-left:0.5rem;">Ctrl+K</kbd>
        </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
    <div class="grid">
      <div class="card">
        <h3 id="teamName">‚Äî</h3>
        <div class="kpis">
          <div class="kpi">
            <div class="label">Total de Tickets</div>
            <div class="value" id="kpiTotal">-</div>
          </div>
          <div class="kpi">
            <div class="label">SLA 1¬™ Resposta (h) ‚Äî m√©dia</div>
            <div class="value" id="kpiFirst">-</div>
          </div>
          <div class="kpi">
            <div class="label">SLA Resolu√ß√£o (h) ‚Äî m√©dia</div>
            <div class="value" id="kpiResol">-</div>
          </div>
          <div class="kpi">
            <div class="label">% Resolvido ‚â§ 24h</div>
            <div class="value" id="kpiSLA24">-</div>
          </div>
          <div class="kpi">
            <div class="label">Tickets Fechados</div>
            <div class="value" id="kpiClosed">-</div>
          </div>
          <div class="kpi">
            <div class="label">Tempo M√©dio 1¬™ Resposta</div>
            <div class="value" id="kpiFirstTime">-</div>
          </div>
        </div>
      </div>

      <div class="card span6">
        <h3 class="icon-users">Pessoas do Time (Top 10)</h3>
        <table id="tbTopTratativa">
          <thead><tr><th>Pessoa (Tratativa)</th><th>Tickets Resolvidos</th></tr></thead>
          <tbody id="tbodyTopTratativa"></tbody>
        </table>
      </div>

      <div class="card span6">
        <h3 class="icon-types">Tickets por Tipo Prim√°rio</h3>
        <table>
          <thead><tr><th>Tipo</th><th>Qtd</th></tr></thead>
          <tbody id="tbodyTipo"></tbody>
        </table>
      </div>

      <div class="card span6">
        <h3 class="icon-priority">Prioridade DEV</h3>
        <table>
          <thead><tr><th>Prioridade</th><th>Qtd</th></tr></thead>
          <tbody id="tbodyDev"></tbody>
        </table>
      </div>

      <div class="card span6">
        <h3 class="icon-timeline">Timeline ‚Äî Criados por M√™s</h3>
        <table>
          <thead><tr><th>M√™s</th><th>Qtd</th></tr></thead>
          <tbody id="tbodyTimeline">
            <tr><td colspan="2">Nenhum registro encontrado.</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Container de Insights Autom√°ticos -->
      <div class="card" style="grid-column: span 12;">
        <h3 style="display: flex; align-items: center; gap: 0.5rem;">
          <span>üí°</span> Insights Autom√°ticos
        </h3>
        <div id="insights" style="
          margin-top: 20px;
          font-size: 16px;
          line-height: 1.8;
          padding: 1.5rem;
          background: var(--bg-secondary);
          border-radius: 8px;
          color: var(--text-primary);
          max-height: 500px;
          overflow-y: auto;
        ">
          <div style="color: var(--text-muted); text-align: center;">
            Carregue um arquivo Excel para ver insights autom√°ticos dos dados.
          </div>
        </div>
      </div>

    </div>
    
    <div class="footer">Arquivo gerado automaticamente ‚Äî Dashboard interativo para an√°lise de tickets por time</div>
    </main>

    <!-- Presentation Mode Container -->
  <section id="presentation-container" style="display: none; position: relative; z-index: 100; background: #0a0a1a; min-height: 100vh;">
    <!-- Conte√∫do ser√° renderizado pelo presentation-mode-v2.js -->
  </section>
  
  <!-- Reports Section V2 (Premium) -->
  <section id="reports-container" style="display: none; position: relative; z-index: 100; background: #0a0a1a; min-height: 100vh;">
    <!-- Conte√∫do gerado pelo ReportsModuleV2 -->
  </section>
  
  <!-- Reports Section Legacy (mantido para compatibilidade) -->
  <section id="reportsSetup" style="display: none; padding: 2rem;">
    <div class="reports-header">
      <h2 style="color: var(--primary); font-size: 1.8rem; margin-bottom: 1rem;">üìë Gerador de Relat√≥rios</h2>
      <p style="color: #a1a1aa; margin-bottom: 2rem;">Configure filtros e selecione os dados para gerar relat√≥rios personalizados</p>
    </div>
    
    <!-- Filters Section -->
    <div class="report-filters" style="background: #27272a; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
      <h3 style="color: #e4e4e7; font-size: 1.2rem; margin-bottom: 1rem;">üîç Filtros do Relat√≥rio</h3>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <!-- Date Range Filter -->
        <div>
          <label style="color: #a1a1aa; font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Per√≠odo</label>
          <select id="reportDateRange" class="bi-select" style="width: 100%; background: #18181b; color: #e4e4e7; border: 1px solid #3f3f46;">
            <option value="all">Todo o per√≠odo</option>
            <option value="today">Hoje</option>
            <option value="week">√öltima semana</option>
            <option value="month" selected>√öltimo m√™s</option>
            <option value="quarter">√öltimo trimestre</option>
            <option value="year">√öltimo ano</option>
            <option value="custom">Personalizado</option>
          </select>
        </div>
        
        <!-- Team Filter -->
        <div>
          <label style="color: #a1a1aa; font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Time</label>
          <select id="reportTeam" class="bi-select" style="width: 100%; background: #18181b; color: #e4e4e7; border: 1px solid #3f3f46;">
            <option value="all">Todos os times</option>
          </select>
        </div>
        
        <!-- Type Filter -->
        <div>
          <label style="color: #a1a1aa; font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Tipo</label>
          <select id="reportType" class="bi-select" style="width: 100%; background: #18181b; color: #e4e4e7; border: 1px solid #3f3f46;">
            <option value="all">Todos os tipos</option>
            <option value="bug">Bug</option>
            <option value="feature">Feature</option>
            <option value="support">Suporte</option>
          </select>
        </div>
        
        <!-- Priority Filter -->
        <div>
          <label style="color: #a1a1aa; font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Prioridade</label>
          <select id="reportPriority" class="bi-select" style="width: 100%; background: #18181b; color: #e4e4e7; border: 1px solid #3f3f46;">
            <option value="all">Todas as prioridades</option>
            <option value="critical">Cr√≠tica</option>
            <option value="high">Alta</option>
            <option value="medium">M√©dia</option>
            <option value="low">Baixa</option>
          </select>
        </div>
        
        <!-- SLA Filter -->
        <div>
          <label style="color: #a1a1aa; font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Status SLA</label>
          <select id="reportSLA" class="bi-select" style="width: 100%; background: #18181b; color: #e4e4e7; border: 1px solid #3f3f46;">
            <option value="all">Todos</option>
            <option value="ok">Dentro do SLA</option>
            <option value="nok">Fora do SLA</option>
          </select>
        </div>
        
        <!-- Status Filter -->
        <div>
          <label style="color: #a1a1aa; font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Status</label>
          <select id="reportStatus" class="bi-select" style="width: 100%; background: #18181b; color: #e4e4e7; border: 1px solid #3f3f46;">
            <option value="all">Todos</option>
            <option value="open">Aberto</option>
            <option value="closed">Fechado</option>
            <option value="pending">Pendente</option>
          </select>
        </div>
      </div>
      
      <!-- Custom Date Range (hidden by default) -->
      <div id="customDateRange" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #3f3f46;">
        <label style="color: #a1a1aa; font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">üìÖ Per√≠odo Personalizado</label>
        <div id="reportDateContainer" style="display: flex; gap: 1rem; align-items: center;">
          <div style="flex: 1;">
            <input type="date" id="reportStartDate" style="width: 100%; padding: 0.5rem; background: #18181b; color: #e4e4e7; border: 1px solid #3f3f46; border-radius: 6px;">
          </div>
          <div style="flex: 1;">
            <input type="date" id="reportEndDate" style="width: 100%; padding: 0.5rem; background: #18181b; color: #e4e4e7; border: 1px solid #3f3f46; border-radius: 6px;">
          </div>
        </div>
      </div>
    </div>
    
    <!-- Components Selection -->
    <div class="report-components" style="background: #27272a; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
      <h3 style="color: #e4e4e7; font-size: 1.2rem; margin-bottom: 1rem;">üìä Componentes do Relat√≥rio</h3>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="summary" checked style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üìã Resumo Executivo</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="kpis" checked style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üéØ KPIs Principais</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="charts" checked style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üìà Gr√°ficos de An√°lise</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="tables" checked style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üìä Tabelas Detalhadas</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="sla" checked style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">‚è±Ô∏è An√°lise de SLA</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="timeline" checked style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üìÖ Timeline Temporal</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="ranking" style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üèÜ Rankings (Top 10)</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="distribution" style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üìä Distribui√ß√µes</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="insights" checked style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üí° Insights e Recomenda√ß√µes</span>
        </label>
        
        <!-- Novos Componentes Enriquecidos -->
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="trends" checked style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üìä An√°lise de Tend√™ncias</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="comparison" style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üìà Compara√ß√£o Temporal</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="heatmap" style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üî• Mapa de Calor</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="efficiency" checked style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üë• Efici√™ncia da Equipe</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="recurrence" style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üîÑ An√°lise de Reincid√™ncia</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="complexity" style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üß© Complexidade de Tickets</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="quality" checked style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">‚≠ê Score de Qualidade</span>
        </label>
        
        <label style="display: flex; align-items: center; cursor: pointer; padding: 0.5rem; background: #18181b; border-radius: 8px; border: 1px solid #3f3f46;">
          <input type="checkbox" class="report-component" data-component="prioritization" style="margin-right: 0.5rem;">
          <span style="color: #e4e4e7;">üéØ Matriz de Prioriza√ß√£o</span>
        </label>
      </div>
    </div>
    
    <!-- Report Actions -->
    <div class="report-actions" style="display: flex; gap: 1rem; margin-bottom: 2rem;">
      <button onclick="previewReport()" class="bi-select" style="background: var(--gradient); color: white; border: none;">üëÅÔ∏è Visualizar Relat√≥rio</button>
      <button onclick="exportReportPDF()" class="bi-select" style="background: #ef4444; color: white; border: none;">üìÑ Exportar PDF</button>
      <button onclick="exportReportExcel()" class="bi-select" style="background: #10b981; color: white; border: none;">üìä Exportar Excel</button>
      <button onclick="resetReportFilters()" class="bi-select" style="background: #52525b; color: white; border: none; margin-left: auto;">üîÑ Limpar Filtros</button>
    </div>
    
    <!-- Report Preview -->
    <div id="reportPreview" style="background: linear-gradient(135deg, rgba(20, 20, 20, 0.98), rgba(15, 15, 15, 0.99)); border-radius: 12px; padding: 2rem; min-height: 500px; display: none; border: 1px solid rgba(255, 255, 255, 0.1); color: #e4e4e7;">
      <!-- Report content will be generated here -->
    </div>
  </section>
  
  <!-- Tickets Section -->
  <section id="ticketsContainer" style="display: none; padding: 2rem;">
    <div class="tickets-header" style="margin-bottom: 2rem;">
      <h2 style="color: var(--primary); font-size: 1.8rem; margin-bottom: 1rem;">An√°lise de Tickets por Time</h2>
      <p style="color: #a1a1aa; margin-bottom: 2rem;">Visualize e gerencie tickets diretamente do Freshdesk</p>
      <div style="display:flex; justify-content:flex-end;">
        <span id="lastImportedBadge" style="color:#a1a1aa; font-size: .9rem; background: rgba(99,102,241,0.12); border:1px solid rgba(99,102,241,0.3); padding:.25rem .5rem; border-radius:6px;">
          √öltima importa√ß√£o: ‚Äî
        </span>
      </div>
    </div>
    
    <!-- Bot√£o Toggle Filtros -->
    <div style="display: flex; justify-content: flex-end; margin-bottom: 0.5rem;">
      <button id="toggleFiltersBtn" onclick="toggleTicketFilters()" style="
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.3);
        color: #a1a1aa;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        transition: all 0.2s;
      " onmouseover="this.style.background='rgba(99, 102, 241, 0.2)';this.style.color='#e4e4e7';" 
         onmouseout="this.style.background='rgba(99, 102, 241, 0.1)';this.style.color='#a1a1aa';">
        <span id="toggleFiltersIcon">‚ñº</span> Filtros
      </button>
    </div>
    
    <div id="ticketFiltersContainer" class="tickets-controls" style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; transition: all 0.3s ease;">
      <select id="ticketPeriodFilter" class="bi-select" style="flex: 1; min-width: 200px;">
        <option value="7">√öltimos 7 dias</option>
        <option value="30" selected>√öltimos 30 dias</option>
        <option value="90">√öltimos 3 meses</option>
        <option value="180">√öltimos 6 meses</option>
        <option value="365">√öltimo ano</option>
        <option value="all">Todos os tickets</option>
      </select>
      
      <select id="ticketStatusFilter" class="bi-select" style="flex: 1; min-width: 200px;">
        <option value="all">Todos os Status</option>
        <optgroup label="Status Padr√£o">
          <option value="2">Aberto</option>
          <option value="3">Pendente</option>
          <option value="4">Resolvido</option>
          <option value="5">Fechado</option>
        </optgroup>
        <optgroup label="An√°lise/Tratativa">
          <option value="10">Em An√°lise</option>
          <option value="8">Em Tratativa</option>
          <option value="19">Levantamento de Esfor√ßo</option>
        </optgroup>
        <optgroup label="Aguardando">
          <option value="7">Aguardando Cliente</option>
          <option value="16">Aguardando Parceiros</option>
          <option value="12">Aguardando Publicar HML</option>
          <option value="13">Aguardando Publicar PROD</option>
        </optgroup>
        <optgroup label="Valida√ß√£o">
          <option value="6">Em Homologa√ß√£o</option>
          <option value="15">Valida√ß√£o-Atendimento</option>
          <option value="18">Valida√ß√£o-CS</option>
        </optgroup>
        <optgroup label="Desenvolvimento">
          <option value="20">Em Fila DEV</option>
          <option value="21">Em Produ√ß√£o</option>
          <option value="14">MVP</option>
        </optgroup>
        <optgroup label="Outros">
          <option value="11">Interno</option>
          <option value="17">Pausado</option>
        </optgroup>
      </select>
      
      <select id="ticketPriorityFilter" class="bi-select" style="flex: 1; min-width: 200px;">
        <option value="all">Todas as Prioridades</option>
        <option value="1">Baixa</option>
        <option value="2">M√©dia</option>
        <option value="3">Alta</option>
        <option value="4">Urgente</option>
      </select>
      
      <select id="ticketOrderBy" class="bi-select" style="flex: 1; min-width: 200px;">
        <option value="created_at">Data de Cria√ß√£o</option>
        <option value="updated_at">√öltima Atualiza√ß√£o</option>
        <option value="priority">Prioridade</option>
        <option value="status">Status</option>
      </select>
      
      <select id="ticketTypeFilter" class="bi-select" style="flex: 1; min-width: 200px;">
        <option value="all">Todos os Tipos</option>
      </select>
      
      <select id="ticketSourceFilter" class="bi-select" style="flex: 1; min-width: 200px;">
        <option value="all">Todas as Origens</option>
      </select>
      
      <select id="ticketCompanyFilter" class="bi-select" style="flex: 1; min-width: 200px;">
        <option value="all">Todas as Empresas</option>
      </select>
      
      <select id="ticketGroupFilter" class="bi-select" style="flex: 1; min-width: 200px;">
        <option value="all">Todos os Times</option>
      </select>
      
      <select id="ticketAgentFilter" class="bi-select" style="flex: 1; min-width: 200px;">
        <option value="all">Todos os Agentes</option>
      </select>
      
      <select id="ticketRequesterFilter" class="bi-select" style="flex: 1; min-width: 200px;">
        <option value="all">Todos os Contatos</option>
      </select>
      
      <select id="ticketSlaFilter" class="bi-select" style="flex: 1; min-width: 200px;">
        <option value="all">Todos (SLA)</option>
        <option value="first_ok">1¬™ Resposta OK</option>
        <option value="first_late">1¬™ Resposta Fora</option>
        <option value="res_ok">Resolu√ß√£o OK</option>
        <option value="res_late">Resolu√ß√£o Fora</option>
        <option value="overdue">Vencidos</option>
        <option value="escalated">Escalados</option>
        <option value="reopened">Reabertos</option>
      </select>
      
      <input id="ticketTagFilter" class="bi-select" placeholder="Tag cont√©m..." style="flex: 1; min-width: 200px;" />
    </div>

    <!-- Column visibility controls -->
    <div id="ticketColumnsControls" style="display:flex; flex-wrap:wrap; gap:1rem; margin: -0.5rem 0 1rem;">
      <label style="display:flex; align-items:center; gap:.5rem; color: var(--text-secondary);">
        <input type="checkbox" data-col="description" checked /> Descri√ß√£o
      </label>
      <label style="display:flex; align-items:center; gap:.5rem; color: var(--text-secondary);">
        <input type="checkbox" data-col="sla" checked /> SLA
      </label>
      <label style="display:flex; align-items:center; gap:.5rem; color: var(--text-secondary);">
        <input type="checkbox" data-col="type" checked /> Tipo
      </label>
      <label style="display:flex; align-items:center; gap:.5rem; color: var(--text-secondary);">
        <input type="checkbox" data-col="company" checked /> Empresa
      </label>
      <label style="display:flex; align-items:center; gap:.5rem; color: var(--text-secondary);">
        <input type="checkbox" data-col="group" checked /> Time
      </label>
      <label style="display:flex; align-items:center; gap:.5rem; color: var(--text-secondary);">
        <input type="checkbox" data-col="agent" checked /> Agente
      </label>
      <label style="display:flex; align-items:center; gap:.5rem; color: var(--text-secondary);">
        <input type="checkbox" data-col="sla-deadlines" checked /> Prazos SLA
      </label>
      <label style="display:flex; align-items:center; gap:.5rem; color: var(--text-secondary);">
        <input type="checkbox" data-col="closure" checked /> Fechamento/Resolu√ß√£o
      </label>
    </div>
    
    <!-- Loading Progress -->
    <div id="loadingProgress" style="display: none; background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
      <div style="display: flex; align-items: center; gap: 1rem;">
        <span style="color: var(--text-secondary);">Carregando tickets...</span>
        <span id="progressText" style="color: var(--primary); font-weight: bold;">0 / 0</span>
        <div style="flex: 1; background: var(--border); border-radius: 4px; height: 8px; overflow: hidden;">
          <div id="progressBar" style="width: 0%; height: 100%; background: var(--gradient); transition: width 0.3s;"></div>
        </div>
      </div>
    </div>
    
    <!-- Tickets Stats - Row 1: Principal -->
    <div class="tickets-stats-row1" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
      <div class="stat-card" style="background: linear-gradient(135deg, #1e1e2e 0%, #252536 100%); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
          <span style="color: #a1a1aa; font-size: 0.8rem;">Total de Tickets</span>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="9" x2="15" y2="9"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="12" y2="17"/></svg>
        </div>
        <div id="totalTicketsCount" style="font-size: 2.25rem; font-weight: bold; color: #f4f4f5; letter-spacing: -1px;">0</div>
      </div>
      
      <div class="stat-card" style="background: linear-gradient(135deg, #1e1e2e 0%, #252536 100%); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
          <span style="color: #a1a1aa; font-size: 0.8rem;">Tickets Abertos</span>
          <div style="width: 12px; height: 12px; border-radius: 50%; background: #3b82f6;"></div>
        </div>
        <div id="openTicketsCount" style="font-size: 2.25rem; font-weight: bold; color: #f4f4f5; letter-spacing: -1px;">0</div>
      </div>
      
      <div class="stat-card" style="background: linear-gradient(135deg, #1e1e2e 0%, #252536 100%); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.3);">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
          <span style="color: #a1a1aa; font-size: 0.8rem;">Tickets Pendentes</span>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
        </div>
        <div id="pendingTicketsCount" style="font-size: 2.25rem; font-weight: bold; color: #f4f4f5; letter-spacing: -1px;">0</div>
      </div>
      
      <div class="stat-card" style="background: linear-gradient(135deg, #1e1e2e 0%, #252536 100%); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3);">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
          <span style="color: #a1a1aa; font-size: 0.8rem;">Tickets Resolvidos</span>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <div id="resolvedTicketsCount" style="font-size: 2.25rem; font-weight: bold; color: #10b981; letter-spacing: -1px;">0</div>
      </div>
    </div>

    <!-- Tickets Stats - Row 2: SLA (2 cards maiores) -->
    <div class="tickets-stats-row2" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
      <div class="stat-card sla-card" style="background: linear-gradient(135deg, #1e1e2e 0%, #1a1a2e 100%); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(96, 165, 250, 0.2); display: flex; align-items: center; gap: 2rem;">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            <span style="color: #a1a1aa; font-size: 0.85rem;">SLA 1a Resposta</span>
            <span style="color: #52525b; font-size: 0.75rem;">(Dentro)</span>
          </div>
        </div>
        <div id="kpiSlaFirstPct" style="font-size: 2.5rem; font-weight: bold; color: #f4f4f5; min-width: 100px; text-align: right;">0%</div>
      </div>

      <div class="stat-card sla-card" style="background: linear-gradient(135deg, #1e1e2e 0%, #1a1a2e 100%); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.2); display: flex; align-items: center; gap: 2rem;">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12l2 2 4-4"/></svg>
            <span style="color: #a1a1aa; font-size: 0.85rem;">SLA 1a Resolucao</span>
            <span style="color: #52525b; font-size: 0.75rem;">(Dentro)</span>
          </div>
        </div>
        <div id="kpiSlaResPct" style="font-size: 2.5rem; font-weight: bold; color: #f4f4f5; min-width: 100px; text-align: right;">0%</div>
      </div>
    </div>

    <!-- Tickets Stats - Row 3: Alertas (3 cards com gradiente) -->
    <div class="tickets-stats-row3" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
      <div class="stat-card alert-card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(185, 28, 28, 0.25) 100%); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3); position: relative; overflow: hidden;">
        <div style="position: absolute; top: 0; right: 0; width: 80px; height: 80px; background: radial-gradient(circle at top right, rgba(239, 68, 68, 0.3), transparent 70%);"></div>
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          <span style="color: #fca5a5; font-size: 0.85rem; font-weight: 500;">Escalados</span>
        </div>
        <div style="display: flex; align-items: baseline; gap: 0.75rem;">
          <div id="kpiEscalatedCount" style="font-size: 2.25rem; font-weight: bold; color: #f4f4f5;">0</div>
          <span id="kpiEscalatedPct" style="color: #ef4444; font-size: 0.9rem; font-weight: 500;">0%</span>
        </div>
      </div>

      <div class="stat-card alert-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(180, 83, 9, 0.25) 100%); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.3); position: relative; overflow: hidden;">
        <div style="position: absolute; top: 0; right: 0; width: 80px; height: 80px; background: radial-gradient(circle at top right, rgba(245, 158, 11, 0.3), transparent 70%);"></div>
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          <span style="color: #fcd34d; font-size: 0.85rem; font-weight: 500;">Reabertos</span>
        </div>
        <div style="display: flex; align-items: baseline; gap: 0.75rem;">
          <div id="kpiReopenedCount" style="font-size: 2.25rem; font-weight: bold; color: #f4f4f5;">0</div>
          <span id="kpiReopenedPct" style="color: #f59e0b; font-size: 0.9rem; font-weight: 500;">0%</span>
        </div>
      </div>

      <div class="stat-card alert-card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(127, 29, 29, 0.25) 100%); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3); position: relative; overflow: hidden;">
        <div style="position: absolute; top: 0; right: 0; width: 80px; height: 80px; background: radial-gradient(circle at top right, rgba(239, 68, 68, 0.3), transparent 70%);"></div>
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/><line x1="4" y1="4" x2="20" y2="20" stroke-width="2.5"/></svg>
          <span style="color: #fca5a5; font-size: 0.85rem; font-weight: 500;">Vencidos</span>
        </div>
        <div style="display: flex; align-items: baseline; gap: 0.75rem;">
          <div id="kpiOverdueCount" style="font-size: 2.25rem; font-weight: bold; color: #f4f4f5;">0</div>
          <span id="kpiOverduePct" style="color: #ef4444; font-size: 0.9rem; font-weight: 500;">0%</span>
        </div>
      </div>
    </div>
    
    <!-- Loading indicator -->
    <div id="ticketsLoading" style="display: none; text-align: center; padding: 3rem;">
      <div class="spinner" style="display: inline-block; width: 50px; height: 50px; border: 5px solid var(--border); border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <p style="margin-top: 1rem; color: var(--text-secondary);">Carregando tickets...</p>
    </div>
    
    <!-- Tickets Table -->
    <div id="ticketsTableContainer" style="background: linear-gradient(135deg, #1e1e2e 0%, #252536 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(63,63,90,0.5);">
      <h3 style="color: #f4f4f5; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.75rem; font-size: 1.1rem; font-weight: 600;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
        Lista de Tickets
      </h3>
      <div style="overflow-x: auto; border-radius: 8px; border: 1px solid rgba(63,63,90,0.3);">
        <table id="ticketsTable" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(139,92,246,0.1) 100%); border-bottom: 1px solid rgba(63,63,90,0.5);">
              <th style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; width: 50px;">#</th>
              <th style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">ID</th>
              <th style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Assunto</th>
              <th class="col-description" style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Descri√ß√£o</th>
              <th style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Status</th>
              <th style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Prioridade</th>
              <th style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Criado em</th>
              <th style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">√öltima Atualiza√ß√£o</th>
              <th class="col-sla" style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">SLA</th>
              <th class="col-type" style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Tipo</th>
              <th class="col-company" style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Empresa</th>
              <th class="col-group" style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Time</th>
              <th class="col-agent" style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Agente</th>
              <th class="col-sla-deadlines" style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">1¬™ resp. at√©</th>
              <th class="col-sla-deadlines" style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Resolu√ß√£o at√©</th>
              <th class="col-closure" style="padding: 0.875rem 0.75rem; text-align: left; color: #a1a1aa; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Fechado/Resolvido em</th>
            </tr>
          </thead>
          <tbody id="ticketsTableBody">
            <tr>
              <td colspan="16" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                Nenhum ticket carregado. Clique em "Carregar Tickets" para come√ßar.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
  
  <!-- Analytics Section -->
  <section id="analyticsContainer" style="display: none; padding: 2rem;">
    <div class="analytics-header" style="margin-bottom: 2rem;">
      <h2 style="color: var(--primary); font-size: 1.8rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        Analytics - Visualiza√ß√£o de Dados
      </h2>
      <p style="color: #a1a1aa; margin-bottom: 2rem;">An√°lise visual dos tickets carregados</p>
      
      <!-- Filtro de Time -->
      <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 2rem; flex-wrap: wrap;">
        <label style="color: var(--text-primary); font-weight: 600;">Selecione o Time:</label>
        <select id="analyticsTeamFilter" onchange="updateAnalytics()" 
                style="padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border); 
                       border-radius: 8px; color: var(--text-primary); font-size: 0.875rem; min-width: 250px;">
          <option value="all">Todos os Times</option>
        </select>
        <button onclick="refreshAnalytics()" 
                style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #60a5fa, #a78bfa); 
                       color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
          Atualizar Dados
        </button>
      </div>
    </div>
    
    <!-- KPIs Cards -->
    <div id="analyticsKPIs" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                                    gap: 1rem; margin-bottom: 2rem;">
      <!-- KPIs ser√£o inseridos aqui -->
    </div>
    
    <!-- Gr√°ficos -->
    <div id="analyticsCharts" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); 
                                      gap: 1.5rem;">
      <!-- Gr√°ficos ser√£o inseridos aqui -->
    </div>
  </section>
  
  <!-- Legacy BI Tratativa sections removed (Pessoa/Time) - unified BI Analytics in use -->
  
  <!-- Presentation Mode Overlay -->
  <div id="presentationMode" style="position: fixed; inset: 0; background: #000; display: none; z-index: 10000;">
    <div id="slideContainer" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
      <!-- Active slide will be shown here -->
    </div>
    
    <div class="presentation-controls-overlay" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 1rem; opacity: 0.8; transition: opacity 0.3s;">
      <button onclick="prevSlide()" class="pres-btn" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">‚è¥ Anterior</button>
      <button onclick="exitPresentation()" class="pres-btn" style="background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">‚èπ Sair</button>
      <button onclick="nextSlide()" class="pres-btn" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">Pr√≥ximo ‚èµ</button>
    </div>
    
    <div class="slide-counter" style="position: fixed; top: 20px; right: 20px; color: rgba(255,255,255,0.5); font-size: 1.2rem;">
      <span id="currentSlideNum">1</span> / <span id="totalSlideNum">1</span>
    </div>
  </div>
  
  <!-- BI Charts Container -->
    <div class="bi-container" id="biContainer">
      <!-- O conte√∫do ser√° criado dinamicamente pelo m√≥dulo bi-charts-interface.js -->
    </div>
  
  
  <!-- Preferences Modal -->
  <div class="modal-overlay" id="preferencesOverlay" onclick="closePreferencesModal()"></div>
  <div class="file-upload-modal" id="preferencesModal">
    <div class="modal-header">
      <h2 class="modal-title">‚öôÔ∏è Prefer√™ncias</h2>
      <div class="modal-close" onclick="closePreferencesModal()">‚úï</div>
    </div>
    <div style="padding: 1rem 0;">
      <h3 style="color: var(--text-primary); margin-bottom: 1rem;">‚öôÔ∏è Configura√ß√µes de Tickets</h3>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="autoLoadTickets" 
                 style="width: 20px; height: 20px; cursor: pointer;"
                 onchange="localStorage.setItem('autoLoadTickets', this.checked)">
          <span style="color: var(--text-primary);">
            Carregar tickets automaticamente ao iniciar
          </span>
        </label>
      </div>
      
      <h3 style="color: var(--text-primary); margin-bottom: 1rem;">üîå Configura√ß√£o API Freshdesk</h3>
      <div style="display: flex; flex-direction: column; gap: 1rem;">
        <div>
          <label style="color: var(--text-secondary); font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Dom√≠nio Freshdesk:</label>
          <input type="text" id="freshdeskDomain" placeholder="Ex: https://suportetryvia.freshdesk.com" 
                 style="width: 100%; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border); 
                        border-radius: 8px; color: var(--text-primary); font-size: 0.875rem;"
                 value="https://suportetryvia.freshdesk.com" />
        </div>
        <div>
          <label style="color: var(--text-secondary); font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">API Key:</label>
          <input type="password" id="freshdeskApiKey" placeholder="Digite sua API Key" 
                 style="width: 100%; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border); 
                        border-radius: 8px; color: var(--text-primary); font-size: 0.875rem;"
                 value="s9GQtphoZqeRNz7Enl" 
                 autocomplete="current-password" />
        </div>
        <button onclick="saveFreshdeskConfig()" 
                style="padding: 0.75rem 1.5rem; background: var(--gradient); border: none; 
                       border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
          üíæ Salvar Configura√ß√£o
        </button>
      </div>
    </div>
  </div>

  <!-- Themes Modal -->
  <div class="modal-overlay" id="themesOverlay" onclick="closeThemesModal()"></div>
  <div class="file-upload-modal" id="themesModal" style="max-width: 500px;">
    <div class="modal-header">
      <h2 class="modal-title">üé® Temas</h2>
      <div class="modal-close" onclick="closeThemesModal()">‚úï</div>
    </div>
    <div style="padding: 1rem 0;">
      <!-- Temas de Cores -->
      <h3 style="color: var(--text-primary); margin-bottom: 0.75rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">üé≠ Tema de Cores</h3>
      <div style="display: grid; gap: 0.75rem; margin-bottom: 1.5rem;">
        <div class="theme-option" onclick="applyTheme('dark')" style="padding: 1rem; background: var(--bg-secondary); border: 2px solid var(--accent-purple); border-radius: 8px; cursor: pointer;">
          <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">üåô Dark (Atual)</h4>
          <p style="color: var(--text-secondary); font-size: 0.875rem;">Tema escuro elegante com tons de roxo e azul</p>
        </div>
        <div class="theme-option" onclick="applyTheme('light')" style="padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; opacity: 0.7;">
          <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">‚òÄÔ∏è Light</h4>
          <p style="color: var(--text-secondary); font-size: 0.875rem;">Tema claro (Em desenvolvimento)</p>
        </div>
      </div>
      
      <!-- Efeitos Personalizados -->
      <h3 style="color: var(--text-primary); margin-bottom: 0.75rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">üå∏ Efeitos Personalizados</h3>
      <div style="display: grid; gap: 0.75rem;">
        <!-- Click Personalizado -->
        <div style="padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h4 style="color: var(--text-primary); margin-bottom: 0.25rem;">üå∏ Click Personalizado</h4>
              <p style="color: var(--text-secondary); font-size: 0.75rem;">P√©talas de sakura ao clicar</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="toggleClickEffect" onchange="toggleSakuraClickEffect(this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        
        <!-- Rastro Personalizado -->
        <div style="padding: 1rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h4 style="color: var(--text-primary); margin-bottom: 0.25rem;">‚ú® Rastro Personalizado</h4>
              <p style="color: var(--text-secondary); font-size: 0.75rem;">P√©talas seguem o cursor</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="toggleTrailEffect" onchange="toggleSakuraTrailEffect(this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- Preview -->
      <div id="sakuraPreview" style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 8px; height: 100px; position: relative; overflow: hidden; display: none;">
        <p style="color: var(--text-secondary); font-size: 0.75rem; text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">Mova o mouse aqui para preview ‚ú®</p>
      </div>
    </div>
  </div>
  
  <!-- Container para efeitos Sakura -->
  <div id="sakuraContainer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden;"></div>
  
  <!-- CSS para Toggle Switch e Sakura -->
  <style>
    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
      flex-shrink: 0;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #3a3a4a;
      transition: 0.3s;
      border-radius: 26px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    .toggle-switch input:checked + .toggle-slider {
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    
    /* Sakura Petal */
    .sakura-petal {
      position: absolute;
      pointer-events: none;
      z-index: 9999;
    }
    .sakura-petal svg {
      filter: drop-shadow(0 2px 4px rgba(255, 182, 193, 0.3));
    }
    
    @keyframes sakura-fall {
      0% {
        opacity: 1;
        transform: translateY(0) rotate(0deg) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateY(100px) rotate(360deg) scale(0.3);
      }
    }
    
    @keyframes sakura-float {
      0%, 100% {
        transform: translateX(0) rotate(0deg);
      }
      25% {
        transform: translateX(10px) rotate(90deg);
      }
      50% {
        transform: translateX(-5px) rotate(180deg);
      }
      75% {
        transform: translateX(8px) rotate(270deg);
      }
    }
    
    @keyframes sakura-trail {
      0% {
        opacity: 0.8;
        transform: scale(1) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: scale(0.2) rotate(180deg) translateY(30px);
      }
    }
  </style>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Processando arquivo...</p>
    </div>
  </div>

<script>
// ============================================
// CORE DATA - Movido para js/core-data.js
// DATA, FD_LOOKUPS, resolvers, buildDATAFromTickets, updateGlobalDATAFromTickets
// ============================================

// Refer√™ncia local para compatibilidade com c√≥digo legado
let DATA = window.DATA;

// Sidebar functions - toggleSidebar est√° em js/navigation-functions.js

// Utility: Update Sidebar Active State
function updateSidebarActive(functionName) {
  document.querySelectorAll('.sidebar-item').forEach(item => {
    item.classList.remove('active');
    if (item.getAttribute('onclick')?.includes(functionName)) {
      item.classList.add('active');
    }
  });
}

// Preferences Modal Functions
function showPreferences() {
  document.getElementById('preferencesOverlay').classList.add('active');
  document.getElementById('preferencesModal').classList.add('active');
}

function closePreferencesModal() {
  document.getElementById('preferencesOverlay').classList.remove('active');
  document.getElementById('preferencesModal').classList.remove('active');
}

// Themes Modal Functions
function showThemes() {
  document.getElementById('themesOverlay').classList.add('active');
  document.getElementById('themesModal').classList.add('active');
}

function closeThemesModal() {
  document.getElementById('themesOverlay').classList.remove('active');
  document.getElementById('themesModal').classList.remove('active');
}

function applyTheme(themeName) {
  if (themeName === 'dark') {
    // Tema j√° est√° aplicado
    alert('Tema Dark j√° est√° ativo!');
  } else {
    alert('Tema Light em desenvolvimento...');
  }
}

// ============================================
// üîî SISTEMA DE TOAST NOTIFICATIONS
// ============================================

function showToast(message, type = 'info') {
  // Remover toast anterior se existir
  const existingToast = document.querySelector('.sakura-toast');
  if (existingToast) existingToast.remove();
  
  const toast = document.createElement('div');
  toast.className = 'sakura-toast';
  
  const colors = {
    success: 'linear-gradient(135deg, #10b981, #34d399)',
    error: 'linear-gradient(135deg, #ef4444, #f87171)',
    info: 'linear-gradient(135deg, #3b82f6, #60a5fa)',
    warning: 'linear-gradient(135deg, #f59e0b, #fbbf24)'
  };
  
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 24px;
    background: ${colors[type] || colors.info};
    color: white;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: toast-slide-in 0.3s ease-out;
  `;
  
  toast.textContent = message;
  document.body.appendChild(toast);
  
  // Adicionar anima√ß√£o CSS se n√£o existir
  if (!document.getElementById('toast-styles')) {
    const style = document.createElement('style');
    style.id = 'toast-styles';
    style.textContent = `
      @keyframes toast-slide-in {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes toast-slide-out {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  }
  
  // Remover ap√≥s 3 segundos
  setTimeout(() => {
    toast.style.animation = 'toast-slide-out 0.3s ease-in forwards';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ============================================
// üå∏ SISTEMA DE EFEITOS SAKURA
// ============================================

// Estado dos efeitos
window.sakuraEffects = {
  clickEnabled: false,
  trailEnabled: false,
  trailThrottle: null,
  lastTrailTime: 0
};

// Cores das p√©talas de sakura
const sakuraColors = [
  '#FFB7C5', // Rosa claro
  '#FF9EAA', // Rosa m√©dio
  '#FFDDE1', // Rosa bem claro
  '#FFC0CB', // Pink
  '#FFE4E9', // Rosa p√°lido
  '#FF69B4', // Hot pink (raro)
];

// Criar SVG de p√©tala de sakura
function createSakuraPetalSVG(size = 20, color = '#FFB7C5') {
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('width', size);
  svg.setAttribute('height', size);
  svg.setAttribute('viewBox', '0 0 24 24');
  svg.innerHTML = `
    <defs>
      <radialGradient id="petalGrad${Math.random()}" cx="30%" cy="30%">
        <stop offset="0%" stop-color="#fff" stop-opacity="0.8"/>
        <stop offset="100%" stop-color="${color}" stop-opacity="1"/>
      </radialGradient>
    </defs>
    <path d="M12 2C12 2 8 6 8 10C8 12 10 14 12 14C14 14 16 12 16 10C16 6 12 2 12 2Z" 
          fill="url(#petalGrad${Math.random().toString().slice(2)})" 
          style="fill: ${color};"
          transform="rotate(${Math.random() * 360} 12 12)"/>
    <ellipse cx="12" cy="10" rx="3" ry="5" fill="${color}" opacity="0.6"/>
  `;
  return svg;
}

// Criar p√©tala de sakura como elemento
function createSakuraPetal(x, y, options = {}) {
  const container = document.getElementById('sakuraContainer');
  if (!container) return;
  
  const petal = document.createElement('div');
  petal.className = 'sakura-petal';
  
  const size = options.size || (12 + Math.random() * 16);
  const color = sakuraColors[Math.floor(Math.random() * sakuraColors.length)];
  const duration = options.duration || (1 + Math.random() * 1.5);
  
  // Posi√ß√£o com offset aleat√≥rio
  const offsetX = (Math.random() - 0.5) * (options.spread || 60);
  const offsetY = (Math.random() - 0.5) * (options.spread || 60);
  
  petal.style.cssText = `
    left: ${x + offsetX}px;
    top: ${y + offsetY}px;
    animation: sakura-fall ${duration}s ease-out forwards,
               sakura-float ${duration * 0.5}s ease-in-out infinite;
  `;
  
  // SVG da p√©tala
  const svg = createSakuraPetalSVG(size, color);
  svg.style.transform = `rotate(${Math.random() * 360}deg)`;
  petal.appendChild(svg);
  
  container.appendChild(petal);
  
  // Remover ap√≥s anima√ß√£o
  setTimeout(() => {
    if (petal.parentNode) {
      petal.parentNode.removeChild(petal);
    }
  }, duration * 1000 + 100);
  
  return petal;
}

// Criar explos√£o de p√©talas no click
function createSakuraClickBurst(x, y) {
  const petalCount = 8 + Math.floor(Math.random() * 6); // 8-14 p√©talas
  
  for (let i = 0; i < petalCount; i++) {
    setTimeout(() => {
      createSakuraPetal(x, y, { spread: 80, size: 10 + Math.random() * 14 });
    }, i * 30); // Delay escalonado para efeito mais natural
  }
}

// Criar p√©tala no rastro do mouse
function createSakuraTrailPetal(x, y) {
  const container = document.getElementById('sakuraContainer');
  if (!container) return;
  
  const petal = document.createElement('div');
  petal.className = 'sakura-petal';
  
  const size = 8 + Math.random() * 10;
  const color = sakuraColors[Math.floor(Math.random() * sakuraColors.length)];
  const duration = 0.8 + Math.random() * 0.6;
  
  petal.style.cssText = `
    left: ${x}px;
    top: ${y}px;
    animation: sakura-trail ${duration}s ease-out forwards;
  `;
  
  const svg = createSakuraPetalSVG(size, color);
  svg.style.transform = `rotate(${Math.random() * 360}deg)`;
  petal.appendChild(svg);
  
  container.appendChild(petal);
  
  setTimeout(() => {
    if (petal.parentNode) {
      petal.parentNode.removeChild(petal);
    }
  }, duration * 1000 + 50);
}

// Handler do click para sakura
function handleSakuraClick(e) {
  if (!window.sakuraEffects.clickEnabled) return;
  createSakuraClickBurst(e.clientX, e.clientY);
}

// Handler do movimento do mouse para rastro
function handleSakuraTrail(e) {
  if (!window.sakuraEffects.trailEnabled) return;
  
  const now = Date.now();
  // Throttle: criar p√©tala a cada 50ms para n√£o sobrecarregar
  if (now - window.sakuraEffects.lastTrailTime < 50) return;
  window.sakuraEffects.lastTrailTime = now;
  
  // Chance de criar p√©tala (n√£o em todo movimento)
  if (Math.random() > 0.6) {
    createSakuraTrailPetal(e.clientX, e.clientY);
  }
}

// Toggle do efeito de click
function toggleSakuraClickEffect(enabled) {
  window.sakuraEffects.clickEnabled = enabled;
  
  if (enabled) {
    document.addEventListener('click', handleSakuraClick);
    // Mostrar preview
    document.getElementById('sakuraPreview').style.display = 'block';
    showToast('üå∏ Efeito de click ativado!', 'success');
  } else {
    document.removeEventListener('click', handleSakuraClick);
    if (!window.sakuraEffects.trailEnabled) {
      document.getElementById('sakuraPreview').style.display = 'none';
    }
    showToast('Click normal restaurado', 'info');
  }
  
  // Salvar prefer√™ncia
  localStorage.setItem('sakura_click_effect', enabled);
}

// Toggle do efeito de rastro
function toggleSakuraTrailEffect(enabled) {
  window.sakuraEffects.trailEnabled = enabled;
  
  if (enabled) {
    document.addEventListener('mousemove', handleSakuraTrail);
    // Mostrar preview
    document.getElementById('sakuraPreview').style.display = 'block';
    showToast('‚ú® Rastro de p√©talas ativado!', 'success');
  } else {
    document.removeEventListener('mousemove', handleSakuraTrail);
    if (!window.sakuraEffects.clickEnabled) {
      document.getElementById('sakuraPreview').style.display = 'none';
    }
    showToast('Rastro desativado', 'info');
  }
  
  // Salvar prefer√™ncia
  localStorage.setItem('sakura_trail_effect', enabled);
}

// Carregar prefer√™ncias salvas dos efeitos sakura
function loadSakuraPreferences() {
  const clickEnabled = localStorage.getItem('sakura_click_effect') === 'true';
  const trailEnabled = localStorage.getItem('sakura_trail_effect') === 'true';
  
  const clickToggle = document.getElementById('toggleClickEffect');
  const trailToggle = document.getElementById('toggleTrailEffect');
  
  if (clickToggle && clickEnabled) {
    clickToggle.checked = true;
    toggleSakuraClickEffect(true);
  }
  
  if (trailToggle && trailEnabled) {
    trailToggle.checked = true;
    toggleSakuraTrailEffect(true);
  }
}

// Inicializar prefer√™ncias quando o DOM carregar
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(loadSakuraPreferences, 500);
});
// Fun√ß√µes de navega√ß√£o (showTickets, showAnalytics, showBIPessoa, showBITime) 
// est√£o em js/navigation-functions.js

// BI Chart Functions - Legado (desabilitado - usando novo sistema Supabase)
function initializeBI() {
  // Fun√ß√£o legada - n√£o mais usada
  // O novo sistema BI Charts com Supabase √© inicializado via initBICharts()
  console.log('initializeBI() chamado - redirecionando para novo sistema');
  if (typeof initBICharts === 'function') {
    initBICharts();
  }
}

function refreshCharts() {
  // Fun√ß√£o legada - redireciona para o novo sistema
  if (typeof refreshBICharts === 'function') {
    refreshBICharts();
  }
}

// Enhanced color palette for charts - modern and elegant
const chartColors = {
  primary: [
    '#6366f1', // Indigo
    '#8b5cf6', // Purple
    '#ec4899', // Pink
    '#f43f5e', // Rose
    '#f97316', // Orange
    '#eab308', // Yellow
    '#84cc16', // Lime
    '#10b981', // Emerald
    '#14b8a6', // Teal
    '#06b6d4', // Cyan
    '#0ea5e9', // Sky
    '#3b82f6'  // Blue
  ],
  gradient: [
    ['#818cf8', '#6366f1'], // Indigo gradient
    ['#a78bfa', '#8b5cf6'], // Purple gradient
    ['#f9a8d4', '#ec4899'], // Pink gradient
    ['#fda4af', '#f43f5e'], // Rose gradient
    ['#fdba74', '#f97316'], // Orange gradient
    ['#fde047', '#eab308'], // Yellow gradient
    ['#bef264', '#84cc16'], // Lime gradient
    ['#6ee7b7', '#10b981'], // Emerald gradient
    ['#5eead4', '#14b8a6'], // Teal gradient
    ['#67e8f9', '#06b6d4'], // Cyan gradient
    ['#7dd3fc', '#0ea5e9'], // Sky gradient
    ['#93c5fd', '#3b82f6']  // Blue gradient
  ],
  // Semantic colors for specific use cases
  semantic: {
    success: '#10b981',
    warning: '#f97316',
    danger: '#ef4444',
    info: '#3b82f6',
    neutral: '#6b7280'
  }
};

// Chart hover tooltip state
let chartTooltip = {
  active: false,
  x: 0,
  y: 0,
  content: ''
};

// Helper function to show tooltip
function showTooltip(canvas, x, y, content) {
  const rect = canvas.getBoundingClientRect();
  chartTooltip.active = true;
  chartTooltip.x = rect.left + x;
  chartTooltip.y = rect.top + y;
  chartTooltip.content = content;
  updateTooltipDisplay();
}

// Helper function to hide tooltip
function hideTooltip() {
  chartTooltip.active = false;
  updateTooltipDisplay();
}

// Update tooltip display
function updateTooltipDisplay() {
  let tooltip = document.getElementById('chartTooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.id = 'chartTooltip';
    tooltip.style.cssText = `
      position: fixed;
      background: rgba(17, 24, 39, 0.95);
      color: #f3f4f6;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      pointer-events: none;
      z-index: 10000;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      transition: opacity 0.2s;
    `;
    document.body.appendChild(tooltip);
  }
  
  if (chartTooltip.active) {
    tooltip.innerHTML = chartTooltip.content;
    tooltip.style.left = chartTooltip.x + 'px';
    tooltip.style.top = (chartTooltip.y - 40) + 'px';
    tooltip.style.opacity = '1';
    tooltip.style.display = 'block';
  } else {
    tooltip.style.opacity = '0';
    setTimeout(() => {
      if (!chartTooltip.active) tooltip.style.display = 'none';
    }, 200);
  }
}

// Chart rendering functions using Canvas API
function renderCharts(teamName) {
  let teamData;
  
  // Se for Tryvia consolidado, agrega dados de todos os times
  if (teamName === 'TRYVIA_CONSOLIDADO') {
    teamData = consolidateAllTeams();
  } else {
    teamData = DATA.dados[teamName];
  }
  
  if (!teamData) return;
  
  // Clear and setup all canvases with proper responsive sizing
  const canvases = ['chartMonthly', 'chartTypes', 'chartPeople', 'chartSLA', 'chartPriority', 'chartComparison', 
                    'chartFollowUp', 'chartAvgTime', 'chartWeekday', 'chartResolution',
                    'chartEstado', 'chartOrigem', 'chartAgentes', 'chartEmpresas', 
                    'chartProduto', 'chartSistema', 'chartSituacao'];
  canvases.forEach(id => {
    const canvas = document.getElementById(id);
    if (canvas) {
      const container = canvas.parentElement;
      const ctx = canvas.getContext('2d');
      
      // Get actual container dimensions
      const containerRect = container.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      
      // Set canvas size based on container
      canvas.width = containerRect.width * dpr;
      canvas.height = containerRect.height * dpr;
      
      // Scale for high DPI displays
      ctx.scale(dpr, dpr);
      
      // Set CSS size to match container
      canvas.style.width = containerRect.width + 'px';
      canvas.style.height = containerRect.height + 'px';
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  });
  
  // Render each chart
  renderMonthlyChart(teamData);
  renderTypesChart(teamData);
  renderPeopleChart(teamData);
  renderSLAChart(teamData);
  renderPriorityChart(teamData);
  renderComparisonChart();
  renderFollowUpChart(teamData);
  renderAvgTimeChart(teamData);
  renderWeekdayChart(teamData);
  renderResolutionChart(teamData);
  
  // Render new analysis charts
  renderEstadoChart(teamData);
  renderOrigemChart(teamData);
  renderAgentesChart(teamData);
  renderEmpresasChart(teamData);
  renderProdutoChart(teamData);
  renderSistemaChart(teamData);
  renderSituacaoChart(teamData);
  
  // Update slide previews if presentation setup is visible
  const presContainer = document.getElementById('presentation-container');
  if (presContainer && presContainer.style.display !== 'none') {
    setTimeout(updateSlidePreviews, 100);
  }
}

function renderMonthlyChart(teamData) {
  const canvas = document.getElementById('chartMonthly');
  const ctx = canvas.getContext('2d');
  const timeline = teamData.timeline_mes || [];
  
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  if (!timeline || timeline.length === 0) {
    ctx.fillStyle = '#71717a';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Sem dados de timeline dispon√≠veis', width/2, height/2);
    return;
  }
  
  // Modern column chart with animations
  const maxValue = Math.max(...timeline.map(t => t.qtd));
  const padding = 60;
  const freeWidth = (width - padding * 2);
  const barWidth = Math.min(40, freeWidth / timeline.length - 16);
  const spacing = Math.max(12, (freeWidth - (barWidth * timeline.length)) / Math.max(1, (timeline.length - 1)));
  const chartHeight = height - 120;
  const bottomPad = 85;
  
  // Draw subtle grid
  ctx.strokeStyle = 'rgba(39, 39, 42, 0.3)';
  ctx.lineWidth = 1;
  ctx.setLineDash([5, 5]);
  
  // Y-axis labels and grid
  for (let i = 0; i <= 5; i++) {
    const y = 30 + (chartHeight / 5) * i;
    const value = Math.round(maxValue * (1 - i/5));
    
    ctx.beginPath();
    ctx.moveTo(padding - 10, y);
    ctx.lineTo(width - padding + 10, y);
    ctx.stroke();
    
    // Y-axis labels
    ctx.fillStyle = '#6b7280';
    ctx.font = '11px Inter';
    ctx.textAlign = 'right';
    ctx.fillText(value, padding - 15, y + 4);
  }
  ctx.setLineDash([]);
  
  // Month label helper to display names in PT-BR
  const __monthsPT = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  function formatMes(ym) {
    if (!ym) return 'N/A';
    const m = ym.match(/^(\d{4})-(\d{2})$/);
    if (m) {
      const y = m[1].slice(2);
      const idx = Math.max(0, Math.min(11, parseInt(m[2], 10) - 1));
      return __monthsPT[idx] + '/' + y;
    }
    return ym;
  }
  
  // Draw bars with hover effect simulation
  timeline.forEach((item, index) => {
    const barHeight = (item.qtd / maxValue) * chartHeight;
    const x = padding + index * (barWidth + spacing);
    const y = height - bottomPad - barHeight;
    
    // Shadow
    ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
    ctx.shadowBlur = 10;
    ctx.shadowOffsetY = 3;
    
    // Gradient bar
    const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
    const colors = chartColors.gradient[index % chartColors.gradient.length];
    gradient.addColorStop(0, colors[0]);
    gradient.addColorStop(0.5, colors[1]);
    gradient.addColorStop(1, colors[0]);
    
    ctx.fillStyle = gradient;
    ctx.beginPath();
    // Ensure we have valid dimensions before drawing
    if (barWidth > 0 && barHeight > 0) {
      const cornerRadius = Math.min(8, barHeight/2, barWidth/2);
      ctx.roundRect(x, y, barWidth, barHeight, [cornerRadius, cornerRadius, 0, 0]);
      ctx.fill();
    }
    
    ctx.shadowBlur = 0;
    
    // Value label on top
    ctx.fillStyle = '#f3f4f6';
    ctx.font = 'bold 13px Inter';
    ctx.textAlign = 'center';
    ctx.fillText(item.qtd, x + barWidth/2, y - 10);
    
    // Month label
    ctx.fillStyle = '#a1a1aa';
    ctx.font = '12px Inter';
    ctx.fillText(formatMes(item.mes), x + barWidth/2, height - bottomPad + 25);
    
    // Trend indicator (if not first or last)
    if (index > 0 && index < timeline.length - 1) {
      const prev = timeline[index - 1].qtd;
      const trend = item.qtd > prev ? '‚Üó' : item.qtd < prev ? '‚Üò' : '‚Üí';
      const trendColor = item.qtd > prev ? '#10b981' : item.qtd < prev ? '#ef4444' : '#6b7280';
      
      ctx.fillStyle = trendColor;
      ctx.font = '14px Inter';
      ctx.fillText(trend, x + barWidth/2, y - 25);
    }
  });
  
  // Add title
  ctx.fillStyle = '#e4e4e7';
  ctx.font = 'bold 14px Inter';
  ctx.textAlign = 'left';
  ctx.fillText('Evolu√ß√£o Mensal', padding, 20);
  
  // Add hover interaction
  canvas.style.cursor = 'pointer';
  canvas.onmousemove = (e) => {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    for (let i = 0; i < timeline.length; i++) {
      const x = padding + i * (barWidth + spacing);
      const barHeight = (timeline[i].qtd / maxValue) * chartHeight;
      const y = height - bottomPad - barHeight;
      
      if (mouseX >= x && mouseX <= x + barWidth && mouseY >= y && mouseY <= height - bottomPad) {
        const item = timeline[i];
        const prevMonth = i > 0 ? timeline[i-1].qtd : 0;
        const growth = prevMonth ? Math.round(((item.qtd - prevMonth) / prevMonth) * 100) : 0;
        
        showTooltip(canvas, mouseX, mouseY, `
          <div style="font-weight: 600; margin-bottom: 4px;">${formatMes(item.mes)}</div>
          <div>Tickets: <span style="color: #60a5fa;">${item.qtd}</span></div>
          ${i > 0 ? `<div>Varia√ß√£o: <span style="color: ${growth >= 0 ? '#34d399' : '#f87171'};">${growth >= 0 ? '+' : ''}${growth}%</span></div>` : ''}
        `);
        return;
      }
    }
    hideTooltip();
  };
  
  canvas.onmouseleave = () => hideTooltip();
}

function renderTypesChart(teamData) {
  const canvas = document.getElementById('chartTypes');
  const ctx = canvas.getContext('2d');
  const types = teamData.por_tipo_primario || [];
  
  // Get actual drawing dimensions
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  if (!types || types.length === 0) {
    ctx.fillStyle = '#71717a';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Sem dados de tipos dispon√≠veis', width/2, height/2);
    return;
  }
  
  // Convert to horizontal bar chart for better readability
  const typesData = types.slice(0, 10).map(t => ({ 
    tipo: t.tipo_primario || 'N√£o especificado', 
    qtd: t.qtd 
  }));
  const total = typesData.reduce((sum, t) => sum + t.qtd, 0);
  const maxValue = Math.max(...typesData.map(t => t.qtd));
  
  // Layout configuration
  const leftMargin = Math.min(180, width * 0.35);
  const rightMargin = 80;
  const topMargin = 40;
  const bottomMargin = 30;
  const barHeight = Math.min(30, (height - topMargin - bottomMargin) / typesData.length - 8);
  const spacing = 8;
  const maxBarWidth = width - leftMargin - rightMargin;
  
  // Draw title
  ctx.font = 'bold 14px Inter';
  ctx.fillStyle = '#e4e4e7';
  ctx.textAlign = 'left';
  ctx.fillText(`Total: ${total}`, 20, 25);
  
  // Draw horizontal bars
  typesData.forEach((item, index) => {
    const y = topMargin + index * (barHeight + spacing);
    const barWidth = (item.qtd / maxValue) * maxBarWidth;
    const percentage = Math.round((item.qtd / total) * 100);
    
    // Background bar
    ctx.fillStyle = 'rgba(39, 39, 42, 0.3)';
    ctx.fillRect(leftMargin, y, maxBarWidth, barHeight);
    
    // Main bar with gradient
    const gradient = ctx.createLinearGradient(leftMargin, 0, leftMargin + barWidth, 0);
    const colors = chartColors.gradient[index % chartColors.gradient.length];
    gradient.addColorStop(0, colors[0]);
    gradient.addColorStop(1, colors[1]);
    ctx.fillStyle = gradient;
    ctx.fillRect(leftMargin, y, barWidth, barHeight);
    
    // Shadow effect
    ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
    ctx.shadowBlur = 4;
    ctx.shadowOffsetY = 2;
    ctx.fillRect(leftMargin, y, barWidth, barHeight);
    ctx.shadowBlur = 0;
    
    // Type name (left aligned)
    ctx.fillStyle = '#e4e4e7';
    ctx.font = '12px Inter';
    ctx.textAlign = 'right';
    const displayName = item.tipo.length > 20 ? item.tipo.substring(0, 18) + '...' : item.tipo;
    ctx.fillText(displayName, leftMargin - 10, y + barHeight/2 + 4);
    
    // Value inside bar (if space) or outside
    ctx.font = 'bold 11px Inter';
    const valueText = `${item.qtd} (${percentage}%)`;
    const textWidth = ctx.measureText(valueText).width;
    
    if (barWidth > textWidth + 20) {
      ctx.fillStyle = '#ffffff';
      ctx.textAlign = 'left';
      ctx.fillText(valueText, leftMargin + 10, y + barHeight/2 + 4);
    } else {
      ctx.fillStyle = '#a1a1aa';
      ctx.textAlign = 'left';
      ctx.fillText(valueText, leftMargin + barWidth + 5, y + barHeight/2 + 4);
    }
  });
  
  
  // Add subtle grid lines
  ctx.strokeStyle = 'rgba(39, 39, 42, 0.2)';
  ctx.lineWidth = 1;
  ctx.setLineDash([2, 2]);
  for (let i = 0; i <= 4; i++) {
    const x = leftMargin + (maxBarWidth / 4) * i;
    ctx.beginPath();
    ctx.moveTo(x, topMargin - 5);
    ctx.lineTo(x, topMargin + typesData.length * (barHeight + spacing) - spacing);
    ctx.stroke();
  }
  ctx.setLineDash([]);
  
  
  // Add hover interaction without re-rendering
  canvas.onmousemove = (e) => {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    // Check which bar is being hovered
    for (let i = 0; i < typesData.length; i++) {
      const y = topMargin + i * (barHeight + spacing);
      if (mouseX >= leftMargin && mouseX <= width - rightMargin && 
          mouseY >= y && mouseY <= y + barHeight) {
        const item = typesData[i];
        const percentage = Math.round((item.qtd / total) * 100);
        showTooltip(canvas, mouseX, mouseY, `
          <div style="font-weight: 600; margin-bottom: 4px;">${item.tipo}</div>
          <div>Quantidade: <span style="color: #60a5fa;">${item.qtd}</span></div>
          <div>Percentual: <span style="color: #34d399;">${percentage}%</span></div>
          <div>Ranking: <span style="color: #fbbf24;">#${i + 1}</span></div>
        `);
        canvas.style.cursor = 'pointer';
        return;
      }
    }
    hideTooltip();
    canvas.style.cursor = 'default';
  };
  
  canvas.onmouseleave = () => {
    hideTooltip();
    canvas.style.cursor = 'default';
  };
}

function renderPeopleChart(teamData) {
  const canvas = document.getElementById('chartPeople');
  const ctx = canvas.getContext('2d');
  const people = (teamData.top_tratativa || []).slice(0, 8); // Limit to 8 for better visibility
  
  // Get actual drawing dimensions
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  if (people.length === 0) {
    ctx.fillStyle = '#71717a';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Sem dados de pessoas dispon√≠veis', width/2, height/2);
    return;
  }
  
  // Modern horizontal bar chart with enhanced visuals
  const maxValue = Math.max(...people.map(p => p.qtd));
  const barHeight = Math.min(35, (height - 100) / people.length - 12);
  const spacing = 12;
  const leftMargin = Math.min(140, width * 0.3);
  const rightMargin = 60;
  const maxBarWidth = width - leftMargin - rightMargin;
  
  // Add chart title
  ctx.font = 'bold 14px Inter';
  ctx.fillStyle = '#e4e4e7';
  ctx.textAlign = 'left';
  ctx.fillText('Ranking de Atendimentos', 20, 25);
  
  people.forEach((person, index) => {
    const y = 50 + index * (barHeight + spacing);
    const barWidth = (person.qtd / maxValue) * maxBarWidth;
    const percentage = Math.round((person.qtd / people[0].qtd) * 100);
    
    // Draw subtle background
    ctx.fillStyle = 'rgba(39, 39, 42, 0.4)';
    ctx.fillRect(leftMargin, y, maxBarWidth, barHeight);
    
    // Draw bar with gradient and shadow
    ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
    ctx.shadowBlur = 8;
    ctx.shadowOffsetY = 2;
    
    const gradient = ctx.createLinearGradient(leftMargin, 0, leftMargin + barWidth, 0);
    const colors = chartColors.gradient[index % chartColors.gradient.length];
    gradient.addColorStop(0, colors[0]);
    gradient.addColorStop(0.5, colors[1]);
    gradient.addColorStop(1, colors[0]);
    ctx.fillStyle = gradient;
    
    // Draw bar with rounded corners
    ctx.beginPath();
    // Ensure radius is never negative and not larger than half the smallest dimension
    const maxRadius = Math.min(barWidth/2, barHeight/2);
    const cornerRadius = Math.max(0, Math.min(maxRadius, barHeight/2));
    
    if (barWidth > 0) {
      ctx.roundRect(leftMargin, y, barWidth, barHeight, cornerRadius);
      ctx.fill();
    }
    
    ctx.shadowBlur = 0;
    
    // Position indicator (1st, 2nd, 3rd with medals)
    const medals = ['ü•á', 'ü•à', 'ü•â'];
    if (index < 3) {
      ctx.font = '20px Inter';
      ctx.textAlign = 'center';
      ctx.fillText(medals[index], 25, y + barHeight/2 + 6);
    } else {
      ctx.fillStyle = '#6b7280';
      ctx.font = 'bold 14px Inter';
      ctx.textAlign = 'center';
      ctx.fillText(`${index + 1}¬∞`, 25, y + barHeight/2 + 5);
    }
    
    // Draw name with better formatting
    ctx.fillStyle = '#f3f4f6';
    ctx.font = '13px Inter';
    ctx.textAlign = 'right';
    const nameText = person.pessoa;
    const maxNameWidth = leftMargin - 45;
    
    let displayName = nameText;
    if (ctx.measureText(nameText).width > maxNameWidth) {
      for (let i = nameText.length; i > 0; i--) {
        displayName = nameText.substring(0, i) + '‚Ä¶';
        if (ctx.measureText(displayName).width <= maxNameWidth) break;
      }
    }
    ctx.fillText(displayName, leftMargin - 10, y + barHeight/2 + 4);
    
    // Draw value and percentage
    ctx.font = 'bold 13px Inter';
    if (barWidth > 80) {
      // Inside bar
      ctx.fillStyle = '#ffffff';
      ctx.textAlign = 'right';
      ctx.fillText(person.qtd, leftMargin + barWidth - 15, y + barHeight/2 + 4);
      
      // Percentage
      ctx.font = '11px Inter';
      ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
      ctx.fillText(`${percentage}%`, leftMargin + barWidth - 55, y + barHeight/2 + 4);
    } else {
      // Outside bar
      ctx.fillStyle = '#e4e4e7';
      ctx.textAlign = 'left';
      ctx.fillText(`${person.qtd} (${percentage}%)`, leftMargin + barWidth + 8, y + barHeight/2 + 4);
    }
  });
  
  // Add hover interaction
  canvas.style.cursor = 'pointer';
  canvas.onmousemove = (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    // Check which bar is hovered
    for (let i = 0; i < people.length; i++) {
      const barY = 50 + i * (barHeight + spacing);
      if (y >= barY && y <= barY + barHeight && x >= leftMargin) {
        const person = people[i];
        showTooltip(canvas, x, y, `
          <div style="font-weight: 600; margin-bottom: 4px;">${person.pessoa}</div>
          <div>Tickets: <span style="color: #60a5fa;">${person.qtd}</span></div>
          <div>Ranking: <span style="color: #fbbf24;">#${i + 1}</span></div>
        `);
        return;
      }
    }
    hideTooltip();
  };
  
  canvas.onmouseleave = () => hideTooltip();
}

function renderSLAChart(teamData) {
  const canvas = document.getElementById('chartSLA');
  const ctx = canvas.getContext('2d');
  
  // Debug: Check what data we're receiving
  console.log('SLA Chart Data:', {
    firstResponse: teamData.sla_primeira_resposta_h_media,
    resolution: teamData.sla_resolucao_h_media,
    sla24: teamData.sla_24h_pct
  });
  
  // Handle both numeric and formatted time values
  let firstResponseValue = 0, resolutionValue = 0;
  
  // Check if values are already numbers or need conversion
  if (typeof teamData.sla_primeira_resposta_h_media === 'number') {
    firstResponseValue = teamData.sla_primeira_resposta_h_media;
  } else if (teamData.sla_primeira_resposta_h_media && typeof teamData.sla_primeira_resposta_h_media === 'string') {
    if (teamData.sla_primeira_resposta_h_media.includes(':')) {
      // Convert HH:MM:SS to hours
      const parts = teamData.sla_primeira_resposta_h_media.split(':').map(p => parseInt(p) || 0);
      firstResponseValue = parts[0] + (parts[1] || 0)/60 + (parts[2] || 0)/3600;
    } else {
      firstResponseValue = parseFloat(teamData.sla_primeira_resposta_h_media) || 0;
    }
  }
  
  if (typeof teamData.sla_resolucao_h_media === 'number') {
    resolutionValue = teamData.sla_resolucao_h_media;
  } else if (teamData.sla_resolucao_h_media && typeof teamData.sla_resolucao_h_media === 'string') {
    if (teamData.sla_resolucao_h_media.includes(':')) {
      // Convert HH:MM:SS to hours
      const parts = teamData.sla_resolucao_h_media.split(':').map(p => parseInt(p) || 0);
      resolutionValue = parts[0] + (parts[1] || 0)/60 + (parts[2] || 0)/3600;
    } else {
      resolutionValue = parseFloat(teamData.sla_resolucao_h_media) || 0;
    }
  }
  
  const sla24Value = typeof teamData.sla_24h_pct === 'number' ? 
    teamData.sla_24h_pct : parseFloat(teamData.sla_24h_pct) || 0;
  
  // Ensure values are valid numbers and properly formatted
  firstResponseValue = isNaN(firstResponseValue) ? 0 : firstResponseValue;
  resolutionValue = isNaN(resolutionValue) ? 0 : resolutionValue;
  
  const slaData = [
    { label: '1¬™ Resposta', value: firstResponseValue.toFixed(2), unit: 'h', max: 24 },
    { label: 'Resolu√ß√£o', value: resolutionValue.toFixed(2), unit: 'h', max: 48 },
    { label: 'SLA 24h', value: sla24Value.toFixed(1), unit: '%', max: 100 }
  ];
  
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  const cols = 3;
  const colWidth = width / cols;
  
  // Modern KPI cards
  slaData.forEach((item, index) => {
    const x = colWidth * index + 20;
    const y = height / 2 - 60;
    const cardWidth = colWidth - 40;
    const cardHeight = 120;
    
    // Card background with gradient
    const gradient = ctx.createLinearGradient(x, y, x, y + cardHeight);
    gradient.addColorStop(0, 'rgba(39, 39, 42, 0.6)');
    gradient.addColorStop(1, 'rgba(39, 39, 42, 0.3)');
    
    ctx.fillStyle = gradient;
    if (cardWidth > 0 && cardHeight > 0) {
      const cornerRadius = Math.min(12, cardHeight/2, cardWidth/2);
      ctx.beginPath();
      ctx.roundRect(x, y, cardWidth, cardHeight, cornerRadius);
      ctx.fill();
      
      // Border
      ctx.strokeStyle = 'rgba(63, 63, 70, 0.5)';
      ctx.lineWidth = 1;
      ctx.stroke();
    }
    
    // Calculate performance color (convert value to number for calculation)
    const numericValue = parseFloat(item.value);
    const percentage = numericValue / item.max;
    let statusColor, statusIcon;
    
    if (item.unit === '%') {
      statusColor = percentage > 0.8 ? '#10b981' : percentage > 0.6 ? '#f97316' : '#ef4444';
      statusIcon = percentage > 0.8 ? '‚úì' : percentage > 0.6 ? '‚ö†' : '‚úó';
    } else {
      statusColor = percentage < 0.3 ? '#10b981' : percentage < 0.6 ? '#f97316' : '#ef4444';
      statusIcon = percentage < 0.3 ? '‚úì' : percentage < 0.6 ? '‚ö†' : '‚úó';
    }
    
    // Status indicator
    ctx.fillStyle = statusColor;
    ctx.font = '20px Inter';
    ctx.textAlign = 'center';
    ctx.fillText(statusIcon, x + cardWidth/2, y + 25);
    
    // Value (ensure proper formatting)
    ctx.fillStyle = '#f3f4f6';
    ctx.font = 'bold 28px Inter';
    const displayValue = item.value;
    ctx.fillText(`${displayValue}${item.unit}`, x + cardWidth/2, y + 60);
    
    // Label
    ctx.fillStyle = '#a1a1aa';
    ctx.font = '12px Inter';
    ctx.fillText(item.label, x + cardWidth/2, y + 80);
    
    // Mini progress bar
    const barY = y + 95;
    const barWidth = cardWidth - 40;
    const barHeight = 4;
    const progressWidth = Math.min(barWidth * percentage, barWidth);
    
    // Background
    ctx.fillStyle = 'rgba(39, 39, 42, 0.5)';
    ctx.fillRect(x + 20, barY, barWidth, barHeight);
    
    // Progress
    const progressGradient = ctx.createLinearGradient(x + 20, 0, x + 20 + progressWidth, 0);
    progressGradient.addColorStop(0, statusColor);
    progressGradient.addColorStop(1, statusColor + '88');
    ctx.fillStyle = progressGradient;
    ctx.fillRect(x + 20, barY, progressWidth, barHeight);
  });
  
  // Title
  ctx.fillStyle = '#e4e4e7';
  ctx.font = 'bold 14px Inter';
  ctx.textAlign = 'left';
  ctx.fillText('Indicadores de Performance', 20, 30);
}

function renderPriorityChart(teamData) {
  const canvas = document.getElementById('chartPriority');
  const ctx = canvas.getContext('2d');
  const priorities = teamData.por_prioridade_dev || [];
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  if (priorities.length === 0) {
    ctx.fillStyle = '#71717a';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Sem dados de prioridade dispon√≠veis', width/2, height/2);
    return;
  }
  
  const prioritiesData = priorities.map(p => ({ prioridade: p.prioridade_dev, qtd: p.qtd }));
  const total = prioritiesData.reduce((sum, p) => sum + p.qtd, 0);
  
  // Modern radial progress bars
  const centerX = width / 2;
  const centerY = height / 2;
  const maxRadius = Math.min(centerX, centerY) - 60;
  
  const priorityConfig = {
    'Cr√≠tica': { color: '#ef4444', gradient: ['#fca5a5', '#ef4444'], icon: 'üî¥' },
    'Alta': { color: '#f97316', gradient: ['#fed7aa', '#f97316'], icon: 'üü†' },
    'M√©dia': { color: '#eab308', gradient: ['#fef3c7', '#eab308'], icon: 'üü°' },
    'Baixa': { color: '#10b981', gradient: ['#86efac', '#10b981'], icon: 'üü¢' },
    'Sem Prioridade': { color: '#6b7280', gradient: ['#d1d5db', '#6b7280'], icon: '‚ö™' }
  };
  
  // Sort by priority order
  const orderedPriorities = ['Cr√≠tica', 'Alta', 'M√©dia', 'Baixa', 'Sem Prioridade'];
  const sortedData = orderedPriorities
    .map(p => prioritiesData.find(d => d.prioridade === p))
    .filter(Boolean);
  
  // Draw radial bars
  const barWidth = 20;
  const barSpacing = 10;
  
  sortedData.forEach((item, index) => {
    const config = priorityConfig[item.prioridade] || { color: '#8b5cf6', gradient: ['#a78bfa', '#8b5cf6'] };
    const radius = Math.max(10, maxRadius - (index * (barWidth + barSpacing))); // Ensure minimum radius
    
    // Skip if radius would be too small
    if (radius < barWidth) return;
    
    const percentage = (item.qtd / total);
    const endAngle = -Math.PI/2 + (percentage * 2 * Math.PI);
    
    // Background arc
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.strokeStyle = 'rgba(39, 39, 42, 0.3)';
    ctx.lineWidth = barWidth;
    ctx.stroke();
    
    // Progress arc with gradient
    const gradient = ctx.createConicGradient(-Math.PI/2, centerX, centerY);
    gradient.addColorStop(0, config.gradient[0]);
    gradient.addColorStop(percentage, config.gradient[1]);
    gradient.addColorStop(percentage + 0.01, 'transparent');
    
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, -Math.PI/2, endAngle);
    ctx.strokeStyle = config.color;
    ctx.lineWidth = barWidth;
    ctx.lineCap = 'round';
    ctx.stroke();
    
    // Draw icon and label
    const labelAngle = -Math.PI/2 + (percentage * Math.PI);
    const labelX = centerX + Math.cos(labelAngle) * (radius + barWidth);
    const labelY = centerY + Math.sin(labelAngle) * (radius + barWidth);
    
    // Priority label with value
    ctx.font = '12px Inter';
    ctx.fillStyle = config.color;
    ctx.textAlign = 'center';
    ctx.fillText(config.icon, labelX, labelY - 5);
    
    ctx.font = 'bold 11px Inter';
    ctx.fillStyle = '#e4e4e7';
    ctx.fillText(item.qtd, labelX, labelY + 10);
  });
  
  // Center info
  ctx.fillStyle = '#e4e4e7';
  ctx.font = 'bold 28px Inter';
  ctx.textAlign = 'center';
  ctx.fillText(total, centerX, centerY - 5);
  ctx.font = '13px Inter';
  ctx.fillStyle = '#a1a1aa';
  ctx.fillText('Total de Tickets', centerX, centerY + 15);
  
  // Legend on the side
  const legendX = width - 120;
  const legendY = height / 2 - (sortedData.length * 15);
  
  sortedData.forEach((item, index) => {
    const config = priorityConfig[item.prioridade];
    const y = legendY + index * 30;
    const percentage = Math.round((item.qtd / total) * 100);
    
    // Icon
    ctx.font = '14px Inter';
    ctx.fillStyle = config.color;
    ctx.textAlign = 'left';
    ctx.fillText(config.icon, legendX, y);
    
    // Label
    ctx.font = '11px Inter';
    ctx.fillStyle = '#e4e4e7';
    ctx.fillText(item.prioridade, legendX + 20, y - 2);
    
    // Percentage
    ctx.font = 'bold 10px Inter';
    ctx.fillStyle = '#a1a1aa';
    ctx.fillText(`${percentage}%`, legendX + 20, y + 10);
  });
}

function renderComparisonChart() {
  const canvas = document.getElementById('chartComparison');
  const ctx = canvas.getContext('2d');
  // Use container dimensions to avoid clipping on HiDPI and narrow cards
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  // Get top 5 teams by tickets
  const teamsData = DATA.times.slice(0, 5).map(team => ({
    name: team,
    total: DATA.dados[team]?.total_tickets || 0,
    sla24: DATA.dados[team]?.sla_24h_pct || 0
  }));
  
  if (teamsData.length === 0) {
    ctx.fillStyle = '#71717a';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Sem dados para compara√ß√£o', width/2, height/2);
    return;
  }
  
  // Draw grouped bar chart
  const maxTickets = Math.max(...teamsData.map(t => t.total));
  const barWidth = 35;
  const leftMargin = Math.min(80, width * 0.12);
  const rightMargin = 40;
  // Reserve space for legend on top and extra room at bottom for rotated labels
  const legendHeight = 24;
  const topMargin = 20 + legendHeight; // prevents bar/label from touching legend
  const bottomMargin = 60;
  const chartWidth = width - leftMargin - rightMargin;
  const chartHeight = height - (topMargin + bottomMargin);
  const groupWidth = chartWidth / teamsData.length;
  
  teamsData.forEach((team, index) => {
    const x = leftMargin + index * groupWidth;
    
    // Draw tickets bar with different color for each team
    const ticketsHeight = (team.total / maxTickets) * chartHeight;
    ctx.fillStyle = chartColors.primary[index % chartColors.primary.length];
    ctx.fillRect(x, height - bottomMargin - ticketsHeight, barWidth, ticketsHeight);
    
    // Draw SLA bar with complementary color
    const slaHeight = (team.sla24 / 100) * chartHeight;
    // Use a lighter/different shade for SLA bars
    const slaColorIndex = (index + 3) % chartColors.primary.length;
    ctx.fillStyle = chartColors.primary[slaColorIndex];
    ctx.fillRect(x + barWidth + 5, height - bottomMargin - slaHeight, barWidth, slaHeight);
    
    // Draw team name
    ctx.fillStyle = '#a1a1aa';
    ctx.font = '11px Inter';
    ctx.save();
    ctx.translate(x + barWidth, height - 20);
    ctx.rotate(-Math.PI/4);
    ctx.fillText(team.name.substring(0, 15), 0, 0);
    ctx.restore();
    
    // Draw values with clamped Y so they never overlap the legend area
    ctx.font = '10px Inter';
    ctx.textAlign = 'center';
    const ticketsYRaw = height - (bottomMargin + 5) - ticketsHeight;
    const slaYRaw = height - (bottomMargin + 5) - slaHeight;
    const ticketsY = Math.max(topMargin + 12, ticketsYRaw);
    const slaY = Math.max(topMargin + 12, slaYRaw);
    // Use white when the label is clamped (likely inside the bar) for contrast
    ctx.fillStyle = (ticketsY !== ticketsYRaw) ? '#ffffff' : '#e4e4e7';
    ctx.fillText(team.total, x + barWidth/2, ticketsY);
    ctx.fillStyle = (slaY !== slaYRaw) ? '#ffffff' : '#e4e4e7';
    ctx.fillText(team.sla24 + '%', x + barWidth + 5 + barWidth/2, slaY);
  });
  
  // Draw legend
  ctx.fillStyle = '#3b82f6';
  ctx.fillRect(10, 10, 15, 15);
  ctx.fillStyle = '#a1a1aa';
  ctx.font = '12px Inter';
  ctx.textAlign = 'left';
  ctx.fillText('Total Tickets', 30, 20);
  
  ctx.fillStyle = '#10b981';
  ctx.fillRect(120, 10, 15, 15);
  ctx.fillStyle = '#a1a1aa';
  ctx.fillText('SLA 24h %', 140, 20);
}

// New BI functions
function renderFollowUpChart(teamData) {
  const canvas = document.getElementById('chartFollowUp');
  const ctx = canvas.getContext('2d');
  
  // Get actual drawing dimensions
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  // Simulate follow-up data (quem mais acompanha tickets)
  const followUpData = (teamData.top_tratativa || []).slice(0, 8).map(person => ({
    name: person.pessoa,
    acompanhamentos: Math.floor(person.qtd * (0.5 + Math.random() * 0.5)), // Simulate
    qtd: person.qtd
  }));
  
  if (followUpData.length === 0) {
    ctx.fillStyle = '#71717a';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Sem dados de acompanhamento dispon√≠veis', width/2, height/2);
    return;
  }
  
  // Responsive margins
  const leftMargin = Math.min(120, width * 0.25);
  const rightMargin = 40;
  const maxBarWidth = width - leftMargin - rightMargin;
  
  const maxValue = Math.max(...followUpData.map(p => p.acompanhamentos));
  const barHeight = Math.min(35, (height - 80) / followUpData.length - 10);
  const spacing = 10;
  
  followUpData.forEach((person, index) => {
    const y = 50 + index * (barHeight + spacing);
    const barWidth = (person.acompanhamentos / maxValue) * maxBarWidth;
    
    // Draw background bar
    ctx.fillStyle = '#27272a';
    ctx.fillRect(leftMargin, y, maxBarWidth, barHeight);
    
    // Draw bar with gradient - different colors for each person
    const gradient = ctx.createLinearGradient(leftMargin, 0, leftMargin + barWidth, 0);
    const colors = chartColors.gradient[index % chartColors.gradient.length];
    gradient.addColorStop(0, colors[0]);
    gradient.addColorStop(1, colors[1]);
    ctx.fillStyle = gradient;
    ctx.fillRect(leftMargin, y, barWidth, barHeight);
    
    // Draw name with ellipsis if needed
    ctx.fillStyle = '#e4e4e7';
    ctx.font = '12px Inter';
    ctx.textAlign = 'right';
    const nameText = person.name;
    const maxNameWidth = leftMargin - 10;
    
    let displayName = nameText;
    if (ctx.measureText(nameText).width > maxNameWidth) {
      for (let i = nameText.length; i > 0; i--) {
        displayName = nameText.substring(0, i) + '...';
        if (ctx.measureText(displayName).width <= maxNameWidth) break;
      }
    }
    ctx.fillText(displayName, leftMargin - 5, y + barHeight/2 + 4);
    
    // Draw value
    ctx.font = 'bold 11px Inter';
    if (barWidth > 40) {
      ctx.fillStyle = '#ffffff';
      ctx.textAlign = 'right';
      ctx.fillText(person.acompanhamentos, leftMargin + barWidth - 10, y + barHeight/2 + 4);
    } else {
      ctx.fillStyle = '#e4e4e7';
      ctx.textAlign = 'left';
      ctx.fillText(person.acompanhamentos, leftMargin + barWidth + 5, y + barHeight/2 + 4);
    }
  });
}

function renderAvgTimeChart(teamData) {
  const canvas = document.getElementById('chartAvgTime');
  const ctx = canvas.getContext('2d');
  
  // Get actual drawing dimensions
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  // Calculate real time distribution from data
  const avgTimeHours = parseFloat(teamData.sla_resolucao_h_media) || 24;
  const totalTickets = teamData.total_tickets || 100;
  
  // Simulate distribution based on average (in real app, this should come from actual data)
  const timeData = [
    { label: '< 2h', count: Math.floor(totalTickets * 0.15), color: '#10b981' },
    { label: '2-8h', count: Math.floor(totalTickets * 0.35), color: '#3b82f6' },
    { label: '8-24h', count: Math.floor(totalTickets * 0.30), color: '#f59e0b' },
    { label: '1-3 dias', count: Math.floor(totalTickets * 0.15), color: '#f97316' },
    { label: '> 3 dias', count: Math.floor(totalTickets * 0.05), color: '#ef4444' }
  ];
  
  const maxValue = Math.max(...timeData.map(t => t.count));
  const marginX = Math.min(60, width * 0.1);
  const barWidth = (width - marginX * 2) / timeData.length;
  const chartHeight = height - 100;
  
  // Draw area chart
  ctx.beginPath();
  ctx.moveTo(marginX, height - 40);
  
  timeData.forEach((item, index) => {
    const x = marginX + index * barWidth + barWidth / 2;
    const y = height - 40 - (item.count / maxValue) * chartHeight;
    
    if (index === 0) {
      ctx.moveTo(marginX, y);
    }
    ctx.lineTo(x, y);
  });
  
  ctx.lineTo(marginX + (timeData.length - 1) * barWidth + barWidth / 2, height - 40);
  ctx.lineTo(marginX, height - 40);
  ctx.closePath();
  
  // Fill with gradient
  const gradient = ctx.createLinearGradient(0, 50, 0, height - 40);
  gradient.addColorStop(0, 'rgba(139, 92, 246, 0.4)');
  gradient.addColorStop(1, 'rgba(139, 92, 246, 0.05)');
  ctx.fillStyle = gradient;
  ctx.fill();
  
  // Draw line
  ctx.strokeStyle = '#8b5cf6';
  ctx.lineWidth = 3;
  ctx.beginPath();
  timeData.forEach((item, index) => {
    const x = marginX + index * barWidth + barWidth / 2;
    const y = height - 40 - (item.count / maxValue) * chartHeight;
    
    if (index === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
    
    // Draw point
    ctx.fillStyle = item.color;
    ctx.beginPath();
    ctx.arc(x, y, 5, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = '#1e1e1e';
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.strokeStyle = '#8b5cf6';
    ctx.lineWidth = 3;
  });
  ctx.stroke();
  
  // Draw labels
  timeData.forEach((item, index) => {
    const x = marginX + index * barWidth + barWidth / 2;
    const y = height - 40 - (item.count / maxValue) * chartHeight;
    
    // Draw value
    ctx.fillStyle = '#e4e4e7';
    ctx.font = 'bold 11px Inter';
    ctx.textAlign = 'center';
    ctx.fillText(item.count, x, y - 10);
    
    // Draw label
    ctx.fillStyle = '#a1a1aa';
    ctx.font = '11px Inter';
    ctx.fillText(item.label, x, height - 20);
  });
  
  // Draw title with average time
  ctx.fillStyle = '#e4e4e7';
  ctx.font = 'bold 18px Inter';
  ctx.textAlign = 'left';
  ctx.fillText(`M√©dia: ${avgTimeHours.toFixed(1)}h`, marginX, 35);
  
  // Add hover interaction
  canvas.onmousemove = (e) => {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    for (let i = 0; i < timeData.length; i++) {
      const x = marginX + i * barWidth + barWidth / 2;
      const y = height - 40 - (timeData[i].count / maxValue) * chartHeight;
      
      // Check if hovering near a point (within 20px)
      const distance = Math.sqrt((mouseX - x) ** 2 + (mouseY - y) ** 2);
      if (distance <= 20) {
        const item = timeData[i];
        const pct = Math.round((item.count / totalTickets) * 100);
        showTooltip(canvas, mouseX, mouseY, `
          <div style="font-weight: 600; margin-bottom: 4px;">${item.label}</div>
          <div>Tickets: <span style="color: #60a5fa;">${item.count}</span></div>
          <div>Percentual: <span style="color: #34d399;">${pct}%</span></div>
        `);
        canvas.style.cursor = 'pointer';
        return;
      }
    }
    hideTooltip();
    canvas.style.cursor = 'default';
  };
  
  canvas.onmouseleave = () => {
    hideTooltip();
    canvas.style.cursor = 'default';
  };
}

function renderWeekdayChart(teamData) {
  const canvas = document.getElementById('chartWeekday');
  const ctx = canvas.getContext('2d');
  
  // Use container dimensions (CSS pixels)
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  // Calculate real weekday distribution
  const total = teamData.total_tickets || 100;
  const weekdays = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
  
  // Realistic distribution: more tickets on weekdays
  const distribution = [0.18, 0.19, 0.20, 0.19, 0.17, 0.04, 0.03];
  const weekdayData = weekdays.map((day, index) => ({
    day: day,
    count: Math.floor(total * distribution[index])
  }));
  
  const maxValue = Math.max(...weekdayData.map(w => w.count));
  const marginX = Math.min(60, width * 0.1);
  const topMargin = 20;
  const bottomMargin = 40;
  const barWidth = (width - marginX * 2) / weekdayData.length;
  const chartHeight = height - (topMargin + bottomMargin);
  
  weekdayData.forEach((item, index) => {
    const barHeight = (item.count / maxValue) * chartHeight;
    const x = marginX + index * barWidth;
    const y = height - bottomMargin - barHeight;
    
    // Draw bar with conditional color
    let color;
    if (index < 5) { // Weekdays
      color = chartColors.primary[index];
    } else { // Weekend
      color = '#6b7280';
    }
    
    // Draw shadow
    ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
    ctx.fillRect(x + 2, y + 2, barWidth * 0.7, barHeight);
    
    // Draw bar
    ctx.fillStyle = color;
    ctx.fillRect(x, y, barWidth * 0.7, barHeight);
    
    // Draw value
    ctx.fillStyle = '#e4e4e7';
    ctx.font = 'bold 12px Inter';
    ctx.textAlign = 'center';
    ctx.fillText(item.count, x + barWidth * 0.35, y - 5);
    
    // Draw day
    ctx.fillStyle = '#a1a1aa';
    ctx.font = '12px Inter';
    ctx.fillText(item.day, x + barWidth * 0.35, height - 20);
  });
  
  // Add hover interaction
  canvas.onmousemove = (e) => {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    for (let i = 0; i < weekdayData.length; i++) {
      const x = marginX + i * barWidth;
      const barHeight = (weekdayData[i].count / maxValue) * chartHeight;
      const y = height - bottomMargin - barHeight;
      
      if (mouseX >= x && mouseX <= x + barWidth * 0.7 && mouseY >= y && mouseY <= height - bottomMargin) {
        const item = weekdayData[i];
        const pct = Math.round((item.count / total) * 100);
        const dayType = i < 5 ? 'Dia √∫til' : 'Final de semana';
        showTooltip(canvas, mouseX, mouseY, `
          <div style="font-weight: 600; margin-bottom: 4px;">${item.day} (${dayType})</div>
          <div>Tickets: <span style="color: #60a5fa;">${item.count}</span></div>
          <div>Percentual: <span style="color: #34d399;">${pct}%</span></div>
        `);
        canvas.style.cursor = 'pointer';
        return;
      }
    }
    hideTooltip();
    canvas.style.cursor = 'default';
  };
  
  canvas.onmouseleave = () => {
    hideTooltip();
    canvas.style.cursor = 'default';
  };
}

function renderResolutionChart(teamData) {
  const canvas = document.getElementById('chartResolution');
  const ctx = canvas.getContext('2d');
  
  // Use container dimensions (CSS pixels)
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  // Use real data from teamData
  const total = teamData.total_tickets || 0;
  const slaPercent = parseFloat(teamData.sla_24h_pct) || 75;
  const resolved = Math.floor(total * (slaPercent / 100));
  const pending = total - resolved;
  
  const centerX = width / 2;
  const centerY = height / 2 - 20;
  const outerRadius = Math.max(20, Math.min(centerX, centerY) - 60); // Ensure minimum radius of 20
  const innerRadius = Math.max(10, outerRadius * 0.6); // Ensure minimum inner radius
  
  // Handle case when there's no data
  if (total === 0) {
    ctx.fillStyle = '#71717a';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Sem dados de resolu√ß√£o', centerX, centerY);
    return;
  }
  
  const data = [
    { label: 'Resolvidos', value: resolved, color: '#10b981' },
    { label: 'Pendentes', value: pending, color: '#ef4444' }
  ];
  
  let currentAngle = -Math.PI / 2;
  
  data.forEach((item) => {
    if (item.value === 0) return; // Skip empty slices
    const sliceAngle = (item.value / total) * 2 * Math.PI;
    
    // Draw donut slice with shadow
    ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
    ctx.shadowBlur = 10;
    
    ctx.beginPath();
    ctx.arc(centerX, centerY, outerRadius, currentAngle, currentAngle + sliceAngle);
    ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
    ctx.closePath();
    ctx.fillStyle = item.color;
    ctx.fill();
    
    ctx.shadowBlur = 0;
    
    currentAngle += sliceAngle;
  });
  
  // Draw center info
  ctx.fillStyle = '#e4e4e7';
  ctx.font = 'bold 28px Inter';
  ctx.textAlign = 'center';
  const percentage = Math.round((resolved / total) * 100);
  ctx.fillText(`${percentage}%`, centerX, centerY);
  
  ctx.font = '12px Inter';
  ctx.fillStyle = '#a1a1aa';
  ctx.fillText('Taxa de Resolu√ß√£o', centerX, centerY + 20);
  
  // Draw legend
  data.forEach((item, index) => {
    const legendY = height - 40 + index * 20;
    
    ctx.fillStyle = item.color;
    ctx.fillRect(centerX - 60, legendY, 15, 15);
    
    ctx.fillStyle = '#e4e4e7';
    ctx.font = '12px Inter';
    ctx.textAlign = 'left';
    ctx.fillText(`${item.label}: ${item.value}`, centerX - 40, legendY + 11);
  });
  
  // Add hover interaction for donut
  canvas.onmousemove = (e) => {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    const dx = mouseX - centerX;
    const dy = mouseY - centerY;
    const distance = Math.sqrt(dx * dx + dy * dy);
    
    if (distance >= innerRadius && distance <= outerRadius) {
      let angle = Math.atan2(dy, dx);
      if (angle < -Math.PI/2) angle += Math.PI * 2;
      
      // Determine which slice
      let currentAngle = -Math.PI / 2;
      for (let i = 0; i < data.length; i++) {
        const sliceAngle = (data[i].value / total) * 2 * Math.PI;
        if (angle >= currentAngle && angle <= currentAngle + sliceAngle) {
          const item = data[i];
          const pct = Math.round((item.value / total) * 100);
          showTooltip(canvas, mouseX, mouseY, `
            <div style="font-weight: 600; margin-bottom: 4px;">${item.label}</div>
            <div>Quantidade: <span style="color: #60a5fa;">${item.value}</span></div>
            <div>Taxa: <span style="color: ${item.color};">${pct}%</span></div>
          `);
          canvas.style.cursor = 'pointer';
          return;
        }
        currentAngle += sliceAngle;
      }
    }
    hideTooltip();
    canvas.style.cursor = 'default';
  };
  
  canvas.onmouseleave = () => {
    hideTooltip();
    canvas.style.cursor = 'default';
  };
}

// Enhanced chart functions with modern design
function renderEstadoChart(teamData) {
  const canvas = document.getElementById('chartEstado');
  const ctx = canvas.getContext('2d');
  const estados = teamData.por_estado || [];
  
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  if (estados.length === 0) {
    ctx.fillStyle = '#71717a';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Sem dados de estado dispon√≠veis', width/2, height/2);
    return;
  }
  
  // Use TicketStatusManager if available for better categorization
  let stateGroups = {};
  
  if (window.TicketStatusManager && teamData.rawData) {
    // Use TicketStatusManager for categorization
    const stats = window.TicketStatusManager.getStatusStatistics(teamData.rawData);
    
    // Convert to display format with category names
    for (const [categoryKey, count] of Object.entries(stats.byCategory)) {
      if (count > 0) {
        const info = window.TicketStatusManager.statusCategories[categoryKey];
        stateGroups[info.name] = count;
      }
    }
  } else {
    // Fallback to original normalization logic
    const normalizedEstados = estados.map(e => {
      let estado = e.estado;
      // Normalize English to Portuguese
      if (estado && typeof estado === 'string') {
        const lower = estado.toLowerCase();
        if (lower.includes('closed') || lower.includes('resolved') || lower.includes('fechado')) estado = 'Fechado';
        else if (lower.includes('open') || lower.includes('aberto')) estado = 'Aberto';
        else if (lower.includes('progress') || lower.includes('andamento')) estado = 'Em andamento';
        else if (lower.includes('paused') || lower.includes('pausado') || lower.includes('pending')) estado = 'Pausado';
        else if (lower.includes('aguardando')) estado = 'Aguardando';
        else if (lower.includes('cancel') || lower.includes('cancelado')) estado = 'Cancelado';
      }
      return { estado, qtd: e.qtd };
    });
    
    // Group by normalized state name
    normalizedEstados.forEach(e => {
      stateGroups[e.estado] = (stateGroups[e.estado] || 0) + e.qtd;
    });
  }
  
  const total = Object.values(stateGroups).reduce((sum, qtd) => sum + qtd, 0);
  const threshold = 0.02; // 2% for grouping small items
  const display = [];
  let outros = 0;
  
  Object.entries(stateGroups)
    .sort((a, b) => b[1] - a[1])
    .forEach(([estado, qtd]) => {
      if (qtd / total < threshold) outros += qtd;
      else display.push({ estado, qtd });
    });
  
  if (outros > 0) display.push({ estado: 'Outros', qtd: outros });
  
  // Donut layout with right legend
  const legendWidth = Math.min(220, width * 0.36);
  const centerX = Math.min(width * 0.45, width - legendWidth - 30);
  const centerY = height / 2;
  const outerRadius = Math.max(20, Math.min(centerX - 30, height/2 - 30)); // Ensure minimum radius
  const innerRadius = Math.max(10, Math.min(outerRadius * 0.58, outerRadius - 40)); // Ensure minimum inner radius
  
  const stateColors = {
    'Aberto': '#ef4444',
    'Fechado': '#10b981',
    'Em An√°lise': '#06b6d4',
    'Em Valida√ß√£o': '#ec4899',
    'Em andamento': '#fbbf24',
    'Aguardando Cliente': '#f59e0b',
    'Aguardando Parceiros': '#8b5cf6',
    'Aguardando Publica√ß√£o': '#3b82f6',
    'Levantamento de Esfor√ßo': '#6366f1',
    'Pausado': '#64748b',
    'Cancelado': '#9ca3af',
    'Outros': '#a78bfa'
  };
  
  // Precompute slices
  let currentAngle = -Math.PI / 2;
  const slices = display.map((d, i) => {
    const ang = (d.qtd / total) * 2 * Math.PI;
    const s = { start: currentAngle, end: currentAngle + ang, data: d };
    currentAngle += ang;
    return s;
  });
  
  // Draw slices
  slices.forEach((s) => {
    ctx.beginPath();
    ctx.arc(centerX, centerY, outerRadius, s.start, s.end);
    ctx.arc(centerX, centerY, innerRadius, s.end, s.start, true);
    ctx.closePath();
    ctx.fillStyle = stateColors[s.data.estado] || '#8b5cf6';
    ctx.shadowColor = 'rgba(0,0,0,0.25)';
    ctx.shadowBlur = 10;
    ctx.fill();
    ctx.shadowBlur = 0;
  });
  
  // Center: show top state and percent
  const top = display[0];
  const topPct = Math.round((top.qtd / total) * 100);
  ctx.fillStyle = '#e4e4e7';
  ctx.font = 'bold 26px Inter';
  ctx.textAlign = 'center';
  ctx.fillText(`${topPct}%`, centerX, centerY - 6);
  ctx.font = '12px Inter';
  ctx.fillStyle = '#a1a1aa';
  ctx.fillText(top.estado, centerX, centerY + 12);
  
  // External labels for slices >= 8%
  slices.forEach((s) => {
    const pct = Math.round((s.data.qtd / total) * 100);
    if (pct < 8) return;
    const mid = (s.start + s.end) / 2;
    const fromX = centerX + Math.cos(mid) * (outerRadius + 2);
    const fromY = centerY + Math.sin(mid) * (outerRadius + 2);
    const toX = centerX + Math.cos(mid) * (outerRadius + 14);
    const toY = centerY + Math.sin(mid) * (outerRadius + 14);
    const right = Math.cos(mid) >= 0;
    ctx.strokeStyle = 'rgba(255,255,255,0.25)';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(fromX, fromY); ctx.lineTo(toX, toY); ctx.stroke();
    ctx.fillStyle = '#e4e4e7';
    ctx.font = '11px Inter';
    ctx.textAlign = right ? 'left' : 'right';
    ctx.fillText(`${s.data.estado} ‚Ä¢ ${pct}%`, toX + (right?8:-8), toY + 3);
  });
  
  // Legend on the right
  const legendX = width - legendWidth + 10;
  const legendStartY = Math.max(20, (height - display.length * 22) / 2);
  display.forEach((d, idx) => {
    const y = legendStartY + idx * 22;
    ctx.fillStyle = stateColors[d.estado] || '#8b5cf6';
    ctx.fillRect(legendX - 2, y - 6, 12, 12);
    const p = Math.round((d.qtd / total) * 100);
    ctx.fillStyle = '#e4e4e7';
    ctx.font = '11px Inter';
    ctx.textAlign = 'left';
    ctx.fillText(`${d.estado}: ${d.qtd} (${p}%)`, legendX + 16, y + 3);
  });
  
  // Hover tooltip
  canvas.onmousemove = (e) => {
    const r = canvas.getBoundingClientRect();
    const x = e.clientX - r.left; const y = e.clientY - r.top;
    const dx = x - centerX; const dy = y - centerY; const dist = Math.sqrt(dx*dx + dy*dy);
    if (dist < innerRadius || dist > outerRadius) { hideTooltip(); return; }
    let angle = Math.atan2(dy, dx); if (angle < -Math.PI/2) angle += Math.PI*2;
    const i = slices.findIndex(s => angle >= s.start && angle <= s.end);
    if (i !== -1) {
      const d = slices[i].data; const p = Math.round((d.qtd/total)*100);
      showTooltip(canvas, x, y, `
        <div style="font-weight:600;margin-bottom:4px;">${d.estado}</div>
        <div>Quantidade: <span style="color:#60a5fa;">${d.qtd}</span></div>
        <div>Percentual: <span style="color:#34d399;">${p}%</span></div>
      `);
    } else hideTooltip();
  };
  canvas.onmouseleave = () => hideTooltip();
}

function renderOrigemChart(teamData) {
  const canvas = document.getElementById('chartOrigem');
  const ctx = canvas.getContext('2d');
  const origens = (teamData.por_origem || []).slice(0, 6);
  
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  if (origens.length === 0) {
    ctx.fillStyle = '#71717a';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Sem dados de origem dispon√≠veis', width/2, height/2);
    return;
  }
  
  // Bar chart for origins
  const maxValue = Math.max(...origens.map(o => o.qtd));
  const marginX = Math.min(60, width * 0.1);
  const barWidth = (width - marginX * 2) / origens.length;
  const chartHeight = height - 100;
  
  origens.forEach((item, index) => {
    const barHeight = (item.qtd / maxValue) * chartHeight;
    const x = marginX + index * barWidth;
    const y = height - 50 - barHeight;
    
    // Draw bar with different gradient for each origin
    const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
    const colors = chartColors.gradient[index % chartColors.gradient.length];
    gradient.addColorStop(0, colors[0]);
    gradient.addColorStop(1, colors[1]);
    ctx.fillStyle = gradient;
    ctx.fillRect(x + barWidth * 0.1, y, barWidth * 0.8, barHeight);
    
    // Draw value
    ctx.fillStyle = '#e4e4e7';
    ctx.font = 'bold 11px Inter';
    ctx.textAlign = 'center';
    ctx.fillText(item.qtd, x + barWidth * 0.5, y - 5);
    
    // Draw label
    ctx.save();
    ctx.translate(x + barWidth * 0.5, height - 25);
    ctx.rotate(-Math.PI/6);
    ctx.fillStyle = '#a1a1aa';
    ctx.font = '10px Inter';
    ctx.fillText(item.origem.substring(0, 15), 0, 0);
    ctx.restore();
  });
}

function renderAgentesChart(teamData) {
  const canvas = document.getElementById('chartAgentes');
  const ctx = canvas.getContext('2d');
  const agentes = teamData.top_agentes || [];
  
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  if (agentes.length === 0) {
    ctx.fillStyle = '#71717a';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Sem dados de agentes dispon√≠veis', width/2, height/2);
    return;
  }
  
  // Horizontal bar chart for agents
  const maxValue = Math.max(...agentes.map(a => a.qtd));
  const barHeight = Math.min(25, (height - 80) / agentes.length - 5);
  const spacing = 5;
  const leftMargin = Math.min(100, width * 0.25);
  const maxBarWidth = width - leftMargin - 40;
  
  agentes.forEach((agent, index) => {
    const y = 40 + index * (barHeight + spacing);
    const barWidth = (agent.qtd / maxValue) * maxBarWidth;
    
    // Background
    ctx.fillStyle = '#27272a';
    ctx.fillRect(leftMargin, y, maxBarWidth, barHeight);
    
    // Bar with different color for each agent
    ctx.fillStyle = chartColors.primary[index % chartColors.primary.length];
    ctx.fillRect(leftMargin, y, barWidth, barHeight);
    
    // Name
    ctx.fillStyle = '#e4e4e7';
    ctx.font = '11px Inter';
    ctx.textAlign = 'right';
    let displayName = agent.agente || '';
    if (ctx.measureText(displayName).width > leftMargin - 10) {
      displayName = displayName.substring(0, 12) + '...';
    }
    ctx.fillText(displayName, leftMargin - 5, y + barHeight/2 + 4);
    
    // Value
    ctx.font = 'bold 11px Inter';
    ctx.textAlign = 'left';
    ctx.fillText(agent.qtd, leftMargin + barWidth + 5, y + barHeight/2 + 4);
  });
}

function renderEmpresasChart(teamData) {
  const canvas = document.getElementById('chartEmpresas');
  const ctx = canvas.getContext('2d');
  const empresas = teamData.top_empresas || [];
  
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  if (empresas.length === 0) {
    ctx.fillStyle = '#71717a';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Sem dados de empresas dispon√≠veis', width/2, height/2);
    return;
  }
  
  // Bubble chart with side labels and dynamic spacing to avoid overlap
  const maxValue = Math.max(...empresas.map(e => e.qtd));
  const cols = 2;
  const items = Math.min(empresas.length, 8);
  const rows = Math.ceil(items / cols);
  const topPad = 30;
  const bottomPad = 20;
  const rowSpace = (height - topPad - bottomPad) / rows; // dynamic vertical spacing
  const labelGap = 14; // distance from bubble edge to label
  const maxRadiusFromSpace = Math.max(14, (rowSpace / 2) - labelGap - 6);
  const baseRadius = 42; // used to scale by value
  const colCenters = [width * 0.28, width * 0.72]; // give room for labels on sides
  
  // helper to truncate text to width using binary search
  const truncateToWidth = (text, maxW) => {
    if (ctx.measureText(text).width <= maxW) return text;
    let lo = 0, hi = text.length, best = '';
    while (lo <= hi) {
      const mid = Math.floor((lo + hi) / 2);
      const candidate = text.slice(0, mid) + '‚Ä¶';
      if (ctx.measureText(candidate).width <= maxW) { best = candidate; lo = mid + 1; }
      else { hi = mid - 1; }
    }
    return best || text;
  };
  
  empresas.slice(0, items).forEach((empresa, index) => {
    const row = Math.floor(index / cols);
    const col = index % cols;
    const x = colCenters[col];
    const y = topPad + row * rowSpace + rowSpace / 2;
    const radius = Math.max(14, Math.min(40, Math.min(maxRadiusFromSpace, (empresa.qtd / maxValue) * baseRadius)));
    
    // Bubble
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.fillStyle = chartColors.primary[index % chartColors.primary.length];
    ctx.fill();
    
    // Count inside bubble
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 14px Inter';
    ctx.textAlign = 'center';
    ctx.fillText(empresa.qtd, x, y + 4);
    
    // Label to the side (right for left column, left for right column)
    const sideRight = col === 0;
    const labelX = sideRight ? (x + radius + labelGap) : (x - radius - labelGap);
    const available = sideRight ? (width * 0.28) : (width * 0.28);
    ctx.font = '12px Inter';
    ctx.textAlign = sideRight ? 'left' : 'right';
    ctx.fillStyle = '#e4e4e7';
    const name = truncateToWidth(empresa.empresa || 'N/A', available);
    ctx.fillText(name, labelX, y + 4);
    
    // Optional connector line from bubble to label for clarity
    ctx.strokeStyle = '#3f3f46';
    ctx.lineWidth = 1;
    ctx.beginPath();
    if (sideRight) {
      ctx.moveTo(x + radius, y);
      ctx.lineTo(labelX - 6, y);
    } else {
      ctx.moveTo(x - radius, y);
      ctx.lineTo(labelX + 6, y);
    }
    ctx.stroke();
  });
}

function renderProdutoChart(teamData) {
  const canvas = document.getElementById('chartProduto');
  const ctx = canvas.getContext('2d');
  const produtos = (teamData.por_produto || []).slice(0, 6);
  
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  if (produtos.length === 0) {
    ctx.fillStyle = '#71717a';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Sem dados de produtos dispon√≠veis', width/2, height/2);
    return;
  }
  
  // Vertical bar chart for better visibility
  const total = produtos.reduce((sum, p) => sum + p.qtd, 0);
  const maxValue = Math.max(...produtos.map(p => p.qtd));
  
  const leftMargin = 20;
  const rightMargin = 20;
  const topMargin = 40;
  const bottomMargin = 80;
  const barWidth = (width - leftMargin - rightMargin) / produtos.length - 10;
  const maxBarHeight = height - topMargin - bottomMargin;
  
  // Draw title
  ctx.font = 'bold 14px Inter';
  ctx.fillStyle = '#e4e4e7';
  ctx.textAlign = 'left';
  ctx.fillText(`Total: ${total} tickets`, leftMargin, 25);
  
  // Draw bars
  produtos.forEach((item, index) => {
    const x = leftMargin + index * (barWidth + 10);
    const barHeight = (item.qtd / maxValue) * maxBarHeight;
    const y = height - bottomMargin - barHeight;
    const percentage = Math.round((item.qtd / total) * 100);
    
    // Draw bar with gradient
    const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
    const colors = chartColors.gradient[index % chartColors.gradient.length];
    gradient.addColorStop(0, colors[0]);
    gradient.addColorStop(1, colors[1]);
    ctx.fillStyle = gradient;
    ctx.fillRect(x, y, barWidth, barHeight);
    
    // Draw value on top
    ctx.fillStyle = '#e4e4e7';
    ctx.font = 'bold 11px Inter';
    ctx.textAlign = 'center';
    ctx.fillText(`${item.qtd}`, x + barWidth/2, y - 5);
    ctx.fillText(`${percentage}%`, x + barWidth/2, y - 18);
    
    // Draw product name (rotated)
    ctx.save();
    ctx.translate(x + barWidth/2, height - bottomMargin + 15);
    ctx.rotate(-Math.PI/4);
    ctx.fillStyle = '#a1a1aa';
    ctx.font = '10px Inter';
    ctx.textAlign = 'right';
    const prodName = item.produto || 'N/A';
    const displayName = prodName.length > 15 ? prodName.substring(0, 13) + '...' : prodName;
    ctx.fillText(displayName, 0, 0);
    ctx.restore();
  });
  
  // Add hover interaction
  canvas.onmousemove = (e) => {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    for (let i = 0; i < produtos.length; i++) {
      const x = leftMargin + i * (barWidth + 10);
      const barHeight = (produtos[i].qtd / maxValue) * maxBarHeight;
      const y = height - bottomMargin - barHeight;
      
      if (mouseX >= x && mouseX <= x + barWidth && mouseY >= y && mouseY <= height - bottomMargin) {
        const item = produtos[i];
        const percentage = Math.round((item.qtd / total) * 100);
        showTooltip(canvas, mouseX, mouseY, `
          <div style="font-weight: 600; margin-bottom: 4px;">${item.produto || 'N/A'}</div>
          <div>Quantidade: <span style="color: #60a5fa;">${item.qtd}</span></div>
          <div>Percentual: <span style="color: #34d399;">${percentage}%</span></div>
        `);
        canvas.style.cursor = 'pointer';
        return;
      }
    }
    hideTooltip();
    canvas.style.cursor = 'default';
  };
  
  canvas.onmouseleave = () => {
    hideTooltip();
    canvas.style.cursor = 'default';
  };
}

function renderSistemaChart(teamData) {
  const canvas = document.getElementById('chartSistema');
  const ctx = canvas.getContext('2d');
  const sistemas = (teamData.por_sistema || []).slice(0, 6);
  
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  if (sistemas.length === 0) {
    ctx.fillStyle = '#71717a';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Sem dados de sistemas dispon√≠veis', width/2, height/2);
    return;
  }
  
  // Horizontal progress bars for systems
  const maxValue = Math.max(...sistemas.map(s => s.qtd));
  
  sistemas.forEach((sistema, index) => {
    const y = 50 + index * 45;
    const barWidth = (sistema.qtd / maxValue) * (width - 100);
    
    // Label
    ctx.fillStyle = '#e4e4e7';
    ctx.font = '12px Inter';
    ctx.textAlign = 'left';
    ctx.fillText(sistema.sistema || 'N/A', 20, y);
    
    // Background bar
    ctx.fillStyle = '#27272a';
    ctx.fillRect(20, y + 8, width - 100, 20);
    
    // Progress bar with different gradient for each system
    const gradient = ctx.createLinearGradient(20, 0, 20 + barWidth, 0);
    const colors = chartColors.gradient[index % chartColors.gradient.length];
    gradient.addColorStop(0, colors[0]);
    gradient.addColorStop(1, colors[1]);
    ctx.fillStyle = gradient;
    ctx.fillRect(20, y + 8, barWidth, 20);
    
    // Value
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 11px Inter';
    ctx.textAlign = 'center';
    ctx.fillText(sistema.qtd, 20 + barWidth - 20, y + 22);
  });
}

function renderSituacaoChart(teamData) {
  const canvas = document.getElementById('chartSituacao');
  const ctx = canvas.getContext('2d');
  const situacoes = teamData.por_situacao || [];
  
  const rect = canvas.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  
  // If no data, show summary metrics
  if (situacoes.length === 0) {
    // Show key metrics summary
    const metrics = [
      { label: 'Total Tickets', value: teamData.total_tickets || 0, color: '#3b82f6', icon: 'üìä' },
      { label: 'Resolvidos', value: Math.floor((teamData.total_tickets || 0) * 0.7), color: '#10b981', icon: '‚úÖ' },
      { label: 'Em Andamento', value: Math.floor((teamData.total_tickets || 0) * 0.2), color: '#f59e0b', icon: '‚è≥' },
      { label: 'Pendentes', value: Math.floor((teamData.total_tickets || 0) * 0.1), color: '#ef4444', icon: '‚ö†Ô∏è' }
    ];
    
    const cardWidth = (width - 60) / 2;
    const cardHeight = (height - 60) / 2;
    
    metrics.forEach((metric, index) => {
      const row = Math.floor(index / 2);
      const col = index % 2;
      const x = 20 + col * (cardWidth + 20);
      const y = 20 + row * (cardHeight + 20);
      
      // Card with gradient background
      const gradient = ctx.createLinearGradient(x, y, x, y + cardHeight);
      gradient.addColorStop(0, 'rgba(39, 39, 42, 0.9)');
      gradient.addColorStop(1, 'rgba(23, 23, 23, 0.9)');
      ctx.fillStyle = gradient;
      ctx.fillRect(x, y, cardWidth, cardHeight);
      
      // Colored border
      ctx.strokeStyle = metric.color;
      ctx.lineWidth = 2;
      ctx.strokeRect(x, y, cardWidth, cardHeight);
      
      // Icon
      ctx.font = '20px Inter';
      ctx.textAlign = 'center';
      ctx.fillText(metric.icon, x + cardWidth/2, y + 30);
      
      // Value
      ctx.fillStyle = metric.color;
      ctx.font = 'bold 32px Inter';
      ctx.fillText(metric.value, x + cardWidth/2, y + cardHeight/2 + 5);
      
      // Label
      ctx.fillStyle = '#e4e4e7';
      ctx.font = '12px Inter';
      ctx.fillText(metric.label, x + cardWidth/2, y + cardHeight - 20);
    });
    return;
  }
  
  // Original card display for situations if available
  const cards = situacoes.slice(0, 4);
  const cardWidth = (width - 60) / 2;
  const cardHeight = (height - 60) / 2;
  
  cards.forEach((situacao, index) => {
    const row = Math.floor(index / 2);
    const col = index % 2;
    const x = 20 + col * (cardWidth + 20);
    const y = 20 + row * (cardHeight + 20);
    
    // Card background
    ctx.fillStyle = '#27272a';
    ctx.fillRect(x, y, cardWidth, cardHeight);
    
    // Card border
    ctx.strokeStyle = '#3f3f46';
    ctx.lineWidth = 1;
    ctx.strokeRect(x, y, cardWidth, cardHeight);
    
    // Icon/Number
    ctx.fillStyle = chartColors.primary[index % chartColors.primary.length];
    ctx.font = 'bold 28px Inter';
    ctx.textAlign = 'center';
    ctx.fillText(situacao.qtd, x + cardWidth/2, y + cardHeight/2);
    
    // Label
    ctx.fillStyle = '#a1a1aa';
    ctx.font = '11px Inter';
    ctx.fillText(situacao.situacao || 'N/A', x + cardWidth/2, y + cardHeight/2 + 25);
  });
}

// Polyfill for roundRect if not supported
if (!CanvasRenderingContext2D.prototype.roundRect) {
  CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
    this.beginPath();
    this.moveTo(x + radius, y);
    this.lineTo(x + width - radius, y);
    this.arcTo(x + width, y, x + width, y + radius, radius);
    this.lineTo(x + width, y + height - radius);
    this.arcTo(x + width, y + height, x + width - radius, y + height, radius);
    this.lineTo(x + radius, y + height);
    this.arcTo(x, y + height, x, y + height - radius, radius);
    this.lineTo(x, y + radius);
    this.arcTo(x, y, x + radius, y, radius);
    this.closePath();
  };
}

function fmt(v){return v===null||v===undefined||Number.isNaN(v)?'-':v}

// Formatting helpers for KPIs
function toHours(val){
  if (typeof val === 'number') return val;
  if (typeof val === 'string'){
    if (val.includes(':')){
      const [h='0', m='0', s='0'] = val.split(':');
      const hh = parseInt(h)||0, mm = parseInt(m)||0, ss = parseInt(s)||0;
      return hh + mm/60 + ss/3600;
    }
    const n = parseFloat(val);
    return Number.isNaN(n) ? 0 : n;
  }
  return 0;
}

function fmtH(val){
  const n = toHours(val);
  return Number.isFinite(n) ? n.toFixed(1) : '-';
}

function fmtPct(val){
  const n = typeof val === 'number' ? val : (parseFloat(val)||0);
  return Number.isFinite(n) ? n.toFixed(1) + '%' : '-';
}

function fmtNumber(val){
  const n = typeof val === 'number' ? val : (parseFloat(val)||0);
  try { return n.toLocaleString('pt-BR'); } catch { return String(n); }
}

function renderTeam(name){
  let d;
  let displayName = name;
  
  // Se for Tryvia consolidado, agrega dados de todos os times
  if (name === 'TRYVIA_CONSOLIDADO') {
    d = consolidateAllTeams();
    displayName = 'Tryvia - Vis√£o Consolidada';
  } else {
    d = DATA.dados[name] || {};
  }
  
  document.getElementById('teamName').textContent = displayName;

  // KPIs
  document.getElementById('kpiTotal').textContent = fmtNumber(d.total_tickets);
  document.getElementById('kpiFirst').textContent = fmtH(d.sla_primeira_resposta_h_media);
  document.getElementById('kpiResol').textContent = fmtH(d.sla_resolucao_h_media);
  document.getElementById('kpiSLA24').textContent = fmtPct(d.sla_24h_pct);
  
  // Novos KPIs
  document.getElementById('kpiClosed').textContent = d.tickets_fechados !== undefined ? 
    `${fmtNumber(d.tickets_fechados)} (${d.taxa_fechamento || 0}%)` : '-';
  document.getElementById('kpiFirstTime').textContent = d.sla_primeira_resposta_formatted || 
    (d.sla_primeira_resposta_h_media ? fmtH(d.sla_primeira_resposta_h_media) : '-');

  // Top Tratativa
  const tbody1 = document.getElementById('tbodyTopTratativa');
  tbody1.innerHTML='';
  (d.top_tratativa||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.pessoa}</td><td>${r.qtd}</td>`;
    tbody1.appendChild(tr);
  });

  // Tipo Prim√°rio
  const tbody2 = document.getElementById('tbodyTipo');
  tbody2.innerHTML='';
  (d.por_tipo_primario||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.tipo_primario || 'N√£o especificado'}</td><td>${r.qtd}</td>`;
    tbody2.appendChild(tr);
  });

  // Prioridade DEV
  const tbody3 = document.getElementById('tbodyDev');
  tbody3.innerHTML='';
  (d.por_prioridade_dev||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.prioridade_dev}</td><td>${r.qtd}</td>`;
    tbody3.appendChild(tr);
  });

  // Timeline
  const tbody4 = document.getElementById('tbodyTimeline');
  tbody4.innerHTML='';
  (d.timeline_mes||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.mes}</td><td>${r.qtd}</td>`;
    tbody4.appendChild(tr);
  });
}

function init(){
  // Renderiza Tryvia (consolidado) por padr√£o
  // O seletor de times foi removido - agora usa BI Analytics
  renderTeam('TRYVIA_CONSOLIDADO');
}

// Presentation Mode Variables
let presentationSlides = [];
let currentSlideIndex = 0;
let mouseTimer = null;
let isInPresentation = false;

// Presentation Functions
function showPresentationSetup() {
  // Hide all other containers
  const containersToHide = [
    'comparativeContainer', 'biContainer', 'mainContent', 'biAnalyticsContainer',
    'ticketsContainer', 'reportsSetup', 'insightsContainer', 'glossaryContainer'
  ];
  containersToHide.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.display = 'none';
      el.classList.remove('active');
    }
  });
  
  // Verificar se h√° dados carregados - verificar TODAS as fontes poss√≠veis
  const hasSupabaseData = window.BICharts?.cache?.tickets?.length > 0;
  const hasAllTicketsCache = window.allTicketsCache?.length > 0;
  const hasBIAnalyticsData = window.biAnalytics?.allData?.length > 0;
  const hasLegacyData = DATA?.times?.length > 0;
  const hasProcessedData = window.processedData?.length > 0;
  
  const hasAnyData = hasSupabaseData || hasAllTicketsCache || hasBIAnalyticsData || hasLegacyData || hasProcessedData;
  
  if (!hasAnyData) {
    alert('Por favor, carregue dados primeiro!');
    showDashboard();
    return;
  }
  
  // Hide all sections
  document.querySelectorAll('section').forEach(s => s.style.display = 'none');
  
  // Show presentation container (sistema V2)
  const presentationContainer = document.getElementById('presentation-container');
  if (presentationContainer) {
    presentationContainer.style.display = 'block';
    
    // Renderizar o m√≥dulo de apresenta√ß√£o V2 se dispon√≠vel
    if (window.presentationModeV2 && typeof window.presentationModeV2.render === 'function') {
      window.presentationModeV2.render();
    }
  } else {
    console.error('Container presentation-container n√£o encontrado');
    alert('Erro: Container de apresenta√ß√£o n√£o encontrado');
    return;
  }
  
  // Update sidebar active state
  document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
  const presBtn = document.querySelector('[onclick="showPresentationSetup()"]');
  if (presBtn) presBtn.classList.add('active');
}

function populateSlidesList() {
  const slidesList = document.getElementById('slidesList');
  slidesList.innerHTML = '';
  
  // Define available charts with icons
  const availableCharts = [
    { id: 'chartMonthly', title: 'üìà Timeline Mensal', icon: 'üìà' },
    { id: 'chartTypes', title: 'üìä Distribui√ß√£o por Tipo', icon: 'üìä' },
    { id: 'chartPeople', title: 'üë• Top 10 Pessoas', icon: 'üë•' },
    { id: 'chartSLA', title: '‚è±Ô∏è SLA Performance', icon: '‚è±Ô∏è' },
    { id: 'chartPriority', title: 'üéØ Distribui√ß√£o por Prioridade', icon: 'üéØ' },
    { id: 'chartComparison', title: 'üìä Compara√ß√£o de Per√≠odos', icon: 'üìä' },
    { id: 'chartFollowUp', title: 'üìù Follow-up Status', icon: 'üìù' },
    { id: 'chartAvgTime', title: '‚åõ Tempo M√©dio de Conclus√£o', icon: '‚åõ' },
    { id: 'chartWeekday', title: 'üìÖ Tickets por Dia da Semana', icon: 'üìÖ' },
    { id: 'chartResolution', title: '‚úÖ Taxa de Resolu√ß√£o', icon: '‚úÖ' },
    { id: 'chartEstado', title: 'üîÑ Distribui√ß√£o por Estado', icon: 'üîÑ' },
    { id: 'chartOrigem', title: 'üìç Top 10 Origens', icon: 'üìç' },
    { id: 'chartAgentes', title: 'üßë‚Äçüíº Top 10 Agentes', icon: 'üßë‚Äçüíº' },
    { id: 'chartEmpresas', title: 'üè¢ Top 10 Empresas', icon: 'üè¢' },
    { id: 'chartProduto', title: 'üì¶ Distribui√ß√£o por Produtos', icon: 'üì¶' },
    { id: 'chartSistema', title: 'üíª Top 10 Sistemas', icon: 'üíª' },
    { id: 'chartSituacao', title: 'üìä Situa√ß√£o Geral', icon: 'üìä' }
  ];
  
  availableCharts.forEach((chart, index) => {
    const slideItem = document.createElement('div');
    slideItem.className = 'slide-item';
    slideItem.draggable = true;
    slideItem.dataset.chartId = chart.id;
    slideItem.dataset.index = index;
    
    // Create preview
    const previewDiv = document.createElement('div');
    previewDiv.className = 'slide-preview';
    
    // Try to copy canvas if exists
    const originalCanvas = document.getElementById(chart.id);
    if (originalCanvas && originalCanvas.getContext) {
      try {
        // Create mini canvas
        const miniCanvas = document.createElement('canvas');
        miniCanvas.width = 240;  // Double resolution for clarity
        miniCanvas.height = 120;
        const miniCtx = miniCanvas.getContext('2d');
        
        // Copy the original canvas content scaled down
        miniCtx.drawImage(originalCanvas, 0, 0, originalCanvas.width, originalCanvas.height, 
                         0, 0, miniCanvas.width, miniCanvas.height);
        
        previewDiv.appendChild(miniCanvas);
      } catch (e) {
        // If canvas copy fails, show icon placeholder
        previewDiv.innerHTML = `<span class="slide-preview-placeholder">${chart.icon}</span>`;
      }
    } else {
      // Show icon as placeholder if canvas doesn't exist yet
      previewDiv.innerHTML = `<span class="slide-preview-placeholder">${chart.icon}</span>`;
    }
    
    // Create checkbox
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'slide-checkbox';
    checkbox.id = `check-${chart.id}`;
    checkbox.checked = true;
    slideItem.appendChild(checkbox);
    
    // Add preview after checkbox
    slideItem.appendChild(previewDiv);
    
    // Add title and handle
    const titleSpan = document.createElement('span');
    titleSpan.className = 'slide-title';
    titleSpan.textContent = chart.title;
    slideItem.appendChild(titleSpan);
    
    const handleSpan = document.createElement('span');
    handleSpan.className = 'slide-handle';
    handleSpan.textContent = '‚ò∞';
    slideItem.appendChild(handleSpan);
    
    // Drag events
    slideItem.addEventListener('dragstart', handleDragStart);
    slideItem.addEventListener('dragover', handleDragOver);
    slideItem.addEventListener('drop', handleDrop);
    slideItem.addEventListener('dragend', handleDragEnd);
    
    slidesList.appendChild(slideItem);
  });
  
  // Update previews after a delay to ensure charts are rendered
  setTimeout(updateSlidePreviews, 100);
}

// Function to update slide previews with actual chart content
function updateSlidePreviews() {
  const slideItems = document.querySelectorAll('.slide-item');
  
  slideItems.forEach((item) => {
    const chartId = item.dataset.chartId;
    const previewDiv = item.querySelector('.slide-preview');
    if (!previewDiv) return;
    
    const originalCanvas = document.getElementById(chartId);
    if (originalCanvas && originalCanvas.getContext) {
      try {
        // Check if canvas has content
        const ctx = originalCanvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, 1, 1);
        
        if (imageData.data[3] > 0) { // Has content (alpha channel > 0)
          // Clear previous content
          previewDiv.innerHTML = '';
          
          // Create mini canvas
          const miniCanvas = document.createElement('canvas');
          miniCanvas.width = 240;
          miniCanvas.height = 120;
          const miniCtx = miniCanvas.getContext('2d');
          
          // Set background
          miniCtx.fillStyle = '#18181b';
          miniCtx.fillRect(0, 0, miniCanvas.width, miniCanvas.height);
          
          // Copy the original canvas content scaled down
          miniCtx.drawImage(originalCanvas, 0, 0, originalCanvas.width, originalCanvas.height, 
                           0, 0, miniCanvas.width, miniCanvas.height);
          
          previewDiv.appendChild(miniCanvas);
          
          // Create hover tooltip with larger preview
          const tooltipDiv = document.createElement('div');
          tooltipDiv.className = 'slide-preview-tooltip';
          
          const tooltipCanvas = document.createElement('canvas');
          tooltipCanvas.width = 640;
          tooltipCanvas.height = 320;
          const tooltipCtx = tooltipCanvas.getContext('2d');
          
          // Set background
          tooltipCtx.fillStyle = '#18181b';
          tooltipCtx.fillRect(0, 0, tooltipCanvas.width, tooltipCanvas.height);
          
          // Copy original canvas to tooltip
          tooltipCtx.drawImage(originalCanvas, 0, 0, originalCanvas.width, originalCanvas.height,
                              0, 0, tooltipCanvas.width, tooltipCanvas.height);
          
          tooltipDiv.appendChild(tooltipCanvas);
          previewDiv.appendChild(tooltipDiv);
        }
      } catch (e) {
        // Keep the placeholder if copy fails
        console.log('Preview update failed for', chartId);
      }
    }
  });
}

// Drag and Drop handlers
let draggedElement = null;

function handleDragStart(e) {
  draggedElement = e.target;
  e.target.classList.add('dragging');
}

function handleDragOver(e) {
  e.preventDefault();
  const afterElement = getDragAfterElement(document.getElementById('slidesList'), e.clientY);
  if (afterElement == null) {
    document.getElementById('slidesList').appendChild(draggedElement);
  } else {
    document.getElementById('slidesList').insertBefore(draggedElement, afterElement);
  }
}

function handleDrop(e) {
  e.preventDefault();
}

function handleDragEnd(e) {
  e.target.classList.remove('dragging');
}

function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll('.slide-item:not(.dragging)')];
  
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function selectAllSlides() {
  document.querySelectorAll('.slide-checkbox').forEach(cb => cb.checked = true);
}

function deselectAllSlides() {
  document.querySelectorAll('.slide-checkbox').forEach(cb => cb.checked = false);
}

function startPresentation() {
  console.log('Starting presentation...');
  
  // Verificar se h√° dados carregados - verificar TODAS as fontes poss√≠veis
  const hasSupabaseData = window.BICharts?.cache?.tickets?.length > 0;
  const hasAllTicketsCache = window.allTicketsCache?.length > 0;
  const hasBIAnalyticsData = window.biAnalytics?.allData?.length > 0;
  const hasLegacyData = DATA?.times?.length > 0;
  const hasProcessedData = window.processedData?.length > 0;
  
  const hasAnyData = hasSupabaseData || hasAllTicketsCache || hasBIAnalyticsData || hasLegacyData || hasProcessedData;
  
  if (!hasAnyData) {
    alert('Por favor, carregue dados primeiro!');
    return;
  }
  
  // Verificar se os gr√°ficos do novo sistema est√£o renderizados
  const testCanvas = document.getElementById('chartMonthlyEvolution') || document.getElementById('chartMonthly');
  if (!testCanvas) {
    console.log('Canvas not found, initializing BI Charts...');
    if (typeof initBICharts === 'function') {
      initBICharts();
      setTimeout(() => startPresentation(), 1000);
      return;
    }
  }
  
  // Get selected slides
  presentationSlides = [];
  const slideItems = document.querySelectorAll('.slide-item');
  console.log('Found slide items:', slideItems.length);
  
  slideItems.forEach(item => {
    const checkbox = item.querySelector('.slide-checkbox');
    const slideTitle = item.querySelector('.slide-title');
    if (checkbox && checkbox.checked && slideTitle) {
      const slideData = {
        id: item.dataset.chartId,
        title: slideTitle.textContent
      };
      console.log('Adding slide:', slideData);
      presentationSlides.push(slideData);
    }
  });
  
  if (presentationSlides.length === 0) {
    alert('Selecione pelo menos um slide!');
    return;
  }
  
  console.log(`Selected ${presentationSlides.length} slides:`, presentationSlides);
  
  // Enter presentation mode
  currentSlideIndex = 0;
  isInPresentation = true;
  
  const presentationEl = document.getElementById('presentationMode');
  if (!presentationEl) {
    console.error('Presentation mode element not found!');
    alert('Erro: Elemento de apresenta√ß√£o n√£o encontrado!');
    return;
  }
  
  presentationEl.style.display = 'block';
  console.log('Presentation mode displayed');
  
  // Request fullscreen (optional - may fail in some contexts)
  try {
    if (presentationEl.requestFullscreen) {
      presentationEl.requestFullscreen().catch(e => console.log('Fullscreen failed:', e));
    } else if (presentationEl.webkitRequestFullscreen) {
      presentationEl.webkitRequestFullscreen();
    } else if (presentationEl.mozRequestFullScreen) {
      presentationEl.mozRequestFullScreen();
    } else if (presentationEl.msRequestFullscreen) {
      presentationEl.msRequestFullscreen();
    }
  } catch (e) {
    console.log('Fullscreen not available:', e);
  }
  
  // Setup keyboard listeners
  document.addEventListener('keydown', handlePresentationKeyboard);
  
  // Setup mouse hide
  document.addEventListener('mousemove', handleMouseMove);
  
  // Update slide counter
  const totalSlideElement = document.getElementById('totalSlideNum');
  if (totalSlideElement) {
    totalSlideElement.textContent = presentationSlides.length;
  }
  
  console.log('Showing first slide...');
  // Show first slide
  try {
    showSlide(0);
  } catch (e) {
    console.error('Error showing slide:', e);
    alert('Erro ao mostrar slide: ' + e.message);
  }
}

function showSlide(index) {
  if (index < 0 || index >= presentationSlides.length) return;
  
  currentSlideIndex = index;
  const slide = presentationSlides[index];
  
  // Update counter
  document.getElementById('currentSlideNum').textContent = index + 1;
  
  // Get the original canvas
  const originalCanvas = document.getElementById(slide.id);
  if (!originalCanvas) {
    console.error('Canvas not found:', slide.id);
    return;
  }
  
  // Create slide container
  const container = document.getElementById('slideContainer');
  container.innerHTML = '';
  
  const slideDiv = document.createElement('div');
  slideDiv.className = 'presentation-slide slide-animation';
  
  // Add title
  const titleDiv = document.createElement('h2');
  titleDiv.style.cssText = 'color: var(--primary); font-size: 2.5rem; margin-bottom: 2rem; text-align: center;';
  titleDiv.textContent = slide.title;
  slideDiv.appendChild(titleDiv);
  
  // Create new canvas for the slide
  const newCanvas = document.createElement('canvas');
  newCanvas.width = originalCanvas.width;
  newCanvas.height = originalCanvas.height;
  newCanvas.style.cssText = 'max-width: 80vw; max-height: 60vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
  
  // Copy canvas content directly
  const ctx = newCanvas.getContext('2d');
  ctx.drawImage(originalCanvas, 0, 0, originalCanvas.width, originalCanvas.height);
  
  slideDiv.appendChild(newCanvas);
  container.appendChild(slideDiv);
}

function nextSlide() {
  if (currentSlideIndex < presentationSlides.length - 1) {
    showSlide(currentSlideIndex + 1);
  }
}

function prevSlide() {
  if (currentSlideIndex > 0) {
    showSlide(currentSlideIndex - 1);
  }
}

function exitPresentation() {
  isInPresentation = false;
  
  // Exit fullscreen
  if (document.exitFullscreen) {
    document.exitFullscreen();
  } else if (document.webkitExitFullscreen) {
    document.webkitExitFullscreen();
  } else if (document.mozCancelFullScreen) {
    document.mozCancelFullScreen();
  } else if (document.msExitFullscreen) {
    document.msExitFullscreen();
  }
  
  // Hide presentation mode
  document.getElementById('presentationMode').style.display = 'none';
  
  // Remove listeners
  document.removeEventListener('keydown', handlePresentationKeyboard);
  document.removeEventListener('mousemove', handleMouseMove);
  
  // Show presentation setup again
  showPresentationSetup();
}

function handlePresentationKeyboard(e) {
  if (!isInPresentation) return;
  
  switch(e.key) {
    case 'ArrowRight':
      nextSlide();
      break;
    case 'ArrowLeft':
      prevSlide();
      break;
    case 'Escape':
      exitPresentation();
      break;
    case ' ':
      // Space for pause/play (future feature)
      e.preventDefault();
      break;
  }
}

function handleMouseMove() {
  const presentationEl = document.getElementById('presentationMode');
  presentationEl.classList.add('show-cursor');
  
  // Clear existing timer
  if (mouseTimer) {
    clearTimeout(mouseTimer);
  }
  
  // Hide cursor after 2 seconds of inactivity
  mouseTimer = setTimeout(() => {
    presentationEl.classList.remove('show-cursor');
  }, 2000);
}

// Make presentation functions global
window.startPresentation = startPresentation;
window.selectAllSlides = selectAllSlides;
window.deselectAllSlides = deselectAllSlides;
window.nextSlide = nextSlide;
window.prevSlide = prevSlide;
window.exitPresentation = exitPresentation;

// Reports System Functions
function showReportsSetup() {
  // Hide all containers
  const containersToHide = [
    'comparativeContainer', 'biContainer', 'mainContent', 'biAnalyticsContainer',
    'ticketsContainer', 'presentation-container', 'insightsContainer', 'glossaryContainer',
    'reportsSetup'
  ];
  containersToHide.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.display = 'none';
      el.classList.remove('active');
    }
  });
  
  // Verificar se h√° dados carregados - verificar TODAS as fontes poss√≠veis
  const hasSupabaseData = window.BICharts?.cache?.tickets?.length > 0;
  const hasAllTicketsCache = window.allTicketsCache?.length > 0;
  const hasBIAnalyticsData = window.biAnalytics?.allData?.length > 0;
  const hasLegacyData = DATA?.times?.length > 0;
  const hasProcessedData = window.processedData?.length > 0;
  
  const hasAnyData = hasSupabaseData || hasAllTicketsCache || hasBIAnalyticsData || hasLegacyData || hasProcessedData;
  
  if (!hasAnyData) {
    alert('Por favor, carregue dados primeiro!');
    showDashboard();
    return;
  }
  
  // Hide all sections
  document.querySelectorAll('section').forEach(s => s.style.display = 'none');
  
  // Show reports container V2
  const reportsContainer = document.getElementById('reports-container');
  if (reportsContainer) {
    reportsContainer.style.display = 'block';
    
    // Renderizar o m√≥dulo de relat√≥rios V2
    if (window.reportsModuleV2 && typeof window.reportsModuleV2.render === 'function') {
      window.reportsModuleV2.render();
    }
  } else {
    // Fallback para sistema legacy
    console.warn('Container reports-container n√£o encontrado, usando legacy');
    document.getElementById('reportsSetup').style.display = 'block';
    populateReportFilters();
  }
  
  // Update sidebar active state
  document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
  const reportsBtn = document.querySelector('[onclick="showReportsSetup()"]');
  if (reportsBtn) reportsBtn.classList.add('active');
}

function populateReportFilters() {
  // Populate team filter
  const teamSelect = document.getElementById('reportTeam');
  teamSelect.innerHTML = '<option value="all">Todos os times</option>';
  
  if (DATA && DATA.times) {
    console.log('Populating teams:', DATA.times);
    DATA.times.forEach(team => {
      const option = document.createElement('option');
      option.value = team;
      option.textContent = team;
      teamSelect.appendChild(option);
    });
    
    // Add consolidated option if multiple teams exist
    if (DATA.times.length > 1) {
      const consolidatedOption = document.createElement('option');
      consolidatedOption.value = 'TRYVIA_CONSOLIDADO';
      consolidatedOption.textContent = 'üè¢ Tryvia (Todos Consolidados)';
      teamSelect.appendChild(consolidatedOption);
    }
  }
  
  // Add event listener for date range change
  document.getElementById('reportDateRange').addEventListener('change', function() {
    const customRange = document.getElementById('customDateRange');
    if (this.value === 'custom') {
      customRange.style.display = 'block';
    } else {
      customRange.style.display = 'none';
    }
  });
}

function applyReportFilters(data) {
  let filteredData = [...data];
  
  // Apply team filter
  const teamFilter = document.getElementById('reportTeam').value;
  if (teamFilter !== 'all') {
    filteredData = filteredData.filter(item => item.team === teamFilter);
  }
  
  // Apply type filter
  const typeFilter = document.getElementById('reportType').value;
  if (typeFilter !== 'all') {
    filteredData = filteredData.filter(item => item.type === typeFilter);
  }
  
  // Apply priority filter
  const priorityFilter = document.getElementById('reportPriority').value;
  if (priorityFilter !== 'all') {
    filteredData = filteredData.filter(item => item.priority === priorityFilter);
  }
  
  // Apply SLA filter
  const slaFilter = document.getElementById('reportSLA').value;
  if (slaFilter !== 'all') {
    filteredData = filteredData.filter(item => item.sla === slaFilter);
  }
  
  // Apply status filter
  const statusFilter = document.getElementById('reportStatus').value;
  if (statusFilter !== 'all') {
    filteredData = filteredData.filter(item => item.status === statusFilter);
  }
  
  // Apply date range filter
  const dateRange = document.getElementById('reportDateRange').value;
  if (dateRange !== 'all') {
    const today = new Date();
    let startDate, endDate;
    
    switch(dateRange) {
      case 'today':
        startDate = new Date(today.setHours(0,0,0,0));
        endDate = new Date(today.setHours(23,59,59,999));
        break;
      case 'week':
        startDate = new Date(today.setDate(today.getDate() - 7));
        endDate = new Date();
        break;
      case 'month':
        startDate = new Date(today.setMonth(today.getMonth() - 1));
        endDate = new Date();
        break;
      case 'quarter':
        startDate = new Date(today.setMonth(today.getMonth() - 3));
        endDate = new Date();
        break;
      case 'year':
        startDate = new Date(today.setFullYear(today.getFullYear() - 1));
        endDate = new Date();
        break;
      case 'custom':
        startDate = new Date(document.getElementById('reportStartDate').value);
        endDate = new Date(document.getElementById('reportEndDate').value);
        break;
    }
    
    if (startDate && endDate) {
      filteredData = filteredData.filter(item => {
        const itemDate = new Date(item.date);
        return itemDate >= startDate && itemDate <= endDate;
      });
    }
  }
  
  return filteredData;
}

function previewReport() {
  const preview = document.getElementById('reportPreview');
  preview.style.display = 'block';
  preview.innerHTML = '';
  
  // Debug: Check if enrichment modules are loaded
  console.log('Report Enrichment loaded:', window.reportEnrichment ? 'Yes' : 'No');
  console.log('Report Calculations loaded:', window.reportCalculations ? 'Yes' : 'No');
  if (window.reportEnrichment) {
    console.log('Available enrichment functions:', Object.keys(window.reportEnrichment));
  }
  if (window.reportCalculations) {
    console.log('Available calculation functions:', Object.keys(window.reportCalculations));
  }
  
  // Get selected components
  const selectedComponents = [];
  document.querySelectorAll('.report-component:checked').forEach(cb => {
    selectedComponents.push(cb.dataset.component);
  });
  
  console.log('Selected components:', selectedComponents);
  
  if (selectedComponents.length === 0) {
    alert('Selecione pelo menos um componente para o relat√≥rio!');
    return;
  }
  
  // Verificar se h√° dados carregados - verificar TODAS as fontes poss√≠veis
  const hasSupabaseData = window.BICharts?.cache?.tickets?.length > 0;
  const hasAllTicketsCache = window.allTicketsCache?.length > 0;
  const hasBIAnalyticsData = window.biAnalytics?.allData?.length > 0;
  const hasLegacyData = DATA?.dados?.length > 0 || DATA?.times?.length > 0;
  const hasProcessedData = window.processedData?.length > 0;
  
  const hasAnyData = hasSupabaseData || hasAllTicketsCache || hasBIAnalyticsData || hasLegacyData || hasProcessedData;
  
  if (!hasAnyData) {
    alert('Por favor, carregue dados primeiro!');
    return;
  }
  
  // Ensure BI Charts is initialized for chart copying
  if (window.BICharts && window.BICharts.cache) {
    if (window.BICharts.cache.tickets.length === 0) {
      // Inicializar novo sistema BI Charts
      if (typeof initBICharts === 'function') {
        initBICharts();
      }
    }
  } else {
    // Fallback - tentar inicializar o sistema antigo
    initializeBI();
  }
  
  // Generate report header
  const header = document.createElement('div');
  header.innerHTML = `
    <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">
      <h1 style="color: #1f2937; font-size: 2rem; margin-bottom: 0.5rem;">Relat√≥rio de An√°lise de Tickets</h1>
      <p style="color: #6b7280; font-size: 1rem;">Gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
    </div>
  `;
  preview.appendChild(header);
  
  // Get filtered data - ensure we have valid data
  const teamFilter = document.getElementById('reportTeam').value;
  let reportData;
  
  console.log('Team filter selected:', teamFilter);
  console.log('Available teams:', DATA.times);
  console.log('Available data:', Object.keys(DATA.dados || {}));
  
  if (teamFilter === 'all' || teamFilter === '' || !DATA.dados[teamFilter]) {
    // Use consolidated data for all teams or if specific team not found
    reportData = consolidateAllTeams();
    console.log('Using consolidated data');
  } else {
    reportData = DATA.dados[teamFilter];
    console.log('Using team specific data:', teamFilter);
  }
  
  // Verify we have data
  if (!reportData) {
    alert('Dados n√£o encontrados! Tente selecionar "Todos os times".');
    return;
  }
  
  console.log('Report data:', reportData);
  
  // Generate selected components with error handling
  selectedComponents.forEach(component => {
    console.log(`Generating component: ${component}`);
    const section = document.createElement('div');
    section.style.marginBottom = '2rem';
    
    try {
      switch(component) {
        case 'summary':
          section.innerHTML = generateExecutiveSummary(reportData);
          break;
        case 'kpis':
          section.innerHTML = generateKPIs(reportData);
          break;
        case 'charts':
          const chartContent = generateCharts(reportData);
          if (chartContent) {
            section.appendChild(chartContent);
          }
          break;
        case 'tables':
          section.innerHTML = generateDetailedTables(reportData);
          break;
        case 'sla':
          section.innerHTML = generateSLAAnalysis(reportData);
          break;
        case 'timeline':
          const timelineContent = generateTimeline(reportData);
          if (timelineContent) {
            section.appendChild(timelineContent);
          }
          break;
        case 'ranking':
          section.innerHTML = generateRankings(reportData);
          break;
        case 'distribution':
          section.innerHTML = generateDistributions(reportData);
          break;
        case 'insights':
          section.innerHTML = generateInsights(reportData);
          break;
        case 'trends':
          if (window.reportEnrichment && window.reportEnrichment.generateTrendAnalysis) {
            section.innerHTML = window.reportEnrichment.generateTrendAnalysis(reportData);
          } else {
            console.warn('Trend analysis function not found');
            section.innerHTML = '<p style="color: #ef4444;">An√°lise de tend√™ncias n√£o dispon√≠vel</p>';
          }
          break;
        case 'comparison':
          if (window.reportEnrichment && window.reportEnrichment.generatePeriodComparison) {
            section.innerHTML = window.reportEnrichment.generatePeriodComparison(reportData);
          } else {
            console.warn('Period comparison function not found');
            section.innerHTML = '<p style="color: #ef4444;">Compara√ß√£o temporal n√£o dispon√≠vel</p>';
          }
          break;
        case 'heatmap':
          if (window.reportEnrichment && window.reportEnrichment.generateActivityHeatmap) {
            section.innerHTML = window.reportEnrichment.generateActivityHeatmap(reportData);
          } else {
            console.warn('Heatmap function not found');
            section.innerHTML = '<p style="color: #ef4444;">Mapa de calor n√£o dispon√≠vel</p>';
          }
          break;
        case 'efficiency':
          if (window.reportEnrichment && window.reportEnrichment.generateTeamEfficiencyAnalysis) {
            section.innerHTML = window.reportEnrichment.generateTeamEfficiencyAnalysis(reportData);
          } else {
            console.warn('Team efficiency function not found');
            section.innerHTML = '<p style="color: #ef4444;">An√°lise de efici√™ncia n√£o dispon√≠vel</p>';
          }
          break;
        case 'recurrence':
          if (window.reportEnrichment && window.reportEnrichment.generateRecurrenceAnalysis) {
            section.innerHTML = window.reportEnrichment.generateRecurrenceAnalysis(reportData);
          } else {
            console.warn('Recurrence analysis function not found');
            section.innerHTML = '<p style="color: #ef4444;">An√°lise de reincid√™ncia n√£o dispon√≠vel</p>';
          }
          break;
        case 'complexity':
          if (window.reportEnrichment && window.reportEnrichment.generateComplexityAnalysis) {
            section.innerHTML = window.reportEnrichment.generateComplexityAnalysis(reportData);
          } else {
            console.warn('Complexity analysis function not found');
            section.innerHTML = '<p style="color: #ef4444;">An√°lise de complexidade n√£o dispon√≠vel</p>';
          }
          break;
        case 'quality':
          if (window.reportEnrichment && window.reportEnrichment.generateQualityScoreCard) {
            section.innerHTML = window.reportEnrichment.generateQualityScoreCard(reportData);
          } else {
            console.warn('Quality score function not found');
            section.innerHTML = '<p style="color: #ef4444;">Score de qualidade n√£o dispon√≠vel</p>';
          }
          break;
        case 'prioritization':
          if (window.reportEnrichment && window.reportEnrichment.generatePrioritizationMatrix) {
            section.innerHTML = window.reportEnrichment.generatePrioritizationMatrix(reportData);
          } else {
            console.warn('Prioritization matrix function not found');
            section.innerHTML = '<p style="color: #ef4444;">Matriz de prioriza√ß√£o n√£o dispon√≠vel</p>';
          }
          break;
        default:
          console.warn(`Unknown component: ${component}`);
      }
      
      // Only append section if it has content
      if (section.innerHTML || section.childNodes.length > 0) {
        preview.appendChild(section);
        console.log(`Component ${component} added successfully`);
      } else {
        console.warn(`Component ${component} generated empty content`);
      }
    } catch (error) {
      console.error(`Error generating component ${component}:`, error);
      section.innerHTML = `<p style="color: #ef4444;">Erro ao gerar ${component}: ${error.message}</p>`;
      preview.appendChild(section);
    }
  });
  
  // Scroll to preview
  preview.scrollIntoView({ behavior: 'smooth' });
}

function generateExecutiveSummary(data) {
  // Handle both numeric and formatted time values
  const firstResponseTime = typeof data.sla_primeira_resposta_h_media === 'number' 
    ? data.sla_primeira_resposta_h_media.toFixed(2) 
    : data.sla_primeira_resposta_formatted || '00:00:00';
  
  const resolutionTime = typeof data.sla_resolucao_h_media === 'number' 
    ? data.sla_resolucao_h_media.toFixed(2) 
    : data.sla_resolucao_formatted || '00:00:00';
  
  return `
    <div style="background: rgba(30, 30, 30, 0.95); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid rgba(255, 255, 255, 0.1);">
      <h2 style="color: #e4e4e7; font-size: 1.5rem; margin-bottom: 1rem;">üìã Resumo Executivo</h2>
      <div style="color: #a1a1aa; line-height: 1.6;">
        <p><strong style="color: #d4d4d8;">Total de Tickets:</strong> ${data.total_tickets || 0}</p>
        <p><strong style="color: #d4d4d8;">Tickets Fechados:</strong> ${data.tickets_fechados || 0} (${data.taxa_fechamento || 0}%)</p>
        <p><strong style="color: #d4d4d8;">Tickets Abertos:</strong> ${data.tickets_abertos || 0}</p>
        <p><strong style="color: #d4d4d8;">Taxa de Resolu√ß√£o em 24h:</strong> ${((typeof data.sla_24h_pct === 'number' ? data.sla_24h_pct : (parseFloat(data.sla_24h_pct) || 0)).toFixed(1))}%</p>
        <p><strong style="color: #d4d4d8;">Tempo M√©dio de Primeira Resposta:</strong> ${firstResponseTime} ${typeof data.sla_primeira_resposta_h_media === 'number' ? 'horas' : ''}</p>
        <p><strong style="color: #d4d4d8;">Tempo M√©dio de Resolu√ß√£o:</strong> ${resolutionTime} ${typeof data.sla_resolucao_h_media === 'number' ? 'horas' : ''}</p>
      </div>
    </div>
  `;
}

function generateKPIs(data) {
  // Handle both numeric and formatted time values
  const firstResponseDisplay = typeof data.sla_primeira_resposta_h_media === 'number' && data.sla_primeira_resposta_h_media > 0
    ? `${data.sla_primeira_resposta_h_media.toFixed(1)}h`
    : data.sla_primeira_resposta_formatted || '00:00';
  
  const resolutionDisplay = typeof data.sla_resolucao_h_media === 'number' && data.sla_resolucao_h_media > 0
    ? `${data.sla_resolucao_h_media.toFixed(1)}h`
    : data.sla_resolucao_formatted || '00:00';
  
  return `
    <div style="margin-bottom: 2rem;">
      <h2 style="color: #e4e4e7; font-size: 1.5rem; margin-bottom: 1rem;">üéØ KPIs Principais</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.25)); border: 1px solid rgba(59, 130, 246, 0.3); padding: 1rem; border-radius: 8px; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold; color: #60a5fa;">${data.total_tickets || 0}</div>
          <div style="color: #a1a1aa; font-size: 0.875rem;">Total de Tickets</div>
        </div>
        <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(22, 163, 74, 0.25)); border: 1px solid rgba(34, 197, 94, 0.3); padding: 1rem; border-radius: 8px; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold; color: #4ade80;">${data.tickets_fechados || 0}</div>
          <div style="color: #a1a1aa; font-size: 0.875rem;">Tickets Fechados</div>
        </div>
        <div style="background: linear-gradient(135deg, rgba(5, 150, 105, 0.15), rgba(4, 120, 87, 0.25)); border: 1px solid rgba(5, 150, 105, 0.3); padding: 1rem; border-radius: 8px; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold; color: #34d399;">${(typeof data.sla_24h_pct === 'number' ? data.sla_24h_pct : (parseFloat(data.sla_24h_pct) || 0)).toFixed(1)}%</div>
          <div style="color: #a1a1aa; font-size: 0.875rem;">Taxa de SLA 24h</div>
        </div>
        <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.25)); border: 1px solid rgba(251, 191, 36, 0.3); padding: 1rem; border-radius: 8px; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold; color: #fbbf24;">${firstResponseDisplay}</div>
          <div style="color: #a1a1aa; font-size: 0.875rem;">Tempo 1¬™ Resposta</div>
        </div>
        <div style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(219, 39, 119, 0.25)); border: 1px solid rgba(236, 72, 153, 0.3); padding: 1rem; border-radius: 8px; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold; color: #f472b6;">${resolutionDisplay}</div>
          <div style="color: #a1a1aa; font-size: 0.875rem;">Tempo Resolu√ß√£o</div>
        </div>
      </div>
    </div>
  `;
}

function generateCharts(data) {
  const container = document.createElement('div');
  container.innerHTML = '<h2 style="color: #e4e4e7; font-size: 1.5rem; margin-bottom: 1rem;">üìà Gr√°ficos de An√°lise</h2>';
  
  const chartsGrid = document.createElement('div');
  chartsGrid.style.display = 'grid';
  chartsGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
  chartsGrid.style.gap = '1rem';
  
  // Create high-resolution versions of key charts
  const chartIds = ['chartMonthly', 'chartTypes', 'chartPriority', 'chartSLA'];
  let chartsFound = false;
  
  chartIds.forEach(id => {
    const original = document.getElementById(id);
    if (original && original.getContext) {
      try {
        const chartDiv = document.createElement('div');
        chartDiv.style.background = 'linear-gradient(135deg, rgba(30, 30, 30, 0.9), rgba(20, 20, 20, 0.95))';
        chartDiv.style.padding = '1rem';
        chartDiv.style.borderRadius = '8px';
        chartDiv.style.border = '1px solid rgba(255, 255, 255, 0.1)';
        
        const canvas = document.createElement('canvas');
        // Use higher resolution for better quality
        canvas.width = 800;
        canvas.height = 500;
        canvas.style.width = '100%';
        canvas.style.height = 'auto';
        const ctx = canvas.getContext('2d', { imageSmoothingEnabled: true, imageSmoothingQuality: 'high' });
        
        // Copy original chart with better quality
        ctx.drawImage(original, 0, 0, original.width, original.height, 0, 0, canvas.width, canvas.height);
        
        chartDiv.appendChild(canvas);
        chartsGrid.appendChild(chartDiv);
        chartsFound = true;
      } catch (error) {
        console.warn(`Failed to copy chart ${id}:`, error);
      }
    }
  });
  
  // If no charts found, show a message
  if (!chartsFound) {
    chartsGrid.innerHTML = '<p style="color: #a1a1aa; text-align: center; padding: 2rem; background: rgba(30, 30, 30, 0.5); border-radius: 8px;">Gr√°ficos ser√£o gerados aqui. Certifique-se de que a aba BI Charts foi carregada primeiro.</p>';
  }
  
  container.appendChild(chartsGrid);
  return container;
}

function generateDetailedTables(data) {
  const maxItems = data.report_config?.max_table_items || 5;
  const topTratativa = (data.top_tratativa || []).slice(0, maxItems);
  
  return `
    <div style="margin-bottom: 2rem;">
      <h2 style="color: #e4e4e7; font-size: 1.5rem; margin-bottom: 1rem;">üìä Tabelas Detalhadas</h2>
      <table style="width: 100%; border-collapse: collapse; background: rgba(30, 30, 30, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; overflow: hidden;">
        <thead>
          <tr style="background: rgba(40, 40, 40, 0.8);">
            <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: #d4d4d8;">Posi√ß√£o</th>
            <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: #d4d4d8;">Respons√°vel</th>
            <th style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: #d4d4d8;">Quantidade</th>
          </tr>
        </thead>
        <tbody>
          ${topTratativa.map((item, index) => `
            <tr style="transition: background 0.2s;" onmouseover="this.style.background='rgba(50, 50, 50, 0.5)'" onmouseout="this.style.background='transparent'">
              <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: #60a5fa;">${index + 1}¬∞</td>
              <td style="padding: 0.75rem; border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: #a1a1aa;">${item.pessoa || 'N/A'}</td>
              <td style="padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: #d4d4d8;">${item.qtd || 0}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function generateSLAAnalysis(data) {
  // Handle both numeric and formatted time values
  const firstResponseHours = typeof data.sla_primeira_resposta_h_media === 'number' 
    ? data.sla_primeira_resposta_h_media 
    : 0;
  
  const resolutionHours = typeof data.sla_resolucao_h_media === 'number' 
    ? data.sla_resolucao_h_media 
    : 0;
  
  const firstResponseDisplay = firstResponseHours > 0 
    ? `${firstResponseHours.toFixed(2)} horas` 
    : data.sla_primeira_resposta_formatted || 'N/A';
  
  const resolutionDisplay = resolutionHours > 0 
    ? `${resolutionHours.toFixed(2)} horas` 
    : data.sla_resolucao_formatted || 'N/A';
  
  // Get SLA targets from configuration or use defaults
  const firstResponseTarget = data.sla_meta_primeira_resposta || 4; // horas
  const resolutionTarget = data.sla_meta_resolucao || 24; // horas
  
  return `
    <div style="background: rgba(30, 30, 30, 0.95); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid rgba(255, 255, 255, 0.1);">
      <h2 style="color: #e4e4e7; font-size: 1.5rem; margin-bottom: 1rem;">‚è±Ô∏è An√°lise de SLA</h2>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem;">
        <div>
          <h3 style="color: #d4d4d8; margin-bottom: 0.5rem;">Primeira Resposta</h3>
          <div style="background: rgba(40, 40, 40, 0.8); padding: 1rem; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.05);">
            <p style="color: #a1a1aa;"><strong style="color: #d4d4d8;">M√©dia:</strong> ${firstResponseDisplay}</p>
            <p style="color: #a1a1aa;"><strong style="color: #d4d4d8;">Meta:</strong> ${firstResponseTarget} horas</p>
            <p style="color: ${firstResponseHours > 0 && firstResponseHours <= firstResponseTarget ? '#4ade80' : '#ef4444'};">
              <strong>Status:</strong> ${firstResponseHours > 0 && firstResponseHours <= firstResponseTarget ? 'Dentro da Meta ‚úì' : 'Fora da Meta ‚úó'}
            </p>
          </div>
        </div>
        <div>
          <h3 style="color: #d4d4d8; margin-bottom: 0.5rem;">Resolu√ß√£o</h3>
          <div style="background: rgba(40, 40, 40, 0.8); padding: 1rem; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.05);">
            <p style="color: #a1a1aa;"><strong style="color: #d4d4d8;">M√©dia:</strong> ${resolutionDisplay}</p>
            <p style="color: #a1a1aa;"><strong style="color: #d4d4d8;">Meta:</strong> ${resolutionTarget} horas</p>
            <p style="color: ${resolutionHours > 0 && resolutionHours <= resolutionTarget ? '#4ade80' : '#ef4444'};">
              <strong>Status:</strong> ${resolutionHours > 0 && resolutionHours <= resolutionTarget ? 'Dentro da Meta ‚úì' : 'Fora da Meta ‚úó'}
            </p>
          </div>
        </div>
      </div>
    </div>
  `;
}

function generateTimeline(data) {
  const container = document.createElement('div');
  container.innerHTML = '<h2 style="color: #e4e4e7; font-size: 1.5rem; margin-bottom: 1rem;">üìÖ Timeline Temporal</h2>';
  
  // Create timeline chart with actual data
  try {
    const canvas = document.createElement('canvas');
    canvas.width = 1000;
    canvas.height = 400;
    canvas.style.width = '100%';
    canvas.style.height = 'auto';
    canvas.style.background = 'linear-gradient(135deg, rgba(30, 30, 30, 0.9), rgba(20, 20, 20, 0.95))';
    canvas.style.borderRadius = '8px';
    canvas.style.border = '1px solid rgba(255, 255, 255, 0.1)';
    canvas.style.padding = '10px';
    
    const ctx = canvas.getContext('2d', { imageSmoothingEnabled: true, imageSmoothingQuality: 'high' });
    
    // Prepare timeline data
    const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    const currentMonth = new Date().getMonth();
    const timelineMonths = [];
    const timelineData = [];
    
    // Get last 6 months
    for (let i = 5; i >= 0; i--) {
      const monthIndex = (currentMonth - i + 12) % 12;
      timelineMonths.push(months[monthIndex]);
      
      // Use actual data if available, otherwise generate sample
      if (data.monthly_data && data.monthly_data[monthIndex]) {
        timelineData.push(data.monthly_data[monthIndex]);
      } else {
        // Generate sample data based on total tickets
        const baseValue = (data.total_tickets || 100) / 6;
        const variation = Math.random() * 0.4 - 0.2; // ¬±20% variation
        timelineData.push(Math.round(baseValue * (1 + variation)));
      }
    }
    
    // Draw timeline chart
    const chartPadding = 60;
    const chartWidth = canvas.width - chartPadding * 2;
    const chartHeight = canvas.height - chartPadding * 2;
    const barWidth = chartWidth / timelineMonths.length * 0.7;
    const maxValue = Math.max(...timelineData, 1);
    
    // Draw axes
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(chartPadding, chartPadding);
    ctx.lineTo(chartPadding, canvas.height - chartPadding);
    ctx.lineTo(canvas.width - chartPadding, canvas.height - chartPadding);
    ctx.stroke();
    
    // Draw bars and labels
    timelineMonths.forEach((month, index) => {
      const value = timelineData[index];
      const barHeight = (value / maxValue) * chartHeight;
      const x = chartPadding + (index * chartWidth / timelineMonths.length) + (chartWidth / timelineMonths.length - barWidth) / 2;
      const y = canvas.height - chartPadding - barHeight;
      
      // Draw bar with gradient
      const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
      gradient.addColorStop(0, '#60a5fa');
      gradient.addColorStop(1, '#3b82f6');
      ctx.fillStyle = gradient;
      ctx.fillRect(x, y, barWidth, barHeight);
      
      // Draw value on top of bar
      ctx.fillStyle = '#e4e4e7';
      ctx.font = '14px Inter, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(value.toString(), x + barWidth/2, y - 5);
      
      // Draw month label
      ctx.fillStyle = '#a1a1aa';
      ctx.font = '12px Inter, sans-serif';
      ctx.fillText(month, x + barWidth/2, canvas.height - chartPadding + 20);
    });
    
    // Draw title inside chart
    ctx.fillStyle = '#d4d4d8';
    ctx.font = '16px Inter, sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('Evolu√ß√£o Mensal de Tickets', chartPadding, 30);
    
    container.appendChild(canvas);
  } catch (error) {
    console.error('Error generating timeline:', error);
    const placeholder = document.createElement('p');
    placeholder.style.color = '#a1a1aa';
    placeholder.style.textAlign = 'center';
    placeholder.style.padding = '2rem';
    placeholder.style.background = 'rgba(30, 30, 30, 0.5)';
    placeholder.style.borderRadius = '8px';
    placeholder.textContent = 'Timeline n√£o dispon√≠vel';
    container.appendChild(placeholder);
  }
  
  return container;
}

function generateRankings(data) {
  const rankingLimit = data.report_config?.ranking_limit || 5;
  const topOrigem = (data.top_origem || []).slice(0, rankingLimit);
  const topAgentes = (data.top_agentes || []).slice(0, rankingLimit);
  
  return `
    <div style="margin-bottom: 2rem;">
      <h2 style="color: #e4e4e7; font-size: 1.5rem; margin-bottom: 1rem;">üèÜ Rankings (Top ${rankingLimit})</h2>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem;">
        <div style="background: rgba(30, 30, 30, 0.95); padding: 1rem; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
          <h3 style="color: #d4d4d8; margin-bottom: 0.5rem;">Top Origens</h3>
          <ol style="color: #a1a1aa; margin: 0; padding-left: 1.5rem;">
            ${topOrigem.length > 0 ? 
              topOrigem.map(item => `<li style="margin-bottom: 0.5rem;">${item.origem || 'N/A'}: <span style="color: #60a5fa; font-weight: bold;">${item.qtd || 0}</span></li>`).join('') :
              '<li style="list-style: none; color: #71717a;">Sem dados dispon√≠veis</li>'
            }
          </ol>
        </div>
        <div style="background: rgba(30, 30, 30, 0.95); padding: 1rem; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
          <h3 style="color: #d4d4d8; margin-bottom: 0.5rem;">Top Agentes</h3>
          <ol style="color: #a1a1aa; margin: 0; padding-left: 1.5rem;">
            ${topAgentes.length > 0 ?
              topAgentes.map(item => `<li style="margin-bottom: 0.5rem;">${item.agente || 'N/A'}: <span style="color: #60a5fa; font-weight: bold;">${item.qtd || 0}</span></li>`).join('') :
              '<li style="list-style: none; color: #71717a;">Sem dados dispon√≠veis</li>'
            }
          </ol>
        </div>
      </div>
    </div>
  `;
}

function generateDistributions(data) {
  const porTipo = data.por_tipo_primario || [];
  const porPrioridade = data.por_prioridade_dev || [];
  const distributionLimit = data.report_config?.distribution_limit || 5;
  
  return `
    <div style="margin-bottom: 2rem;">
      <h2 style="color: #e4e4e7; font-size: 1.5rem; margin-bottom: 1rem;">üìä Distribui√ß√µes</h2>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem;">
        <div>
          <h3 style="color: #d4d4d8; margin-bottom: 0.5rem;">Por Tipo</h3>
          <div style="background: rgba(30, 30, 30, 0.95); padding: 1rem; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
            ${porTipo.length > 0 ? 
              porTipo.slice(0, distributionLimit).map(item => `
                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                  <span style="color: #a1a1aa;">${item.tipo_primario || item.tipo || 'N/A'}</span>
                  <span style="color: #60a5fa; font-weight: bold;">${item.qtd || 0}</span>
                </div>
              `).join('') :
              '<p style="color: #71717a; text-align: center;">Sem dados dispon√≠veis</p>'
            }
          </div>
        </div>
        <div>
          <h3 style="color: #d4d4d8; margin-bottom: 0.5rem;">Por Prioridade</h3>
          <div style="background: rgba(30, 30, 30, 0.95); padding: 1rem; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
            ${porPrioridade.length > 0 ?
              porPrioridade.slice(0, distributionLimit).map(item => `
                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                  <span style="color: #a1a1aa;">${item.prioridade_dev || item.prioridade || 'N/A'}</span>
                  <span style="color: #60a5fa; font-weight: bold;">${item.qtd || 0}</span>
                </div>
              `).join('') :
              '<p style="color: #71717a; text-align: center;">Sem dados dispon√≠veis</p>'
            }
          </div>
        </div>
      </div>
    </div>
  `;
}

function generateInsights(data) {
  // Analyze data and generate insights
  const insights = [];
  
  // Get configurable thresholds
  const thresholds = {
    sla_warning: data.report_config?.sla_warning_threshold || 80,
    sla_excellent: data.report_config?.sla_excellent_threshold || 95,
    response_time_limit: data.report_config?.response_time_limit || 4,
    resolution_time_limit: data.report_config?.resolution_time_limit || 24,
    volume_change_threshold: data.report_config?.volume_change_threshold || 15
  };
  
  // Analyze SLA performance
  const slaPerformance = typeof data.sla_24h_pct === 'number' ? data.sla_24h_pct : parseFloat(data.sla_24h_pct) || 0;
  const avgResponseTime = typeof data.sla_primeira_resposta_h_media === 'number' ? data.sla_primeira_resposta_h_media : 0;
  const avgResolutionTime = typeof data.sla_resolucao_h_media === 'number' ? data.sla_resolucao_h_media : 0;
  const totalTickets = data.total_tickets || 0;
  
  // SLA Insights
  if (slaPerformance < thresholds.sla_warning) {
    insights.push({
      type: 'warning',
      icon: '‚ö†Ô∏è',
      title: 'SLA Abaixo da Meta',
      message: `Com ${slaPerformance.toFixed(1)}% de taxa de resolu√ß√£o em 24h, a equipe est√° abaixo do ideal de ${thresholds.sla_warning}%.`,
      recommendations: [
        'Implementar sistema de prioriza√ß√£o autom√°tica de tickets',
        'Considerar aumento da equipe ou redistribui√ß√£o de tarefas',
        'Revisar processos internos para identificar gargalos'
      ]
    });
  } else if (slaPerformance >= thresholds.sla_excellent) {
    insights.push({
      type: 'success',
      icon: '‚úÖ',
      title: 'Excelente Performance de SLA',
      message: `Com ${slaPerformance.toFixed(1)}% de taxa de resolu√ß√£o em 24h, a equipe est√° com desempenho excepcional.`,
      recommendations: [
        'Documentar as pr√°ticas atuais como refer√™ncia',
        'Compartilhar conhecimento com outras equipes',
        'Manter monitoramento para sustentar o desempenho'
      ]
    });
  }
  
  // Response Time Insights
  if (avgResponseTime > thresholds.response_time_limit) {
    insights.push({
      type: 'warning',
      icon: '‚è∞',
      title: 'Tempo de Primeira Resposta Elevado',
      message: `M√©dia de ${avgResponseTime.toFixed(1)} horas excede a meta de ${thresholds.response_time_limit} horas.`,
      recommendations: [
        'Implementar respostas autom√°ticas para confirma√ß√£o de recebimento',
        'Criar templates de respostas para casos comuns',
        'Definir escalas de plant√£o para cobertura cont√≠nua'
      ]
    });
  }
  
  // Volume Analysis
  const timeline = data.timeline_mes || [];
  if (timeline.length > 1) {
    const recentMonth = timeline[timeline.length - 1]?.qtd || 0;
    const previousMonth = timeline[timeline.length - 2]?.qtd || 0;
    
    if (previousMonth > 0) {
      const growth = ((recentMonth - previousMonth) / previousMonth) * 100;
      
      if (growth > thresholds.volume_change_threshold) {
        insights.push({
          type: 'info',
          icon: 'üìà',
          title: 'Crescimento Significativo de Demanda',
          message: `Volume de tickets aumentou ${growth.toFixed(1)}% no √∫ltimo m√™s.`,
          recommendations: [
            'Analisar causas do aumento (novo produto, per√≠odo sazonal, etc)',
            'Considerar automa√ß√£o para tickets recorrentes',
            'Avaliar necessidade de recursos adicionais'
          ]
        });
      } else if (growth < -thresholds.volume_change_threshold) {
        insights.push({
          type: 'info',
          icon: 'üìâ',
          title: 'Redu√ß√£o no Volume de Tickets',
          message: `Volume de tickets diminuiu ${Math.abs(growth).toFixed(1)}% no √∫ltimo m√™s.`,
          recommendations: [
            'Verificar se melhorias implementadas est√£o reduzindo problemas',
            'Avaliar se h√° mudan√ßas na base de usu√°rios',
            'Documentar a√ß√µes que levaram √† redu√ß√£o'
          ]
        });
      }
    }
  }
  
  // Priority Distribution Analysis
  const priorities = data.por_prioridade_dev || [];
  const criticalCount = priorities.find(p => (p.prioridade_dev === 'Cr√≠tica' || p.prioridade === 'Cr√≠tica'))?.qtd || 0;
  const criticalPercentage = totalTickets > 0 ? (criticalCount / totalTickets) * 100 : 0;
  
  const criticalThreshold = data.report_config?.critical_threshold || 15;
  if (criticalPercentage > criticalThreshold) {
    insights.push({
      type: 'critical',
      icon: 'üö®',
      title: 'Alto Volume de Tickets Cr√≠ticos',
      message: `${criticalPercentage.toFixed(1)}% dos tickets s√£o cr√≠ticos, indicando poss√≠veis problemas sist√™micos.`,
      recommendations: [
        'Realizar an√°lise de causa raiz dos problemas recorrentes',
        'Implementar monitoramento proativo',
        'Criar plano de a√ß√£o para reduzir incidentes cr√≠ticos'
      ]
    });
  }
  
  // Top Performers
  const topPeople = data.top_tratativa || [];
  if (topPeople.length > 0 && totalTickets > 0) {
    const topPerformer = topPeople[0];
    const topPercentage = (topPerformer.qtd / totalTickets) * 100;
    
    if (topPercentage > 30) {
      insights.push({
        type: 'info',
        icon: 'üë§',
        title: 'Concentra√ß√£o de Atendimentos',
        message: `${topPerformer.pessoa} est√° resolvendo ${topPercentage.toFixed(1)}% dos tickets.`,
        recommendations: [
          'Distribuir conhecimento atrav√©s de documenta√ß√£o e treinamentos',
          'Balancear carga de trabalho para evitar sobrecarga',
          'Criar programa de mentoria para desenvolver outros membros'
        ]
      });
    }
  }
  
  // Type Distribution
  const types = data.por_tipo_primario || [];
  const topType = types[0];
  if (topType && totalTickets > 0) {
    const topTypePercentage = (topType.qtd / totalTickets) * 100;
    const typeName = topType.tipo_primario || topType.tipo || 'N/A';
    
    if (topTypePercentage > 40) {
      insights.push({
        type: 'info',
        icon: 'üìù',
        title: 'Tipo Predominante de Tickets',
        message: `${topTypePercentage.toFixed(1)}% dos tickets s√£o do tipo "${typeName}".`,
        recommendations: [
          `Criar guias espec√≠ficos para resolver tickets de ${typeName}`,
          'Automatizar resolu√ß√µes comuns deste tipo',
          'Treinar equipe especificamente neste tipo de demanda'
        ]
      });
    }
  }
  
  // Generate HTML for insights
  const insightColors = {
    success: { bg: '#dcfce7', border: '#16a34a', text: '#14532d' },
    warning: { bg: '#fef3c7', border: '#f59e0b', text: '#78350f' },
    info: { bg: '#dbeafe', border: '#3b82f6', text: '#1e3a8a' },
    critical: { bg: '#fee2e2', border: '#ef4444', text: '#7f1d1d' }
  };
  
  return `
    <div style="margin-bottom: 2rem;">
      <h2 style="color: #1f2937; font-size: 1.5rem; margin-bottom: 1rem;">üí° Insights e Recomenda√ß√µes</h2>
      <div style="display: grid; gap: 1.5rem;">
        ${insights.length > 0 ? insights.map(insight => {
          const colors = insightColors[insight.type];
          return `
            <div style="background: ${colors.bg}; border-left: 4px solid ${colors.border}; padding: 1.5rem; border-radius: 8px;">
              <div style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                <span style="font-size: 1.5rem; margin-right: 0.75rem;">${insight.icon}</span>
                <h3 style="color: ${colors.text}; font-size: 1.1rem; font-weight: 600;">${insight.title}</h3>
              </div>
              <p style="color: ${colors.text}; margin-bottom: 1rem;">${insight.message}</p>
              <div style="border-top: 1px solid ${colors.border}; padding-top: 0.75rem;">
                <p style="color: ${colors.text}; font-weight: 600; margin-bottom: 0.5rem;">üìå Recomenda√ß√µes:</p>
                <ul style="color: ${colors.text}; margin: 0; padding-left: 1.5rem;">
                  ${insight.recommendations.map(rec => `<li style="margin-bottom: 0.25rem;">${rec}</li>`).join('')}
                </ul>
              </div>
            </div>
          `;
        }).join('') : `
          <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; text-align: center;">
            <p style="color: #6b7280;">Dados insuficientes para gerar insights. Continue monitorando e acumulando dados para an√°lises mais precisas.</p>
          </div>
        `}
      </div>
      
      <!-- General Tips -->
      <div style="margin-top: 2rem; background: #f0f9ff; border: 1px solid #bae6fd; padding: 1.5rem; border-radius: 8px;">
        <h3 style="color: #075985; margin-bottom: 1rem;">üí≠ Dicas Gerais para Melhoria Cont√≠nua</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
          <div style="background: white; padding: 1rem; border-radius: 6px;">
            <span style="font-weight: 600; color: #1e40af;">üéØ Foco em Preven√ß√£o</span>
            <p style="color: #64748b; font-size: 0.875rem; margin-top: 0.5rem;">Identifique e resolva causas raiz para reduzir reincid√™ncias.</p>
          </div>
          <div style="background: white; padding: 1rem; border-radius: 6px;">
            <span style="font-weight: 600; color: #1e40af;">üìö Base de Conhecimento</span>
            <p style="color: #64748b; font-size: 0.875rem; margin-top: 0.5rem;">Mantenha documenta√ß√£o atualizada para acelerar resolu√ß√µes.</p>
          </div>
          <div style="background: white; padding: 1rem; border-radius: 6px;">
            <span style="font-weight: 600; color: #1e40af;">ü§ù Colabora√ß√£o</span>
            <p style="color: #64748b; font-size: 0.875rem; margin-top: 0.5rem;">Promova compartilhamento de conhecimento entre equipes.</p>
          </div>
          <div style="background: white; padding: 1rem; border-radius: 6px;">
            <span style="font-weight: 600; color: #1e40af;">üìä Monitoramento</span>
            <p style="color: #64748b; font-size: 0.875rem; margin-top: 0.5rem;">Acompanhe m√©tricas regularmente para identificar tend√™ncias.</p>
          </div>
        </div>
      </div>
    </div>
  `;
}

async function exportReportPDF() {
  const preview = document.getElementById('reportPreview');
  
  if (!preview || preview.style.display === 'none') {
    alert('Por favor, visualize o relat√≥rio primeiro!');
    return;
  }
  
  try {
    // Use html2canvas to capture the preview
    const canvas = await html2canvas(preview, {
      scale: 2,
      useCORS: true,
      logging: false
    });
    
    // Create PDF with jsPDF
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    const imgWidth = 210; // A4 width in mm
    const pageHeight = 297; // A4 height in mm
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;
    
    // Add image to PDF
    const imgData = canvas.toDataURL('image/png');
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;
    
    // Add new pages if needed
    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }
    
    // Save PDF
    const teamFilter = document.getElementById('reportTeam').value;
    const fileName = `Relatorio_${teamFilter}_${new Date().toISOString().split('T')[0]}.pdf`;
    pdf.save(fileName);
    
  } catch (error) {
    console.error('Erro ao gerar PDF:', error);
    alert('Erro ao gerar PDF. Verifique o console para mais detalhes.');
  }
}

function exportReportExcel() {
  const teamFilter = document.getElementById('reportTeam').value;
  let reportData;
  
  if (teamFilter === 'all' || teamFilter === '') {
    reportData = consolidateAllTeams();
  } else {
    reportData = DATA.dados[teamFilter];
  }
  
  if (!reportData) {
    alert('Sem dados para exportar!');
    return;
  }
  
  // Create workbook
  const wb = XLSX.utils.book_new();
  
  // Summary sheet
  const summaryData = [
    ['RELAT√ìRIO DE AN√ÅLISE DE TICKETS'],
    [''],
    ['Data de Gera√ß√£o', new Date().toLocaleDateString('pt-BR')],
    ['Hora de Gera√ß√£o', new Date().toLocaleTimeString('pt-BR')],
    [''],
    ['RESUMO EXECUTIVO'],
    ['Total de Tickets', reportData.total_tickets || 0],
    ['Taxa de Resolu√ß√£o (%)', reportData.sla_24h_pct || 0],
    ['Tempo M√©dio 1¬™ Resposta (h)', (reportData.sla_primeira_resposta_h_media || 0).toFixed(2)],
    ['Tempo M√©dio Resolu√ß√£o (h)', (reportData.sla_resolucao_h_media || 0).toFixed(2)]
  ];
  const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, summarySheet, 'Resumo');
  
  // Top Tratativa sheet
  if (reportData.top_tratativa && reportData.top_tratativa.length > 0) {
    const tratativaData = [['Posi√ß√£o', 'Respons√°vel', 'Quantidade']];
    reportData.top_tratativa.forEach((item, index) => {
      tratativaData.push([index + 1, item.pessoa || 'N/A', item.qtd || 0]);
    });
    const tratativaSheet = XLSX.utils.aoa_to_sheet(tratativaData);
    XLSX.utils.book_append_sheet(wb, tratativaSheet, 'Top Respons√°veis');
  }
  
  // Por Tipo sheet
  if (reportData.por_tipo_primario && reportData.por_tipo_primario.length > 0) {
    const tipoData = [['Tipo', 'Quantidade']];
    reportData.por_tipo_primario.forEach(item => {
      tipoData.push([item.tipo || item.tipo_primario || 'N/A', item.qtd || 0]);
    });
    const tipoSheet = XLSX.utils.aoa_to_sheet(tipoData);
    XLSX.utils.book_append_sheet(wb, tipoSheet, 'Por Tipo');
  }
  
  // Por Prioridade sheet
  if (reportData.por_prioridade_dev && reportData.por_prioridade_dev.length > 0) {
    const prioridadeData = [['Prioridade', 'Quantidade']];
    reportData.por_prioridade_dev.forEach(item => {
      prioridadeData.push([item.prioridade || item.prioridade_dev || 'N/A', item.qtd || 0]);
    });
    const prioridadeSheet = XLSX.utils.aoa_to_sheet(prioridadeData);
    XLSX.utils.book_append_sheet(wb, prioridadeSheet, 'Por Prioridade');
  }
  
  // Timeline sheet
  if (reportData.timeline_mes && reportData.timeline_mes.length > 0) {
    const timelineData = [['M√™s', 'Quantidade']];
    reportData.timeline_mes.forEach(item => {
      timelineData.push([item.mes || 'N/A', item.qtd || 0]);
    });
    const timelineSheet = XLSX.utils.aoa_to_sheet(timelineData);
    XLSX.utils.book_append_sheet(wb, timelineSheet, 'Timeline');
  }
  
  // Insights sheet
  const insightsData = [
    ['INSIGHTS E RECOMENDA√á√ïES'],
    [''],
    ['An√°lise de SLA'],
    ['Taxa de Resolu√ß√£o em 24h (%)', reportData.sla_24h_pct || 0],
    ['Tempo M√©dio 1¬™ Resposta (h)', (reportData.sla_primeira_resposta_h_media || 0).toFixed(2)],
    ['Tempo M√©dio Resolu√ß√£o (h)', (reportData.sla_resolucao_h_media || 0).toFixed(2)],
    [''],
    ['Recomenda√ß√µes Baseadas em Dados']
  ];
  
  // Add dynamic insights based on data analysis
  const slaPerformance = reportData.sla_24h_pct || 0;
  if (slaPerformance < 80) {
    insightsData.push(['‚ö†Ô∏è SLA abaixo da meta de 80%']);
    insightsData.push(['‚Ä¢ Implementar prioriza√ß√£o autom√°tica']);
    insightsData.push(['‚Ä¢ Revisar processos internos']);
    insightsData.push(['‚Ä¢ Considerar recursos adicionais']);
  } else if (slaPerformance >= 95) {
    insightsData.push(['‚úÖ Excelente performance de SLA']);
    insightsData.push(['‚Ä¢ Documentar pr√°ticas atuais']);
    insightsData.push(['‚Ä¢ Compartilhar com outras equipes']);
  }
  
  const insightsSheet = XLSX.utils.aoa_to_sheet(insightsData);
  XLSX.utils.book_append_sheet(wb, insightsSheet, 'Insights');
  
  // Advanced Analytics Sheet
  const analyticsData = [
    ['AN√ÅLISES AVAN√áADAS'],
    [''],
    ['M√âTRICAS DE QUALIDADE'],
    ['Score de Qualidade', window.reportCalculations ? window.reportCalculations.calculateQualityMetrics(reportData).score : 'N/A'],
    ['N√≠vel de Servi√ßo', window.reportCalculations ? window.reportCalculations.calculateQualityMetrics(reportData).level : 'N/A'],
    [''],
    ['AN√ÅLISE DE TEND√äNCIAS'],
    ['Tend√™ncia Atual', 'Baseado em an√°lise linear dos √∫ltimos meses'],
    ['Volatilidade', window.reportCalculations ? (window.reportCalculations.calculateVolatility((reportData.timeline_mes || []).map(t => t.qtd || 0)) * 100).toFixed(1) + '%' : 'N/A'],
    [''],
    ['EFICI√äNCIA DA EQUIPE']
  ];
  
  // Add team efficiency metrics if available
  if (window.reportCalculations && reportData.top_tratativa) {
    const efficiency = window.reportCalculations.calculateTeamEfficiency(reportData.top_tratativa, reportData);
    analyticsData.push(
      ['√çndice de Gini', efficiency.giniIndex.toFixed(2)],
      ['Taxa de Resolu√ß√£o', efficiency.resolutionRate + '%'],
      ['Produtividade M√©dia', efficiency.avgProductivity + ' tickets/pessoa/dia'],
      ['Agentes Ativos', efficiency.activeAgents]
    );
  }
  
  const analyticsSheet = XLSX.utils.aoa_to_sheet(analyticsData);
  XLSX.utils.book_append_sheet(wb, analyticsSheet, 'An√°lises Avan√ßadas');
  
  // Complexity Analysis Sheet
  if (window.reportCalculations) {
    const complexityData = window.reportCalculations.analyzeTicketComplexity(reportData);
    const complexitySheetData = [
      ['AN√ÅLISE DE COMPLEXIDADE'],
      [''],
      ['N√≠vel', 'Quantidade', 'Percentual']
    ];
    
    complexityData.levels.forEach(level => {
      complexitySheetData.push([level.name, level.count, level.percentage + '%']);
    });
    
    complexitySheetData.push(
      [''],
      ['FATORES DE COMPLEXIDADE'],
      ['Fator', 'Impacto']
    );
    
    complexityData.factors.forEach(factor => {
      complexitySheetData.push([factor.name, factor.impact]);
    });
    
    const complexitySheet = XLSX.utils.aoa_to_sheet(complexitySheetData);
    XLSX.utils.book_append_sheet(wb, complexitySheet, 'Complexidade');
  }
  
  // Recurrence Analysis Sheet
  if (window.reportCalculations) {
    const recurrenceData = window.reportCalculations.analyzeRecurrence(reportData);
    const recurrenceSheetData = [
      ['AN√ÅLISE DE REINCID√äNCIA'],
      [''],
      ['Taxa de Reincid√™ncia', recurrenceData.rate + '%'],
      ['M√©dia de Reaberturas', recurrenceData.avgRecurrences],
      ['Tempo at√© Reincid√™ncia', recurrenceData.timeToRecur + ' dias'],
      [''],
      ['PRINCIPAIS CAUSAS'],
      ['Causa', 'Percentual']
    ];
    
    recurrenceData.topCauses.forEach(cause => {
      recurrenceSheetData.push([cause.type, cause.percentage + '%']);
    });
    
    recurrenceSheetData.push(
      [''],
      ['RECOMENDA√á√ïES']
    );
    
    recurrenceData.recommendations.forEach(rec => {
      recurrenceSheetData.push([rec]);
    });
    
    const recurrenceSheet = XLSX.utils.aoa_to_sheet(recurrenceSheetData);
    XLSX.utils.book_append_sheet(wb, recurrenceSheet, 'Reincid√™ncia');
  }
  
  // Save file with timestamp
  const fileName = `Relatorio_Enriquecido_${teamFilter}_${new Date().toISOString().split('T')[0]}_${new Date().getHours()}h${new Date().getMinutes()}m.xlsx`;
  XLSX.writeFile(wb, fileName);
}

function resetReportFilters() {
  document.getElementById('reportDateRange').value = 'month';
  document.getElementById('reportTeam').value = 'all';
  document.getElementById('reportType').value = 'all';
  document.getElementById('reportPriority').value = 'all';
  document.getElementById('reportSLA').value = 'all';
  document.getElementById('reportStatus').value = 'all';
  document.getElementById('customDateRange').style.display = 'none';
  document.getElementById('reportPreview').style.display = 'none';
  
  // Reset checkboxes
  document.querySelectorAll('.report-component').forEach(cb => cb.checked = true);
}

// Make report functions global
window.showReportsSetup = showReportsSetup;
window.previewReport = previewReport;
window.exportReportPDF = exportReportPDF;
window.exportReportExcel = exportReportExcel;
window.resetReportFilters = resetReportFilters;

// Fun√ß√£o para consolidar dados de todos os times
function consolidateAllTeams() {
  // Verificar se DATA existe e est√° inicializado
  const data = window.DATA || DATA;
  if (!data || !data.times || !Array.isArray(data.times)) {
    console.warn('‚ö†Ô∏è consolidateAllTeams: DATA n√£o est√° pronto ainda');
    return {
      total_tickets: 0, tickets_fechados: 0, tickets_abertos: 0, taxa_fechamento: 0,
      sla_primeira_resposta_h_media: 0, sla_resolucao_h_media: 0, sla_24h_pct: 0,
      top_tratativa: {}, por_tipo_primario: {}, por_prioridade_dev: {},
      timeline_mes: {}, por_estado: {}, por_origem: {},
      top_agentes: {}, top_empresas: {}, por_produto: {}, por_sistema: {}, por_situacao: {}
    };
  }
  
  const consolidated = {
    total_tickets: 0,
    tickets_fechados: 0,
    tickets_abertos: 0,
    taxa_fechamento: 0,
    sla_primeira_resposta_h_media: 0,
    sla_resolucao_h_media: 0,
    sla_24h_pct: 0,
    top_tratativa: {},
    por_tipo_primario: {},
    por_prioridade_dev: {},
    timeline_mes: {},
    por_estado: {},
    por_origem: {},
    top_agentes: {},
    top_empresas: {},
    por_produto: {},
    por_sistema: {},
    por_situacao: {}
  };
  
  let teamCount = 0;
  let totalSLAFirst = 0;
  let totalSLAResol = 0;
  let totalSLA24 = 0;
  let validSLAFirstCount = 0;
  let validSLAResolCount = 0;
  let validSLA24Count = 0;
  
  // Agrega dados de todos os times
  for (const time of data.times) {
    const teamData = data.dados[time];
    if (!teamData) continue;
    
    teamCount++;
    consolidated.total_tickets += teamData.total_tickets || 0;
    consolidated.tickets_fechados += teamData.tickets_fechados || 0;
    consolidated.tickets_abertos += teamData.tickets_abertos || 0;
    
    // M√©dias ponderadas para SLAs (agora j√° s√£o n√∫meros)
    if (teamData.sla_primeira_resposta_h_media && typeof teamData.sla_primeira_resposta_h_media === 'number') {
      totalSLAFirst += teamData.sla_primeira_resposta_h_media * (teamData.total_tickets || 1);
      validSLAFirstCount += teamData.total_tickets || 1;
    }
    if (teamData.sla_resolucao_h_media && typeof teamData.sla_resolucao_h_media === 'number') {
      totalSLAResol += teamData.sla_resolucao_h_media * (teamData.total_tickets || 1);
      validSLAResolCount += teamData.total_tickets || 1;
    }
    if (teamData.sla_24h_pct !== undefined) {
      const slaValue = typeof teamData.sla_24h_pct === 'number' ? teamData.sla_24h_pct : parseFloat(teamData.sla_24h_pct) || 0;
      totalSLA24 += slaValue * (teamData.total_tickets || 1);
      validSLA24Count += teamData.total_tickets || 1;
    }
    
    // Agrega top_tratativa
    (teamData.top_tratativa || []).forEach(item => {
      consolidated.top_tratativa[item.pessoa] = (consolidated.top_tratativa[item.pessoa] || 0) + item.qtd;
    });
    
    // Agrega por_tipo_primario
    (teamData.por_tipo_primario || []).forEach(item => {
      const key = item.tipo_primario || 'N√£o especificado';
      consolidated.por_tipo_primario[key] = (consolidated.por_tipo_primario[key] || 0) + item.qtd;
    });
    
    // Agrega por_prioridade_dev
    (teamData.por_prioridade_dev || []).forEach(item => {
      consolidated.por_prioridade_dev[item.prioridade_dev] = 
        (consolidated.por_prioridade_dev[item.prioridade_dev] || 0) + item.qtd;
    });
    
    // Agrega timeline_mes
    (teamData.timeline_mes || []).forEach(item => {
      consolidated.timeline_mes[item.mes] = (consolidated.timeline_mes[item.mes] || 0) + item.qtd;
    });
    
    // Agrega por_estado
    (teamData.por_estado || []).forEach(item => {
      consolidated.por_estado[item.estado] = (consolidated.por_estado[item.estado] || 0) + item.qtd;
    });
    
    // Agrega por_origem
    (teamData.por_origem || []).forEach(item => {
      consolidated.por_origem[item.origem] = (consolidated.por_origem[item.origem] || 0) + item.qtd;
    });
    
    // Agrega top_agentes
    (teamData.top_agentes || []).forEach(item => {
      consolidated.top_agentes[item.agente] = (consolidated.top_agentes[item.agente] || 0) + item.qtd;
    });
    
    // Agrega top_empresas
    (teamData.top_empresas || []).forEach(item => {
      consolidated.top_empresas[item.empresa] = (consolidated.top_empresas[item.empresa] || 0) + item.qtd;
    });
    
    // Agrega por_produto
    (teamData.por_produto || []).forEach(item => {
      consolidated.por_produto[item.produto] = (consolidated.por_produto[item.produto] || 0) + item.qtd;
    });
    
    // Agrega por_sistema
    (teamData.por_sistema || []).forEach(item => {
      consolidated.por_sistema[item.sistema] = (consolidated.por_sistema[item.sistema] || 0) + item.qtd;
    });
    
    // Agrega por_situacao
    (teamData.por_situacao || []).forEach(item => {
      consolidated.por_situacao[item.situacao] = (consolidated.por_situacao[item.situacao] || 0) + item.qtd;
    });
  }
  
  // Calcula m√©dias ponderadas (mant√©m como n√∫meros)
  consolidated.sla_primeira_resposta_h_media = validSLAFirstCount > 0 ? 
    totalSLAFirst / validSLAFirstCount : 0;
  consolidated.sla_resolucao_h_media = validSLAResolCount > 0 ? 
    totalSLAResol / validSLAResolCount : 0;
  consolidated.sla_24h_pct = validSLA24Count > 0 ? 
    totalSLA24 / validSLA24Count : 0;
  
  // Calcula taxa de fechamento
  consolidated.taxa_fechamento = consolidated.total_tickets > 0 ? 
    ((consolidated.tickets_fechados / consolidated.total_tickets) * 100).toFixed(1) : 0;
  
  // Converte objetos agregados de volta para arrays ordenados
  consolidated.top_tratativa = Object.entries(consolidated.top_tratativa)
    .map(([pessoa, qtd]) => ({ pessoa, qtd }))
    .sort((a, b) => b.qtd - a.qtd)
    .slice(0, 10);
    
  consolidated.por_tipo_primario = Object.entries(consolidated.por_tipo_primario)
    .map(([tipo_primario, qtd]) => ({ tipo_primario, qtd }))
    .sort((a, b) => b.qtd - a.qtd);
    
  consolidated.por_prioridade_dev = Object.entries(consolidated.por_prioridade_dev)
    .map(([prioridade_dev, qtd]) => ({ prioridade_dev, qtd }))
    .sort((a, b) => b.qtd - a.qtd);
    
  consolidated.timeline_mes = Object.entries(consolidated.timeline_mes)
    .map(([mes, qtd]) => ({ mes, qtd }))
    .sort((a, b) => a.mes.localeCompare(b.mes));
    
  consolidated.por_estado = Object.entries(consolidated.por_estado)
    .map(([estado, qtd]) => ({ estado, qtd }))
    .sort((a, b) => b.qtd - a.qtd);
    
  consolidated.por_origem = Object.entries(consolidated.por_origem)
    .map(([origem, qtd]) => ({ origem, qtd }))
    .sort((a, b) => b.qtd - a.qtd);
  
  // Tamb√©m adiciona top_origem (top 10) para compatibilidade com rankings
  consolidated.top_origem = consolidated.por_origem.slice(0, 10);
    
  consolidated.top_agentes = Object.entries(consolidated.top_agentes)
    .map(([agente, qtd]) => ({ agente, qtd }))
    .sort((a, b) => b.qtd - a.qtd)
    .slice(0, 10);
    
  consolidated.top_empresas = Object.entries(consolidated.top_empresas)
    .map(([empresa, qtd]) => ({ empresa, qtd }))
    .sort((a, b) => b.qtd - a.qtd)
    .slice(0, 10);
    
  consolidated.por_produto = Object.entries(consolidated.por_produto)
    .map(([produto, qtd]) => ({ produto, qtd }))
    .sort((a, b) => b.qtd - a.qtd)
    .slice(0, 10);
    
  consolidated.por_sistema = Object.entries(consolidated.por_sistema)
    .map(([sistema, qtd]) => ({ sistema, qtd }))
    .sort((a, b) => b.qtd - a.qtd)
    .slice(0, 10);
    
  consolidated.por_situacao = Object.entries(consolidated.por_situacao)
    .map(([situacao, qtd]) => ({ situacao, qtd }))
    .sort((a, b) => b.qtd - a.qtd);
  
  return consolidated;
}

window.addEventListener('DOMContentLoaded', init);

	// --- L√≥gica de Leitura e Processamento do XLSX ---

	function processWorkbook(workbook) {
	  const sheetName = workbook.SheetNames[0];
	  const worksheet = workbook.Sheets[sheetName];
	  // Converte a planilha para um array de objetos JSON, usando a primeira linha como cabe√ßalho
	  const data = XLSX.utils.sheet_to_json(worksheet);
	  
	  // Debug: Log as colunas dispon√≠veis no arquivo (apenas uma vez)
	  if (data.length > 0) {
	    console.log('Colunas dispon√≠veis no arquivo Excel:', Object.keys(data[0]));
	  }

	  // Colunas chave (expandidas para an√°lises completas)
	  const timeCol = 'Grupo Tratativa';
	  const pessoaCol = 'Tratativa';
	  const tipoCol = 'Tipo Prim√°rio';
	  const prioridadeCol = 'Prioridade DEV';
	  const criacaoCol = 'Hora de cria√ß√£o';
	  const resolucaoCol = 'Hora de resolu√ß√£o';
	  const tempoPrimeiraRespostaCol = 'Tempo da primeira resposta (em horas)';
	  const tempoResolucaoCol = 'Tempo de resolu√ß√£o (em horas)';
	  
	  // Novas colunas para an√°lises expandidas
	  const estadoCol = 'Estado';
	  const origemCol = 'Origem';
	  const agenteCol = 'Agente';
	  const empresaCol = 'Empresa';
	  const produtoCol = 'Produto';
	  const sistemaCol = 'Sistema';
	  const situacaoCol = 'Situa√ß√£o';
	  const assuntoCol = 'Assunto';
	  const etiquetasCol = 'Etiquetas';
	  const dataEntregaCol = 'Data de entrega';
	  const dataPrevEntregaCol = 'Data previs√£o de entrega';

	  // Fun√ß√£o auxiliar para normalizar nomes de colunas
	  const normalizeColName = (name) => name.trim().replace(/\\s/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
	  
	  // Fun√ß√£o auxiliar para encontrar coluna com fallback
	  const getColumnValue = (row, primaryCol, fallbacks = []) => {
	    // Tenta a coluna principal
	    if (row[primaryCol]) return row[primaryCol];
	    
	    // Tenta as fallbacks
	    for (const col of fallbacks) {
	      if (row[col]) return row[col];
	    }
	    
	    // Busca parcial (case-insensitive) se ainda n√£o encontrou
	    const keys = Object.keys(row);
	    const searchTerm = primaryCol.toLowerCase().replace(/\s+/g, '');
	    for (const key of keys) {
	      if (key.toLowerCase().replace(/\s+/g, '').includes(searchTerm)) {
	        return row[key];
	      }
	    }
	    
	    return null;
	  };

	  // Fun√ß√£o para converter HH:MM:SS para segundos
	  const timeToSeconds = (timeStr) => {
	    if (!timeStr) return null;
	    const parts = timeStr.split(':').map(Number);
	    if (parts.length === 3) {
	      return parts[0] * 3600 + parts[1] * 60 + parts[2];
	    }
	    return null;
	  };
	  
	  // Fun√ß√£o para processar tempo em horas (decimal ou string)
	  const hoursToSeconds = (value) => {
	    if (value === null || value === undefined || value === '') return null;
	    
	    // Se for n√∫mero, assume que j√° est√° em horas
	    if (typeof value === 'number') {
	      return value * 3600; // Converte horas para segundos
	    }
	    
	    // Se for string, tenta converter
	    if (typeof value === 'string') {
	      // Remove espa√ßos e substitui v√≠rgula por ponto
	      const cleaned = value.trim().replace(',', '.');
	      const num = parseFloat(cleaned);
	      if (!isNaN(num)) {
	        return num * 3600; // Converte horas para segundos
	      }
	    }
	    
	    return null;
	  };

	  // Processamento dos dados
	  const df = data.map(row => {
	    const newRow = {};
	    for (const key in row) {
	      newRow[key.trim()] = row[key];
	    }
	    return newRow;
	  }).filter(row => row[timeCol]); // Filtra tickets sem time

	  const times = [...new Set(df.map(row => row[timeCol]))].sort();
	  const dados = {};

	  for (const time of times) {
	    const timeData = df.filter(row => row[timeCol] === time);
	    const totalTickets = timeData.length;

	    // 1. SLA M√©dias (em segundos)
	    // Tempo da primeira resposta j√° vem em horas do Excel (coluna P)
	    const firstResponseTimes = timeData.map(row => hoursToSeconds(row[tempoPrimeiraRespostaCol])).filter(t => t !== null);
	    const avgFirstResponse = firstResponseTimes.length ? firstResponseTimes.reduce((a, b) => a + b, 0) / firstResponseTimes.length : null;

	    const resolutionTimes = timeData.map(row => timeToSeconds(row[tempoResolucaoCol])).filter(t => t !== null);
	    const avgResolution = resolutionTimes.length ? resolutionTimes.reduce((a, b) => a + b, 0) / resolutionTimes.length : null;

	    // 2. % Resolvido ‚â§ 24h
	    let resolvedWithin24h = 0;
	    let totalResolved = 0;
	    for (const row of timeData) {
	      if (row[resolucaoCol]) {
	        totalResolved++;
	        const timeToResolve = timeToSeconds(row[tempoResolucaoCol]);
	        if (timeToResolve !== null && timeToResolve <= 24 * 3600) {
	          resolvedWithin24h++;
	        }
	      }
	    }
	    const sla24hPct = totalResolved > 0 ? ((resolvedWithin24h / totalResolved) * 100).toFixed(1) : 0.0;

	    // 2.5. Contagem de Tickets Fechados usando o StatusManager
	    let ticketsFechados = 0;
	    let ticketsAbertos = 0;
	    if (window.TicketStatusManager) {
	      timeData.forEach(row => {
	        const estado = row[estadoCol] || row['Estado'] || '';
	        if (window.TicketStatusManager.isClosed(estado)) {
	          ticketsFechados++;
	        } else {
	          ticketsAbertos++;
	        }
	      });
	    } else {
	      // Fallback se o StatusManager n√£o estiver carregado
	      timeData.forEach(row => {
	        const estado = (row[estadoCol] || row['Estado'] || '').toLowerCase();
	        if (estado.includes('closed') || estado.includes('resolved') || estado.includes('fechado')) {
	          ticketsFechados++;
	        } else {
	          ticketsAbertos++;
	        }
	      });
	    }

	    // 3. Top pessoas (Tratativa)
	    const tratativaCounts = timeData.reduce((acc, row) => {
	      const pessoa = row[pessoaCol];
	      if (pessoa) acc[pessoa] = (acc[pessoa] || 0) + 1;
	      return acc;
	    }, {});
		    const topTratativa = Object.entries(tratativaCounts)
		      .map(([pessoa, qtd]) => ({ pessoa, qtd }))
		      .sort((a, b) => b.qtd - a.qtd)
		      .slice(0, 10);
	
		    // 4. Tickets por Tipo Prim√°rio (com fallback para varia√ß√µes do nome da coluna)
		    const tipoCounts = timeData.reduce((acc, row) => {
		      // Tenta m√∫ltiplas varia√ß√µes do nome da coluna
		      const tipo = row[tipoCol] || row['Tipo Prim√°rio'] || row['Tipo Prim√°rio '] || row['Tipo'];
		      if (tipo) acc[tipo] = (acc[tipo] || 0) + 1;
		      return acc;
		    }, {});
		    const porTipoPrimario = Object.entries(tipoCounts)
		      .filter(([tipo, qtd]) => tipo && tipo !== 'undefined' && tipo !== 'null') // Filtra valores inv√°lidos
		      .map(([tipo_primario, qtd]) => ({ tipo_primario, qtd }))
		      .sort((a, b) => b.qtd - a.qtd);
	
		    // 5. Prioridade DEV (com fallback para varia√ß√µes)
		    const prioridadeCounts = timeData.reduce((acc, row) => {
		      const prioridade = row[prioridadeCol] || row['Prioridade'] || row['Prioridade DEV '];
		      if (prioridade) acc[prioridade] = (acc[prioridade] || 0) + 1;
		      return acc;
		    }, {});
		    const porPrioridadeDev = Object.entries(prioridadeCounts)
		      .filter(([prio, qtd]) => prio && prio !== 'undefined' && prio !== 'null') // Filtra valores inv√°lidos
		      .map(([prioridade_dev, qtd]) => ({ prioridade_dev, qtd }))
		      .sort((a, b) => b.qtd - a.qtd);
	
		    // 6. Timeline (criados por m√™s)
		    const timelineCounts = timeData.reduce((acc, row) => {
		      try {
		        const date = new Date(row[criacaoCol]);
		        const mes = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
		        acc[mes] = (acc[mes] || 0) + 1;
		      } catch (e) { /* ignore invalid dates */ }
		      return acc;
		    }, {});
		    // 7. Estados dos tickets para an√°lise detalhada
		    const estadoCounts = timeData.reduce((acc, row) => {
		      const estado = row[estadoCol] || row['Estado'] || 'Aberto';
		      if (window.TicketStatusManager) {
		        const category = window.TicketStatusManager.normalizeStatus(estado);
		        const info = window.TicketStatusManager.getCategoryInfo(estado);
		        acc[info.name] = (acc[info.name] || 0) + 1;
		      } else {
		        acc[estado] = (acc[estado] || 0) + 1;
		      }
		      return acc;
		    }, {});
		    const porEstado = Object.entries(estadoCounts)
		      .filter(([estado, qtd]) => estado && estado !== 'undefined')
		      .map(([estado, qtd]) => ({ estado, qtd }))
		      .sort((a, b) => b.qtd - a.qtd);

		    const timelineMes = Object.entries(timelineCounts)
		      .map(([mes, qtd]) => ({ mes, qtd }))
		      .sort((a, b) => a.mes.localeCompare(b.mes));

		    // 8. An√°lise por Origem
		    const origemCounts = timeData.reduce((acc, row) => {
		      const origem = row[origemCol] || row['Origem'] || 'N√£o especificado';
		      acc[origem] = (acc[origem] || 0) + 1;
		      return acc;
		    }, {});
		    const porOrigem = Object.entries(origemCounts)
		      .map(([origem, qtd]) => ({ origem, qtd }))
		      .sort((a, b) => b.qtd - a.qtd);

		    // 9. An√°lise por Agente
		    const agenteCounts = timeData.reduce((acc, row) => {
		      const agente = row[agenteCol] || row['Agente'] || row['Agente interno'];
		      if (agente) acc[agente] = (acc[agente] || 0) + 1;
		      return acc;
		    }, {});
		    const topAgentes = Object.entries(agenteCounts)
		      .map(([agente, qtd]) => ({ agente, qtd }))
		      .sort((a, b) => b.qtd - a.qtd)
		      .slice(0, 10);

		    // 10. An√°lise por Empresa/Cliente
		    const empresaCounts = timeData.reduce((acc, row) => {
		      const empresa = row[empresaCol] || row['Empresa'] || row['Nome da Empresa'];
		      if (empresa) acc[empresa] = (acc[empresa] || 0) + 1;
		      return acc;
		    }, {});
		    const topEmpresas = Object.entries(empresaCounts)
		      .map(([empresa, qtd]) => ({ empresa, qtd }))
		      .sort((a, b) => b.qtd - a.qtd)
		      .slice(0, 10);

		    // 11. An√°lise por Produto
		    const produtoCounts = timeData.reduce((acc, row) => {
		      const produto = row[produtoCol] || row['Produto'];
		      if (produto) acc[produto] = (acc[produto] || 0) + 1;
		      return acc;
		    }, {});
		    const porProduto = Object.entries(produtoCounts)
		      .map(([produto, qtd]) => ({ produto, qtd }))
		      .sort((a, b) => b.qtd - a.qtd);

		    // 12. An√°lise por Sistema
		    const sistemaCounts = timeData.reduce((acc, row) => {
		      const sistema = row[sistemaCol] || row['Sistema'];
		      if (sistema) acc[sistema] = (acc[sistema] || 0) + 1;
		      return acc;
		    }, {});
		    const porSistema = Object.entries(sistemaCounts)
		      .map(([sistema, qtd]) => ({ sistema, qtd }))
		      .sort((a, b) => b.qtd - a.qtd);

		    // 13. An√°lise por Situa√ß√£o
		    const situacaoCounts = timeData.reduce((acc, row) => {
		      const situacao = row[situacaoCol] || row['Situa√ß√£o'];
		      if (situacao) acc[situacao] = (acc[situacao] || 0) + 1;
		      return acc;
		    }, {});
		    const porSituacao = Object.entries(situacaoCounts)
		      .map(([situacao, qtd]) => ({ situacao, qtd }))
		      .sort((a, b) => b.qtd - a.qtd);

		    // Fun√ß√£o para formatar segundos em HH:MM:SS
		    const formatSeconds = (totalSeconds) => {
		      if (totalSeconds === null) return null;
		      const hours = Math.floor(totalSeconds / 3600);
		      const minutes = Math.floor((totalSeconds % 3600) / 60);
		      const seconds = Math.floor(totalSeconds % 60);
		      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
		    };
	
		    dados[time] = {
		      total_tickets: totalTickets,
		      tickets_fechados: ticketsFechados,
		      tickets_abertos: ticketsAbertos,
		      taxa_fechamento: totalTickets > 0 ? ((ticketsFechados / totalTickets) * 100).toFixed(1) : 0,
		      sla_primeira_resposta_h_media: avgFirstResponse / 3600, // Converte segundos para horas
		      sla_resolucao_h_media: avgResolution / 3600, // Converte segundos para horas
		      sla_primeira_resposta_formatted: formatSeconds(avgFirstResponse),
		      sla_resolucao_formatted: formatSeconds(avgResolution),
		      sla_24h_pct: parseFloat(sla24hPct),
		      top_tratativa: topTratativa,
		      por_tipo_primario: porTipoPrimario,
		      por_prioridade_dev: porPrioridadeDev,
		      timeline_mes: timelineMes,
		      // Novas an√°lises
		      por_estado: porEstado,
		      por_origem: porOrigem,
		      top_origem: porOrigem.slice(0, 10),
		      top_agentes: topAgentes,
		      top_empresas: topEmpresas,
		      por_produto: porProduto,
		      por_sistema: porSistema,
		      por_situacao: porSituacao,
		      // Store raw data for Status Manager and other analysis
		      rawData: timeData
		    };
		  }
	
		  // Salva os dados tanto local quanto global
		  DATA = { 
		    times, 
		    dados, 
		    rawData: data // Adiciona os dados brutos para o m√≥dulo comparativo
		  };
		  
		  // Garante que os dados estejam acess√≠veis globalmente
		  window.DATA = DATA;
		  
		  // Log para debug
		  console.log('‚úÖ Dados carregados e salvos globalmente:', {
		    totalTickets: data.length,
		    totalTimes: times.length,
		    rawDataSaved: window.DATA?.rawData ? 'Sim' : 'N√£o',
		    globalDataAccessible: !!window.DATA,
		    comparativeReady: window.DATA?.rawData?.length > 0
		  });
		  
		  // Testa acesso global
		  console.log('üìä Teste de acesso global: window.DATA =', window.DATA);
		  
		  // Notifica o m√≥dulo comparativo que os dados foram carregados
		  if (typeof window.testComparativeData === 'function') {
		    setTimeout(() => {
		      console.log('üîÑ Testando disponibilidade para m√≥dulo comparativo...');
		      window.testComparativeData();
		    }, 100);
		  }
		  
		  // Gerar insights autom√°ticos ap√≥s processar os dados
		  try {
		    const insightsHTML = gerarInsightsAutomaticos(data, times, dados);
		    document.getElementById('insights').innerHTML = insightsHTML;
		  } catch (error) {
		    console.error('Erro ao gerar insights:', error);
		    document.getElementById('insights').innerHTML = `
		      <div style="color: #ef4444;">
		        ‚ùå Erro ao gerar insights autom√°ticos
		      </div>
		    `;
		  }
		  
		  // Renderiza Tryvia (consolidado) por padr√£o
		  renderTeam('TRYVIA_CONSOLIDADO');
		}
		
		// Fun√ß√£o para gerar insights autom√°ticos baseados nos dados
		function gerarInsightsAutomaticos(rawData, times, dadosProcessados) {
		  let output = '<div style="color: var(--text-primary);">';
		  
		  // An√°lise geral
		  const totalGeral = Object.values(dadosProcessados)
		    .reduce((sum, d) => sum + (d.total_tickets || 0), 0);
		  
		  output += '<h4 style="color: var(--accent-purple); margin-bottom: 1rem;">üìä An√°lise Geral dos Dados</h4>';
		  output += `<div style="margin-bottom: 1.5rem;">`;
		  output += `<div>üìà <strong>Total de Tickets:</strong> ${totalGeral.toLocaleString('pt-BR')}</div>`;
		  output += `<div>üë• <strong>Total de Times:</strong> ${times.length}</div>`;
		  output += `<div>üìÖ <strong>M√©dia Di√°ria:</strong> ${Math.round(totalGeral / 30).toLocaleString('pt-BR')} tickets/dia</div>`;
		  output += `</div>`;
		  
		  // Ranking de times por tickets com an√°lise de tend√™ncia
		  const ranking = times
		    .map(time => {
		      const data = dadosProcessados[time];
		      const timeline = data?.timeline_mes || [];
		      let tendencia = 'est√°vel';
		      let crescimento = 0;
		      
		      if (timeline.length >= 2) {
		        const ultimo = timeline[timeline.length - 1]?.qtd || 0;
		        const penultimo = timeline[timeline.length - 2]?.qtd || 0;
		        if (penultimo > 0) {
		          crescimento = ((ultimo - penultimo) / penultimo * 100);
		          if (crescimento > 10) tendencia = 'crescente';
		          else if (crescimento < -10) tendencia = 'decrescente';
		        }
		      }
		      
		      return {
		        time,
		        total: data?.total_tickets || 0,
		        sla: data?.sla_24h_pct || 0,
		        tempoResolucao: data?.sla_resolucao_h_media || 0,
		        tendencia,
		        crescimento,
		        timeline
		      };
		    })
		    .filter(t => t.total > 0)
		    .sort((a, b) => b.total - a.total);
		  
		  // An√°lise de tend√™ncias e previs√µes
		  output += '<h4 style="color: var(--accent-purple); margin-bottom: 1rem;">üîÆ Previs√µes e Tend√™ncias</h4>';
		  output += '<div style="margin-bottom: 1.5rem; background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px;">';
		  
		  // Calcular taxa de crescimento geral
		  const timesComCrescimento = ranking.filter(t => t.tendencia === 'crescente').length;
		  const timesComQueda = ranking.filter(t => t.tendencia === 'decrescente').length;
		  
		  if (timesComCrescimento > timesComQueda) {
		    const taxaCrescimento = Math.round((timesComCrescimento / ranking.length) * 100);
		    output += `<div>üìà <strong>Tend√™ncia Geral:</strong> Crescimento em ${taxaCrescimento}% dos times</div>`;
		    output += `<div>üéØ <strong>Proje√ß√£o pr√≥ximo m√™s:</strong> ${Math.round(totalGeral * 1.1).toLocaleString('pt-BR')} tickets (+10%)</div>`;
		  } else if (timesComQueda > timesComCrescimento) {
		    output += `<div>üìâ <strong>Tend√™ncia Geral:</strong> Redu√ß√£o de volume detectada</div>`;
		    output += `<div>üéØ <strong>Proje√ß√£o pr√≥ximo m√™s:</strong> ${Math.round(totalGeral * 0.95).toLocaleString('pt-BR')} tickets (-5%)</div>`;
		  } else {
		    output += `<div>‚û°Ô∏è <strong>Tend√™ncia Geral:</strong> Volume est√°vel</div>`;
		    output += `<div>üéØ <strong>Proje√ß√£o pr√≥ximo m√™s:</strong> ${totalGeral.toLocaleString('pt-BR')} tickets (est√°vel)</div>`;
		  }
		  
		  // Previs√£o de necessidade de recursos
		  const mediaTicketsPorTime = totalGeral / ranking.length;
		  const capacidadeIdeal = 100; // tickets/m√™s por pessoa
		  const recursosNecessarios = Math.ceil(mediaTicketsPorTime / capacidadeIdeal);
		  
		  output += `<div>üë• <strong>Recursos recomendados:</strong> ${recursosNecessarios} pessoas por time em m√©dia</div>`;
		  output += '</div>';
		  
		  // Top performers com indicadores de tend√™ncia
		  if (ranking.length > 0) {
		    output += '<h4 style="color: var(--accent-purple); margin-bottom: 1rem;">üèÜ Top 5 Times - An√°lise Detalhada</h4>';
		    output += '<div style="margin-bottom: 1.5rem;">';
		    
		    ranking.slice(0, 5).forEach((r, idx) => {
		      const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : 'üìä';
		      const trendIcon = r.tendencia === 'crescente' ? 'üìà' : r.tendencia === 'decrescente' ? 'üìâ' : '‚û°Ô∏è';
		      const bgColor = idx === 0 ? 'rgba(34, 197, 94, 0.1)' : 'transparent';
		      const borderColor = idx === 0 ? '#22c55e' : 'transparent';
		      
		      output += `<div style="padding: 0.5rem; background: ${bgColor}; border-left: 3px solid ${borderColor}; margin-bottom: 0.5rem;">`;
		      output += `${medal} <strong>${r.time}</strong> - ${r.total.toLocaleString('pt-BR')} tickets ${trendIcon}`;
		      
		      if (r.sla > 0) {
		        const slaStatus = r.sla >= 90 ? '‚úÖ' : r.sla >= 70 ? '‚ö†Ô∏è' : '‚ùå';
		        output += ` | SLA: ${slaStatus} ${r.sla}%`;
		      }
		      
		      if (r.crescimento !== 0) {
		        const sinal = r.crescimento > 0 ? '+' : '';
		        output += ` (${sinal}${r.crescimento.toFixed(1)}%)`;
		      }
		      
		      output += `</div>`;
		    });
		    output += '</div>';
		  }
		  
		  // An√°lise preditiva de SLA
		  const timesComSLA = ranking.filter(t => t.sla > 0);
		  let piorSLA = null;
		  
		  if (timesComSLA.length > 0) {
		    const melhorSLA = timesComSLA.reduce((best, curr) => 
		      curr.sla > best.sla ? curr : best
		    );
		    piorSLA = timesComSLA.reduce((worst, curr) => 
		      curr.sla < worst.sla ? curr : worst
		    );
		    
		    const mediaSLA = timesComSLA.reduce((sum, t) => sum + t.sla, 0) / timesComSLA.length;
		    
		    output += '<h4 style="color: var(--accent-purple); margin-bottom: 1rem;">‚è±Ô∏è An√°lise Preditiva de Performance</h4>';
		    output += '<div style="margin-bottom: 1.5rem;">';
		    
		    // An√°lise de risco
		    const timesEmRisco = timesComSLA.filter(t => t.sla < 80).length;
		    if (timesEmRisco > 0) {
		      output += `<div style="padding: 0.5rem; background: rgba(251, 146, 60, 0.1); border-left: 3px solid #fb923c; margin-bottom: 0.5rem;">`;
		      output += `‚ö†Ô∏è <strong>Alerta de Risco:</strong> ${timesEmRisco} times em risco de n√£o cumprir SLA no pr√≥ximo per√≠odo`;
		      output += `</div>`;
		    }
		    
		    output += `<div style="padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; margin-bottom: 0.5rem;">`;
		    output += `‚úÖ Melhor Performance: <strong>${melhorSLA.time}</strong> - ${melhorSLA.sla}%`;
		    if (melhorSLA.tendencia === 'crescente') {
		      output += ` üìà (previs√£o: melhoria cont√≠nua)`;
		    }
		    output += `</div>`;
		    
		    output += `<div style="padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; margin-bottom: 0.5rem;">`;
		    output += `‚ùå Necessita Aten√ß√£o: <strong>${piorSLA.time}</strong> - ${piorSLA.sla}%`;
		    const melhoriaNecess = Math.max(0, 85 - piorSLA.sla);
		    if (melhoriaNecess > 0) {
		      output += ` (meta sugerida: +${melhoriaNecess.toFixed(1)}%)`;
		    }
		    output += `</div>`;
		    
		    output += `<div>üìä <strong>SLA M√©dio:</strong> ${mediaSLA.toFixed(1)}%</div>`;
		    
		    // Previs√£o de impacto
		    if (mediaSLA < 85) {
		      const impacto = Math.round((85 - mediaSLA) * totalGeral / 100);
		      output += `<div>üîî <strong>Impacto Estimado:</strong> ~${impacto} tickets podem atrasar sem melhorias</div>`;
		    }
		    
		    output += '</div>';
		  }
		  
		  // Detec√ß√£o de anomalias e padr√µes
		  output += '<h4 style="color: var(--accent-purple); margin-bottom: 1rem;">üîç Detec√ß√£o de Padr√µes e Anomalias</h4>';
		  output += '<div style="margin-bottom: 1.5rem;">';
		  
		  if (ranking.length > 0) {
		    // An√°lise de distribui√ß√£o
		    const media = totalGeral / ranking.length;
		    const desvioPadrao = Math.sqrt(
		      ranking.reduce((sum, t) => sum + Math.pow(t.total - media, 2), 0) / ranking.length
		    );
		    const coefVariacao = (desvioPadrao / media * 100).toFixed(1);
		    
		    if (coefVariacao > 50) {
		      output += `<div>‚ö†Ô∏è <strong>Alta Variabilidade:</strong> Distribui√ß√£o desigual detectada (CV: ${coefVariacao}%)</div>`;
		      output += `<div>üí° <strong>Insight:</strong> Grande disparidade entre times indica oportunidade de redistribui√ß√£o</div>`;
		    } else {
		      output += `<div>‚úÖ <strong>Distribui√ß√£o Equilibrada:</strong> Varia√ß√£o normal entre times (CV: ${coefVariacao}%)</div>`;
		    }
		    
		    // Detec√ß√£o de outliers
		    const outliers = ranking.filter(t => 
		      t.total > media + 2 * desvioPadrao || 
		      t.total < Math.max(0, media - 2 * desvioPadrao)
		    );
		    
		    if (outliers.length > 0) {
		      output += `<div>üéØ <strong>Outliers Detectados:</strong> ${outliers.length} times com volume at√≠pico`;
		      output += `<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">`;
		      outliers.slice(0, 3).forEach(o => {
		        const tipo = o.total > media ? 'acima' : 'abaixo';
		        output += `<li>${o.time}: ${tipo} da m√©dia</li>`;
		      });
		      output += `</ul></div>`;
		    }
		    
		    // An√°lise de Pareto
		    const top20Percent = Math.ceil(ranking.length * 0.2);
		    const volumeTop20 = ranking.slice(0, top20Percent).reduce((sum, t) => sum + t.total, 0);
		    const paretoRatio = (volumeTop20 / totalGeral * 100).toFixed(0);
		    
		    if (paretoRatio >= 70) {
		      output += `<div>üìà <strong>Princ√≠pio de Pareto:</strong> ${top20Percent} times (20%) geram ${paretoRatio}% dos tickets</div>`;
		    }
		  }
		  
		  output += '</div>';
		  
		  // Recomenda√ß√µes inteligentes baseadas em dados
		  output += '<h4 style="color: var(--accent-purple); margin-bottom: 1rem;">üí° Recomenda√ß√µes Estrat√©gicas</h4>';
		  output += '<div style="background: rgba(99, 102, 241, 0.05); padding: 1rem; border-radius: 8px;">';
		  output += '<ul style="list-style: none; padding: 0; margin: 0;">';
		  
		  // Recomenda√ß√µes baseadas em an√°lise estat√≠stica
		  if (ranking.length > 0) {
		    const media = totalGeral / ranking.length;
		    
		    // Balanceamento de carga
		    if (ranking[0].total > totalGeral * 0.3) {
		      const economia = Math.round((ranking[0].total - media) * 0.15);
		      output += `<li style="margin-bottom: 0.8rem;">‚öñÔ∏è <strong>Balanceamento Urgente:</strong> Redistribuir ${economia} tickets do ${ranking[0].time} pode melhorar efici√™ncia em 15%</li>`;
		    }
		    
		    // Melhoria de SLA
		    if (piorSLA && piorSLA.sla < 70) {
		      const horasNecessarias = Math.round((85 - piorSLA.sla) * 0.5);
		      output += `<li style="margin-bottom: 0.8rem;">‚è∞ <strong>Otimiza√ß√£o de Tempo:</strong> Reduzir ${horasNecessarias}h no tempo m√©dio elevaria SLA do ${piorSLA.time} para 85%</li>`;
		    }
		    
		    // Consolida√ß√£o
		    const timesComPoucosTickets = ranking.filter(t => t.total < media * 0.3).length;
		    if (timesComPoucosTickets > 3) {
		      output += `<li style="margin-bottom: 0.8rem;">üîÑ <strong>Consolida√ß√£o:</strong> ${timesComPoucosTickets} times com baixo volume poderiam ser unidos para maior efici√™ncia</li>`;
		    }
		    
		    // Automa√ß√£o
		    if (totalGeral > 1000) {
		      const ticketsAutomatizaveis = Math.round(totalGeral * 0.2);
		      output += `<li style="margin-bottom: 0.8rem;">ü§ñ <strong>Automa√ß√£o:</strong> Potencial para automatizar ~${ticketsAutomatizaveis} tickets recorrentes (20% do volume)</li>`;
		    }
		    
		    // Capacita√ß√£o
		    const timesComBaixoSLA = ranking.filter(t => t.sla > 0 && t.sla < 75).length;
		    if (timesComBaixoSLA > 2) {
		      output += `<li style="margin-bottom: 0.8rem;">üéì <strong>Treinamento:</strong> ${timesComBaixoSLA} times se beneficiariam de capacita√ß√£o em gest√£o de tempo</li>`;
		    }
		  }
		  
		  output += '</ul>';
		  output += '</div>';
		  
		  // Score de sa√∫de geral
		  output += '<h4 style="color: var(--accent-purple); margin-bottom: 1rem;">üéØ Score de Sa√∫de Operacional</h4>';
		  output += '<div style="margin-bottom: 1.5rem;">';
		  
		  let scoreTotal = 0;
		  let maxScore = 0;
		  
		  // Calcular score baseado em m√©tricas
		  if (ranking.length > 0) {
		    // SLA Score (0-40 pontos)
		    const mediaSLA = timesComSLA.reduce((sum, t) => sum + t.sla, 0) / (timesComSLA.length || 1);
		    scoreTotal += (mediaSLA / 100) * 40;
		    maxScore += 40;
		    
		    // Distribui√ß√£o Score (0-30 pontos)
		    const media = totalGeral / ranking.length;
		    const desvioPadrao = Math.sqrt(
		      ranking.reduce((sum, t) => sum + Math.pow(t.total - media, 2), 0) / ranking.length
		    );
		    const coefVariacao = desvioPadrao / media;
		    const distribuicaoScore = Math.max(0, 30 - (coefVariacao * 30));
		    scoreTotal += distribuicaoScore;
		    maxScore += 30;
		    
		    // Tend√™ncia Score (0-30 pontos)
		    const tendenciaPositiva = ranking.filter(t => t.tendencia === 'crescente').length;
		    const tendenciaNegativa = ranking.filter(t => t.tendencia === 'decrescente').length;
		    const tendenciaScore = tendenciaNegativa > tendenciaPositiva ? 10 : tendenciaPositiva > tendenciaNegativa ? 20 : 30;
		    scoreTotal += tendenciaScore;
		    maxScore += 30;
		  }
		  
		  const scoreFinal = maxScore > 0 ? Math.round((scoreTotal / maxScore) * 100) : 0;
		  const scoreColor = scoreFinal >= 80 ? '#10b981' : scoreFinal >= 60 ? '#f59e0b' : '#ef4444';
		  const scoreEmoji = scoreFinal >= 80 ? 'üöÄ' : scoreFinal >= 60 ? 'üìã' : 'üÜò';
		  
		  output += `<div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, ${scoreColor}22, ${scoreColor}11); border-radius: 12px;">`;
		  output += `<div style="font-size: 3rem; font-weight: bold; color: ${scoreColor};">${scoreFinal}%</div>`;
		  output += `<div style="font-size: 1.2rem; margin-top: 0.5rem;">${scoreEmoji} `;
		  
		  if (scoreFinal >= 80) {
		    output += `<strong>Excelente!</strong> Opera√ß√£o saud√°vel`;
		  } else if (scoreFinal >= 60) {
		    output += `<strong>Bom</strong> - H√° espa√ßo para melhorias`;
		  } else {
		    output += `<strong>Aten√ß√£o</strong> - A√ß√µes urgentes necess√°rias`;
		  }
		  
		  output += `</div>`;
		  output += `</div>`;
		  
		  output += '</div>';
		  output += '</div>';
		  
		  return output;
		}
	
		function handleFile(e) {
		  const file = e.target.files[0];
		  if (!file) return;
		  
		  // Fechar modal se estiver aberto
		  closePreferencesModal();
		  
		  // Mostrar loading
		  document.getElementById('loadingOverlay').classList.add('active');
		  
		  const reader = new FileReader();
		  
		  reader.onload = function(e) {
		    setTimeout(() => {
		      const data = new Uint8Array(e.target.result);
		      const workbook = XLSX.read(data, { type: 'array', cellDates: true });
		      processWorkbook(workbook);
		      
		      // Esconder loading
		      document.getElementById('loadingOverlay').classList.remove('active');
		    }, 100);
		  };
	
		  reader.readAsArrayBuffer(file);
		}
	
		// Event listeners
		document.getElementById('fileInput').addEventListener('change', handleFile, false);
		
		// Handle window resize for responsive charts
		let resizeTimeout;
		window.addEventListener('resize', () => {
		  clearTimeout(resizeTimeout);
		  resizeTimeout = setTimeout(() => {
		    // Redraw charts if BI is active
		    const biContainer = document.getElementById('biContainer');
		    if (biContainer && biContainer.classList.contains('active')) {
		      // Novo sistema BI Charts com Supabase
		      if (typeof refreshBICharts === 'function') {
		        refreshBICharts();
		      }
		    }
		  }, 250);
		});
		
		// Adicionar feedback visual quando arquivo √© selecionado
		document.getElementById('fileInput').addEventListener('change', function(e) {
		  const fileName = e.target.files[0]?.name;
		  if (fileName) {
		    const labels = document.querySelectorAll('.file-label');
		    labels.forEach(label => {
		      const span = label.querySelector('span');
		      if (span) span.textContent = `üìÑ ${fileName}`;
		    });
		  }
		});
		
		// Drag and drop functionality for all file drop zones
		document.querySelectorAll('.file-drop-zone').forEach(dropZone => {
		  dropZone.addEventListener('dragover', (e) => {
		    e.preventDefault();
		    dropZone.classList.add('dragover');
		  });
		  
		  dropZone.addEventListener('dragleave', () => {
		    dropZone.classList.remove('dragover');
		  });
		  
		  dropZone.addEventListener('drop', (e) => {
		    e.preventDefault();
		    dropZone.classList.remove('dragover');
		    
		    const files = e.dataTransfer.files;
		    if (files.length > 0) {
		      const file = files[0];
		      if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
		        // Create a new FileList-like object
		        const dataTransfer = new DataTransfer();
		        dataTransfer.items.add(file);
		        document.getElementById('fileInput').files = dataTransfer.files;
		        
		        // Trigger the change event
		        const event = new Event('change', { bubbles: true });
		        document.getElementById('fileInput').dispatchEvent(event);
		      } else {
		        alert('Por favor, selecione um arquivo Excel (.xlsx ou .xls)');
		      }
		    }
		  });
		});

// =============================================
// FRESHDESK API INTEGRATION
// =============================================

// Configuration storage
let freshdeskConfig = {
  domain: localStorage.getItem('freshdeskDomain') || 'https://suportetryvia.freshdesk.com',
  apiKey: localStorage.getItem('freshdeskApiKey') || 's9GQtphoZqeRNz7Enl'
};

// Initialize config on page load
window.addEventListener('DOMContentLoaded', () => {
  const domainInput = document.getElementById('freshdeskDomain');
  const apiKeyInput = document.getElementById('freshdeskApiKey');
  if (domainInput) domainInput.value = freshdeskConfig.domain;
  if (apiKeyInput) apiKeyInput.value = freshdeskConfig.apiKey;
});

// Save Freshdesk configuration
function saveFreshdeskConfig() {
  const domain = document.getElementById('freshdeskDomain').value.trim();
  const apiKey = document.getElementById('freshdeskApiKey').value.trim();
  
  if (!domain || !apiKey) {
    alert('Por favor, preencha todos os campos de configura√ß√£o!');
    return;
  }
  
  // Remove trailing slash from domain if exists
  freshdeskConfig.domain = domain.replace(/\/$/, '');
  freshdeskConfig.apiKey = apiKey;
  
  // Save to localStorage
  localStorage.setItem('freshdeskDomain', freshdeskConfig.domain);
  localStorage.setItem('freshdeskApiKey', freshdeskConfig.apiKey);
  
  alert('Configura√ß√£o salva com sucesso!');
  closePreferencesModal();
}

// Store tickets data - exposed to window for Analytics
let ticketsData = [];
let allTicketsCache = [];
window.ticketsData = ticketsData;
window.allTicketsCache = allTicketsCache;
 
// Supabase Integration (dynamic CDN load to avoid editing <head>)
const SUPABASE_URL = 'https://mzjdmhgkrroajmsfwryu.supabase.co';
const SUPABASE_ANON_KEY_RAW = 'Anon:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16amRtaGdrcnJvYWptc2Z3cnl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyMzMwMzUsImV4cCI6MjA2MzgwOTAzNX0.tQCwUfFCV7sD-IexQviU0XEPcbn9j5uK9NSUbH-OeBc';
const SUPABASE_ANON_KEY = SUPABASE_ANON_KEY_RAW.replace(/^Anon:/, '');
// Altere aqui se sua tabela tiver outro nome (por exemplo: 'Tickets' ou 'freshdesk_tickets')
const SUPABASE_TABLE = 'tickets';
// Tabelas de lookups (crie no Supabase ou ajuste os nomes aqui)
const SUPABASE_TABLE_AGENTS = 'FreshdeskAgents';
const SUPABASE_TABLE_GROUPS = 'FreshdeskGroups';
const SUPABASE_TABLE_COMPANIES = 'FreshdeskCompanies';
let supabaseClient = null;

async function loadSupabaseCDN() {
  if (window.supabase) return;
  await new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js';
    s.async = true;
    s.onload = () => resolve();
    s.onerror = () => {
      console.error('Falha ao carregar Supabase JS via CDN');
      resolve();
    };
    document.head.appendChild(s);
  });
}

async function initSupabase() {
  // Verifica primeiro se j√° existe uma inst√¢ncia global
  if (supabaseClient) {
    return supabaseClient;
  }
  
  // Verifica se o m√≥dulo BI Charts j√° criou uma inst√¢ncia
  if (window.supabaseClientBI) {
    supabaseClient = window.supabaseClientBI;
    console.log('‚úÖ Reutilizando inst√¢ncia Supabase do BI Charts');
    return supabaseClient;
  }
  
  // Se a biblioteca Supabase n√£o estiver carregada, carrega via CDN
  if (!window.supabase) {
    await loadSupabaseCDN();
  }
  
  // Cria nova inst√¢ncia se a biblioteca estiver dispon√≠vel
  if (window.supabase) {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('‚úÖ Supabase inicializado');
    
    // Compartilha com o m√≥dulo BI Charts
    window.supabaseClientBI = supabaseClient;
  } else {
    console.error('‚ùå Biblioteca Supabase n√£o dispon√≠vel');
  }
  
  return supabaseClient;
}

function mapTicketToDbRow(t) {
  // Extrair campos customizados se existirem
  const cf = t.custom_fields || {};
  
  return {
    id: t.id,
    subject: t.subject ?? null,
    status: t.status ?? null,
    priority: t.priority ?? null,
    type: t.type ?? null,
    source: t.source ?? null,
    created_at: t.created_at ?? null,
    updated_at: t.updated_at ?? null,
    due_by: t.due_by ?? null,
    fr_due_by: t.fr_due_by ?? null,
    description: t.description ?? null,
    description_text: t.description_text ?? null,
    requester_id: t.requester_id ?? null,
    responder_id: t.responder_id ?? null,
    group_id: t.group_id ?? null,
    company_id: t.company_id ?? null,
    // Enriquecimentos (se colunas existirem no Supabase)
    responder_name: (t.responder?.name) || resolveAgentName(t.responder_id) || null,
    group_name: resolveGroupName(t.group_id) || null,
    requester_name: t.requester?.name ?? null,
    requester_email: t.requester?.email ?? null,
    requester_phone: t.requester?.phone ?? null,
    requester_mobile: t.requester?.mobile ?? null,
    company_name: t.company?.name ?? null,
    company_domains: t.company?.domains ?? null,
    company_health_score: t.company?.health_score ?? null,
    stats_first_responded_at: t.stats?.first_responded_at ?? null,
    stats_resolved_at: t.stats?.resolved_at ?? null,
    stats_closed_at: t.stats?.closed_at ?? null,
    stats_pending_since: t.stats?.pending_since ?? null,
    stats_status_updated_at: t.stats?.status_updated_at ?? null,
    stats_reopened_at: t.stats?.reopened_at ?? null,
    stats_agent_responded_at: t.stats?.agent_responded_at ?? null,
    stats_requester_responded_at: t.stats?.requester_responded_at ?? null,
    is_escalated: t.is_escalated ?? false,
    fr_escalated: t.fr_escalated ?? false, // ADICIONADO
    tags: Array.isArray(t.tags) ? t.tags : [],
    custom_fields: t.custom_fields ?? {},
    imported_at: new Date().toISOString(), // ADICIONADO - timestamp de importa√ß√£o
    
    // CAMPOS CUSTOMIZADOS ESPEC√çFICOS DO FRESHDESK (com IDs din√¢micos)
    // Mapear todos os campos cf_ para colunas individuais no Supabase
    cf_tempo1684353202918: cf.cf_tempo1684353202918 ?? null,
    cf_grupo_tratativa1684353202918: cf.cf_grupo_tratativa1684353202918 ?? null,
    cf_tratativa1684353202918: cf.cf_tratativa1684353202918 ?? null,
    cf_pessoa_acompanhamento_11684353202918: cf.cf_pessoa_acompanhamento_11684353202918 ?? null,
    cf_pessoa_acompanhamento_21684353202918: cf.cf_pessoa_acompanhamento_21684353202918 ?? null,
    cf_pessoa_acompanhamento_31684353202918: cf.cf_pessoa_acompanhamento_31684353202918 ?? null,
    cf_tipo_de_campo1684353202918: cf.cf_tipo_de_campo1684353202918 ?? null,
    cf_sla_resoluo1684353202918: cf.cf_sla_resoluo1684353202918 ?? null,
    cf_sla_primeira_resposta1684353202918: cf.cf_sla_primeira_resposta1684353202918 ?? null,
    cf_produto1684353202918: cf.cf_produto1684353202918 ?? null,
    cf_sistema1684353202918: cf.cf_sistema1684353202918 ?? null,
    
    // VERS√ïES SEM TIMESTAMP DOS CAMPOS CUSTOMIZADOS
    cf_grupo_tratativa: cf.cf_grupo_tratativa ?? cf.cf_grupo_tratativa1684353202918 ?? null,
    cf_tratativa: cf.cf_tratativa ?? cf.cf_tratativa1684353202918 ?? null,
    cf_tipo_de_campo: cf.cf_tipo_de_campo ?? cf.cf_tipo_de_campo1684353202918 ?? null,
    cf_pessoa_acompanhamento_1: cf.cf_pessoa_acompanhamento_1 ?? cf.cf_pessoa_acompanhamento_11684353202918 ?? null,
    cf_pessoa_acompanhamento_2: cf.cf_pessoa_acompanhamento_2 ?? cf.cf_pessoa_acompanhamento_21684353202918 ?? null,
    cf_pessoa_acompanhamento_3: cf.cf_pessoa_acompanhamento_3 ?? cf.cf_pessoa_acompanhamento_31684353202918 ?? null,
    cf_sla_resoluo: cf.cf_sla_resoluo ?? cf.cf_sla_resoluo1684353202918 ?? null,
    cf_sla_primeira_resposta: cf.cf_sla_primeira_resposta ?? cf.cf_sla_primeira_resposta1684353202918 ?? null,
    cf_produto: cf.cf_produto ?? cf.cf_produto1684353202918 ?? null,
    cf_sistema: cf.cf_sistema ?? cf.cf_sistema1684353202918 ?? null
  };
}

async function upsertTicketsToSupabase(tickets, onProgress) {
  const client = await initSupabase();
  if (!client) {
    console.warn('Supabase n√£o dispon√≠vel; pulando persist√™ncia.');
    return;
  }
  const batchSize = 500;
  let savedCount = 0;
  for (let i = 0; i < tickets.length; i += batchSize) {
    const batchFull = tickets.slice(i, i + batchSize).map(mapTicketToDbRow);
    let triedFallback = false;
    try {
      const { error } = await client
        .from(SUPABASE_TABLE)
        .upsert(batchFull, { onConflict: 'id' });
      if (error) {
        // Caso o erro seja coluna inexistente, tentar sem campos enriquecidos
        if (String(error.message || '').includes('column') && String(error.message || '').includes('does not exist') && !triedFallback) {
          triedFallback = true;
          const batchBasic = batchFull.map(row => {
            const { responder_name, group_name, requester_name, ...rest } = row;
            return rest;
          });
          const { error: error2 } = await client
            .from(SUPABASE_TABLE)
            .upsert(batchBasic, { onConflict: 'id' });
          if (error2) {
            console.error('Erro ao upsert (fallback) no Supabase:', error2);
          } else {
            savedCount += batchBasic.length;
          }
        } else {
          console.error('Erro ao upsert no Supabase:', error);
        }
      } else {
        savedCount += batchFull.length;
      }
    } catch (e) {
      console.error('Exce√ß√£o ao upsert no Supabase:', e);
    }
    if (onProgress) onProgress(savedCount, tickets.length);
  }
}

function setupAutoSync() {
  if (window.__freshdeskAutoSync) return; // evitar m√∫ltiplos timers
  window.__freshdeskAutoSync = setInterval(() => {
    console.log('‚è±Ô∏è Auto-sync Freshdesk iniciado (1h)');
    loadFreshdeskTickets();
  }, 60 * 60 * 1000); // a cada 1h
}

// Auto-sync de lookups (agentes, grupos, empresas) a cada 1h
function setupLookupsAutoSync() {
  if (window.__freshdeskLookupsAutoSync) return;
  window.__freshdeskLookupsAutoSync = setInterval(async () => {
    try {
      const ok = await checkProxyAvailable();
      if (ok) {
        await loadFreshdeskLookups();
        await syncLookupsFromProxyToSupabase();
      } else {
        await loadLookupsFromSupabase();
      }
    } catch (e) {
      console.warn('Lookup auto-sync falhou:', e);
    }
  }, 60 * 60 * 1000);
}

// Check if proxy is available (cached result to avoid multiple checks)
let proxyCheckResult = null;
let lastProxyCheck = 0;

async function checkProxyAvailable() {
  // Cache o resultado por 5 minutos para evitar m√∫ltiplas tentativas
  const now = Date.now();
  if (proxyCheckResult !== null && (now - lastProxyCheck) < 300000) {
    return proxyCheckResult;
  }
  
  try {
    // Tentar portas em ordem (mas sem logar erros)
    const ports = [3003, 3002, 3001];
    for (const port of ports) {
      try {
        const response = await fetch(`http://localhost:${port}/test`, { 
          method: 'GET',
          mode: 'cors',
          // Timeout curto para falhar r√°pido
          signal: AbortSignal.timeout(1000)
        });
        if (response.ok) {
          window.PROXY_PORT = port;
          proxyCheckResult = true;
          lastProxyCheck = now;
          console.log(`‚úÖ Proxy Freshdesk encontrado na porta ${port}`);
          return true;
        }
      } catch {
        // Silenciosamente continuar para pr√≥xima porta
      }
    }
    proxyCheckResult = false;
    lastProxyCheck = now;
    // N√£o logar como erro, apenas info se necess√°rio
    // console.info('‚ÑπÔ∏è Proxy Freshdesk n√£o dispon√≠vel - usando apenas Supabase');
    return false;
  } catch {
    proxyCheckResult = false;
    lastProxyCheck = now;
    return false;
  }
}

// Carregar tickets diretamente do Supabase (sem chamar Freshdesk)
async function loadTicketsFromSupabase() {
  // Evitar carregamento duplicado
  if (window.isLoadingTickets) {
    console.log('‚è≥ J√° est√° carregando tickets, ignorando chamada duplicada');
    return;
  }
  
  // Se j√° carregou e tem dados no cache, n√£o recarregar
  if (window.ticketsLoaded && window.allTicketsCache && window.allTicketsCache.length > 0) {
    console.log('‚úÖ Tickets j√° carregados no cache, usando dados existentes');
    filterTicketsFromCache();
    return;
  }
  
  window.isLoadingTickets = true;
  console.log('üöÄ Iniciando carregamento de tickets do Supabase...');
  
  const loadingDiv = document.getElementById('ticketsLoading');
  const progressDiv = document.getElementById('loadingProgress');
  const progressText = document.getElementById('progressText');
  const progressBar = document.getElementById('progressBar');
  const tableBody = document.getElementById('ticketsTableBody');

  loadingDiv.style.display = 'block';
  progressDiv.style.display = 'block';
  progressText.textContent = 'üì¶ Carregando tickets do Supabase...';
  progressBar.style.width = '10%';

  try {
    // Usa o SupabaseLoader se dispon√≠vel, sen√£o tenta o m√©todo antigo
    let client;
    if (window.SupabaseLoader) {
      progressText.textContent = 'üì¶ Conectando ao Supabase...';
      client = await window.SupabaseLoader.getClient();
    } else {
      client = await initSupabase();
    }
    
    if (!client) throw new Error('Cliente Supabase n√£o dispon√≠vel');
    
    progressText.textContent = 'üì¶ Buscando tickets do Supabase...';
    progressBar.style.width = '20%';

    // Buscar em chunks para evitar timeout
    // NOTA: Se ver erro ERR_QUIC_PROTOCOL_ERROR, desabilite QUIC em chrome://flags/#enable-quic
    const CHUNK_SIZE = 250; // Reduzido para evitar erros de QUIC/conex√£o
    let allData = [];
    let offset = 0;
    let hasMore = true;
    let totalFetched = 0;
    
    // Fun√ß√£o auxiliar para fetch com retry
    async function fetchWithRetry(client, table, offset, chunkSize, maxRetries = 3) {
      let lastError = null;
      
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          const { data, error } = await client
            .from(table)
            .select('*')
            .order('updated_at', { ascending: false })
            .range(offset, offset + chunkSize - 1);
          
          if (error) return { data: null, error };
          return { data, error: null };
          
        } catch (fetchError) {
          lastError = fetchError;
          console.warn(`‚ö†Ô∏è Tentativa ${attempt}/${maxRetries} falhou para offset ${offset}:`, fetchError.message || fetchError);
          
          if (attempt < maxRetries) {
            // Espera progressiva: 1s, 2s, 3s (maior para erros de QUIC)
            const delay = attempt * 1000;
            console.log(`‚è≥ Aguardando ${delay}ms antes de tentar novamente...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }
      
      return { data: null, error: { message: lastError?.message || 'Falha ap√≥s m√∫ltiplas tentativas', code: 'FETCH_ERROR' } };
    }

    let currentChunkSize = CHUNK_SIZE;
    let consecutiveErrors = 0;
    
    while (hasMore) {
      try {
        progressText.textContent = `üì¶ Carregando tickets ${offset + 1} a ${offset + currentChunkSize}...`;
        progressBar.style.width = Math.min(20 + (offset / 100), 80) + '%';
        
        const { data, error } = await fetchWithRetry(client, SUPABASE_TABLE, offset, currentChunkSize);
        
        if (error) {
          // Se der timeout (c√≥digo 57014) ou erro de fetch, tentar com chunk menor
          if (error.code === '57014' || error.code === 'FETCH_ERROR') {
            consecutiveErrors++;
            console.warn(`‚ö†Ô∏è Erro detectado (${consecutiveErrors}x), reduzindo chunk size...`);
            
            // Reduz chunk size progressivamente
            if (currentChunkSize > 100) {
              currentChunkSize = Math.max(100, Math.floor(currentChunkSize / 2));
              console.log(`üì¶ Novo chunk size: ${currentChunkSize}`);
              
              // Se j√° tem dados suficientes (>50%), continua com o que tem
              if (consecutiveErrors >= 3 && allData.length > 0) {
                console.warn(`‚ö†Ô∏è M√∫ltiplos erros consecutivos. Usando ${allData.length} tickets j√° carregados.`);
                hasMore = false;
              }
              continue; // Tenta novamente com chunk menor
            } else {
              // J√° est√° no chunk m√≠nimo, encerra
              console.warn('‚ö†Ô∏è Chunk no tamanho m√≠nimo. Encerrando busca.');
              hasMore = false;
            }
          } else {
            throw error;
          }
        } else if (data && data.length > 0) {
          allData = allData.concat(data);
          totalFetched += data.length;
          consecutiveErrors = 0; // Reset contador de erros
          
          // Se retornou menos que o chunk size, n√£o h√° mais dados
          if (data.length < currentChunkSize) {
            hasMore = false;
          } else {
            offset += currentChunkSize;
          }
        } else {
          hasMore = false;
        }
        
        // Limite m√°ximo de 10000 tickets
        if (totalFetched >= 10000) {
          console.log('üîî Limite de 10.000 tickets atingido');
          hasMore = false;
        }
        
        // Pausa maior entre requests para evitar ERR_QUIC_PROTOCOL_ERROR
        if (hasMore) {
          await new Promise(resolve => setTimeout(resolve, 300)); // Aumentado para 300ms
        }
      } catch (chunkError) {
        console.error(`Erro ao buscar chunk ${offset}:`, chunkError);
        consecutiveErrors++;
        
        // Se j√° tem dados, usa o que tem
        if (allData.length > 0 && consecutiveErrors >= 2) {
          console.warn(`‚ö†Ô∏è Usando ${allData.length} tickets j√° carregados devido a erros.`);
          hasMore = false;
        } else if (consecutiveErrors >= 3) {
          // Muitos erros seguidos, desiste
          hasMore = false;
        } else {
          // Tenta continuar ap√≥s pausa
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
    }

    const results = Array.isArray(allData) ? allData : [];
    console.log(`‚úÖ Total de ${results.length} tickets carregados do Supabase`);
    allTicketsCache = results;
    window.allTicketsCache = results;

    // Atualiza badge de √∫ltima importa√ß√£o (usa imported_at se existir; sen√£o, updated_at)
    try {
      const lastImported = results.reduce((acc, t) => {
        const d = t.imported_at ? new Date(t.imported_at) : (t.updated_at ? new Date(t.updated_at) : null);
        return !acc || (d && d > acc) ? d : acc;
      }, null);
      const badge = document.getElementById('lastImportedBadge');
      if (badge) {
        badge.textContent = `√öltima importa√ß√£o: ${lastImported ? lastImported.toLocaleString('pt-BR') : '‚Äî'}`;
      }
    } catch {}

    // Popular filtros din√¢micos (Tipo, Origem, Empresa, Time, Agente)
    populateDynamicFilters(results);

    progressText.textContent = `üîç Aplicando filtros locais...`;
    progressBar.style.width = '60%';

    // Aplicar todos os filtros e render via fun√ß√£o centralizada
    filterTicketsFromCache();

    // Dispara evento global para outras abas consumirem
    try {
      document.dispatchEvent(new CustomEvent('tickets:updated', { detail: { total: allTicketsCache.length } }));
      
      // Se o Analytics estiver aberto, atualizar automaticamente
      if (document.getElementById('analyticsContainer').style.display === 'block' && window.simpleAnalytics) {
        console.log('üîÑ Atualizando Analytics com novos dados...');
        window.simpleAnalytics.initialize();
      }
    } catch {}
    
    progressText.textContent = '‚úÖ Dados carregados do Supabase';
    progressBar.style.width = '90%';
  } catch (error) {
    console.error('Erro ao carregar do Supabase:', error);
    tableBody.innerHTML = `
      <tr>
        <td colspan="15" style="padding: 2rem; text-align:center; color: var(--text-secondary);">
          Erro ao carregar do Supabase: ${error.message || 'ver console'}
        </td>
      </tr>
    `;
  } finally {
    window.isLoadingTickets = false;
    window.ticketsLoaded = true;
    loadingDiv.style.display = 'none';
    progressDiv.style.display = 'none';
    console.log('üì¶ Carregamento finalizado, cache pronto para uso');
  }
}

// Load tickets from Freshdesk API with pagination
async function loadFreshdeskTickets() {
  const loadingDiv = document.getElementById('ticketsLoading');
  const progressDiv = document.getElementById('loadingProgress');
  const progressText = document.getElementById('progressText');
  const progressBar = document.getElementById('progressBar');
  const tableBody = document.getElementById('ticketsTableBody');
  
  if (!freshdeskConfig.domain || !freshdeskConfig.apiKey) {
    alert('Por favor, configure o dom√≠nio e a API Key do Freshdesk nas Prefer√™ncias!');
    showPreferences();
    return;
  }
  
  loadingDiv.style.display = 'block';
  progressDiv.style.display = 'block';
  
  try {
    // Usar apenas o NOVO m√©todo via proxy
    const useProxy = await checkProxyAvailable();
    if (!useProxy) {
      throw new Error('Proxy local n√£o dispon√≠vel. O m√©todo NOVO requer o proxy. Execute: npm start');
    }

    // Filtros de exibi√ß√£o (aplicados localmente ap√≥s o download)
    const periodFilter = document.getElementById('ticketPeriodFilter').value;
    const statusFilter = document.getElementById('ticketStatusFilter').value;
    const priorityFilter = document.getElementById('ticketPriorityFilter').value;

    progressText.textContent = '‚è≥ Carregando TODOS os tickets (pode levar alguns minutos)...';
    progressBar.style.width = '10%';

    // Carregar lookups antes, para salvar nomes junto no Supabase
    await loadFreshdeskLookups();
    const apiUrl = `http://localhost:${window.PROXY_PORT}/api/tickets-all`;
    const response = await fetch(apiUrl, { method: 'GET', mode: 'cors' });
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
    }
    const json = await response.json();
    const allTickets = Array.isArray(json) ? json : (json.tickets || []);
    console.log(`üì¶ Recebidos ${allTickets.length} tickets do m√©todo NOVO`);

    // Persistir TODOS os tickets no Supabase (upsert)
    let saved = 0;
    await upsertTicketsToSupabase(allTickets, (done, total) => {
      saved = done;
      progressText.textContent = `üíæ Salvando no Supabase: ${done}/${total}`;
      const pct = 10 + Math.floor((done / total) * 80); // 10%..90%
      progressBar.style.width = pct + '%';
    });
    console.log(`‚úÖ Upsert no Supabase conclu√≠do: ${saved} registros`);
    progressText.textContent = 'üîÑ Recarregando do Supabase...';
    progressBar.style.width = '95%';
    // Recarrega a partir do Supabase para manter a fonte √∫nica e disparar eventos
    await loadTicketsFromSupabase();
    return;
    
  } catch (error) {
    console.error('Erro ao carregar tickets:', error);
    
    // Mostrar mensagem de erro com instru√ß√µes para resolver CORS
    tableBody.innerHTML = `
      <tr>
        <td colspan="15" style="padding: 2rem;">
          <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); padding: 1.5rem; border-radius: 8px;">
            <h3 style="color: #ef4444; margin-bottom: 1rem;">‚ùå Erro ao Conectar com Freshdesk</h3>
            <p style="color: #f87171; margin-bottom: 1rem;">
              ${error.message}
            </p>
            <div style="background: rgba(0, 0, 0, 0.2); padding: 1rem; border-radius: 6px; margin-top: 1rem;">
              <h4 style="color: #fbbf24; margin-bottom: 0.5rem;">‚ö†Ô∏è Problema de CORS Detectado</h4>
              <p style="color: #a1a1aa; margin-bottom: 1rem;">
                O navegador est√° bloqueando a conex√£o direta com a API do Freshdesk por quest√µes de seguran√ßa (CORS).
              </p>
              <h4 style="color: #60a5fa; margin-bottom: 0.5rem;">üí° Como Resolver:</h4>
              <ol style="color: #d4d4d8; margin-left: 1.5rem;">
                <li style="margin-bottom: 1rem; background: rgba(34, 197, 94, 0.1); padding: 0.75rem; border-radius: 6px; border-left: 3px solid #22c55e;">
                  <strong style="color: #22c55e;">‚úÖ Op√ß√£o 1 - Proxy Local (RECOMENDADO):</strong><br>
                  <span style="color: #86efac;">J√° criamos um proxy pronto para voc√™!</span><br>
                  ‚Ä¢ Abra o PowerShell nesta pasta<br>
                  ‚Ä¢ Execute: <code style="background: #27272a; padding: 2px 6px; border-radius: 4px;">npm install</code><br>
                  ‚Ä¢ Depois: <code style="background: #27272a; padding: 2px 6px; border-radius: 4px;">npm start</code><br>
                  ‚Ä¢ <strong>Veja o arquivo INSTRUCOES_PROXY.md para detalhes</strong>
                </li>
                <li style="margin-bottom: 0.5rem;">
                  <strong>Op√ß√£o 2 - Extens√£o do Chrome:</strong><br>
                  ‚Ä¢ Instale a extens√£o <a href="https://chrome.google.com/webstore/search/cors%20unblock" target="_blank" style="color: #60a5fa;">CORS Unblock</a><br>
                  ‚Ä¢ Ative apenas quando usar este sistema<br>
                  ‚Ä¢ Desative ap√≥s o uso por seguran√ßa
                </li>
                <li style="margin-bottom: 0.5rem;">
                  <strong>Op√ß√£o 3 - Chrome sem Seguran√ßa (Tempor√°rio):</strong><br>
                  ‚Ä¢ Feche todas as janelas do Chrome<br>
                  ‚Ä¢ Abra o Chrome com: <code style="background: #27272a; padding: 2px 6px; border-radius: 4px;">chrome.exe --disable-web-security --user-data-dir="C:/temp"</code>
                </li>
              </ol>
              <p style="color: #71717a; margin-top: 1rem; font-size: 0.875rem;">
                <strong>Nota:</strong> O proxy local (Op√ß√£o 1) √© a solu√ß√£o mais segura e profissional.
              </p>
            </div>
          </div>
        </td>
      </tr>
    `;
  } finally {
    loadingDiv.style.display = 'none';
    progressDiv.style.display = 'none';
  }
}


// Update ticket statistics
function updateTicketStats(tickets) {
  const total = tickets.length;
  const open = tickets.filter(t => t.status === 2).length;
  const pending = tickets.filter(t => t.status === 3).length;
  const resolved = tickets.filter(t => t.status === 4 || t.status === 5).length; // 4=Resolvido, 5=Fechado
  
  // KPIs b√°sicos (formatados com separador de milhar)
  document.getElementById('totalTicketsCount').textContent = total.toLocaleString('pt-BR');
  document.getElementById('openTicketsCount').textContent = open.toLocaleString('pt-BR');
  document.getElementById('pendingTicketsCount').textContent = pending.toLocaleString('pt-BR');
  document.getElementById('resolvedTicketsCount').textContent = resolved.toLocaleString('pt-BR');

  // KPIs de SLA e outros
  let firstEligible = 0, firstOk = 0;
  let resEligible = 0, resOk = 0;
  let escalated = 0, reopened = 0, overdue = 0;
  const now = new Date();
  tickets.forEach(t => {
    const { first, res, finishedAt } = computeSlaStatus(t);
    if (t.fr_due_by) {
      firstEligible++;
      if (first.label === '1¬™ OK') firstOk++;
    }
    if (t.due_by) {
      resEligible++;
      if (res.label === 'Res OK') resOk++;
    }
    if (t.is_escalated) escalated++;
    if (t.stats_reopened_at) reopened++;
    const due = t.due_by ? new Date(t.due_by) : null;
    if (due && now > due && !finishedAt) overdue++;
  });

  const fmtPct = (num, den) => den > 0 ? Math.round((num / den) * 100) + '%' : '0%';
  const fmtPctNum = (num, den) => den > 0 ? (num / den * 100).toFixed(1) + '%' : '0%';
  
  const elFirst = document.getElementById('kpiSlaFirstPct');
  if (elFirst) elFirst.textContent = fmtPct(firstOk, firstEligible);
  const elRes = document.getElementById('kpiSlaResPct');
  if (elRes) elRes.textContent = fmtPct(resOk, resEligible);
  
  // Escalados
  const elEsc = document.getElementById('kpiEscalatedCount');
  if (elEsc) elEsc.textContent = escalated.toLocaleString('pt-BR');
  const elEscPct = document.getElementById('kpiEscalatedPct');
  if (elEscPct) elEscPct.textContent = fmtPctNum(escalated, total);
  
  // Reabertos
  const elReo = document.getElementById('kpiReopenedCount');
  if (elReo) elReo.textContent = reopened.toLocaleString('pt-BR');
  const elReoPct = document.getElementById('kpiReopenedPct');
  if (elReoPct) elReoPct.textContent = fmtPctNum(reopened, total);
  
  // Vencidos
  const elOver = document.getElementById('kpiOverdueCount');
  if (elOver) elOver.textContent = overdue.toLocaleString('pt-BR');
  const elOverPct = document.getElementById('kpiOverduePct');
  if (elOverPct) elOverPct.textContent = fmtPctNum(overdue, total);
}

// Pagination state
let currentPage = 1;
let itemsPerPage = 30;
let paginatedTickets = [];

// Render tickets table with pagination
function renderTicketsTable(tickets) {
  const tableBody = document.getElementById('ticketsTableBody');
  
  if (tickets.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="15" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
          Nenhum ticket encontrado com os filtros aplicados.
        </td>
      </tr>
    `;
    // Hide pagination if no tickets
    const paginationDiv = document.getElementById('ticketsPagination');
    if (paginationDiv) paginationDiv.style.display = 'none';
    return;
  }
  
  // Store tickets for pagination
  paginatedTickets = tickets;
  
  // Reset to first page
  currentPage = 1;
  
  // Render the current page
  renderTicketsPage();
  // Garantir aplica√ß√£o das prefer√™ncias de colunas
  if (typeof applyColumnVisibility === 'function') applyColumnVisibility();
  
  // Create/update pagination controls
  createPaginationControls();
}

// Helpers para formata√ß√£o e SLA
function formatDateTime(value) {
  if (!value) return '-';
  const d = new Date(value);
  if (isNaN(d)) return '-';
  return d.toLocaleString('pt-BR');
}

function computeSlaStatus(t) {
  const now = new Date();
  const frDue = t.fr_due_by ? new Date(t.fr_due_by) : null;
  const firstResp = t.stats_first_responded_at ? new Date(t.stats_first_responded_at) : null;

  const due = t.due_by ? new Date(t.due_by) : null;
  const resolvedAt = t.stats_resolved_at ? new Date(t.stats_resolved_at) : null;
  const closedAt = t.stats_closed_at ? new Date(t.stats_closed_at) : null;
  const finishedAt = resolvedAt || closedAt;

  const first = (() => {
    if (!frDue) return { label: '‚Äî', color: '#6b7280' };
    if (firstResp) return firstResp <= frDue ? { label: '1¬™ OK', color: '#10b981' } : { label: '1¬™ SLA', color: '#ef4444' };
    return now <= frDue ? { label: '1¬™ pend.', color: '#f59e0b' } : { label: '1¬™ SLA', color: '#ef4444' };
  })();

  const res = (() => {
    if (!due) return { label: '‚Äî', color: '#6b7280' };
    if (finishedAt) return finishedAt <= due ? { label: 'Res OK', color: '#10b981' } : { label: 'Res SLA', color: '#ef4444' };
    return now <= due ? { label: 'Res pend.', color: '#f59e0b' } : { label: 'Res SLA', color: '#ef4444' };
  })();

  return { first, res, finishedAt };
}

function slaBadgeHtml(t) {
  const { first, res } = computeSlaStatus(t);
  const chip = (text, color, isOk) => {
    const icon = isOk 
      ? '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>'
      : '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
    return `<span style="display:inline-flex;align-items:center;gap:.3rem;padding:.25rem .5rem;border-radius:4px;background:${color}20;color:${color};font-size:.7rem;font-weight:500;border:1px solid ${color}30;white-space:nowrap;">${icon} ${text}</span>`;
  };
  const isFirstOk = first.label.includes('OK');
  const isResOk = res.label.includes('OK');
  return `<div style="display:flex;gap:.25rem;flex-wrap:nowrap;">${chip(first.label, first.color, isFirstOk)} ${chip(res.label, res.color, isResOk)}</div>`;
}

function applyColumnVisibility() {
  const controls = document.querySelectorAll('#ticketColumnsControls input[type=checkbox]');
  const vis = {};
  controls.forEach(c => { vis[c.getAttribute('data-col')] = c.checked; });
  const setDisplay = (selector, show) => {
    document.querySelectorAll(selector).forEach(el => { el.style.display = show ? '' : 'none'; });
  };
  setDisplay('#ticketsTable thead th.col-description, #ticketsTableBody td.col-description', !!vis['description']);
  setDisplay('#ticketsTable thead th.col-sla, #ticketsTableBody td.col-sla', !!vis['sla']);
  setDisplay('#ticketsTable thead th.col-type, #ticketsTableBody td.col-type', !!vis['type']);
  setDisplay('#ticketsTable thead th.col-company, #ticketsTableBody td.col-company', !!vis['company']);
  setDisplay('#ticketsTable thead th.col-group, #ticketsTableBody td.col-group', !!vis['group']);
  setDisplay('#ticketsTable thead th.col-agent, #ticketsTableBody td.col-agent', !!vis['agent']);
  setDisplay('#ticketsTable thead th.col-sla-deadlines, #ticketsTableBody td.col-sla-deadlines', !!vis['sla-deadlines']);
  setDisplay('#ticketsTable thead th.col-closure, #ticketsTableBody td.col-closure', !!vis['closure']);
}

// Render a specific page of tickets
function renderTicketsPage() {
  const tableBody = document.getElementById('ticketsTableBody');
  
  // Calculate pagination
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, paginatedTickets.length);
  const pageTickets = paginatedTickets.slice(startIndex, endIndex);
  
  // Usar m√≥dulo centralizado de status se dispon√≠vel (sem emojis, √≠cones SVG inline)
  const statusMap = window.FRESHDESK_STATUS?.MAP || {
    2:  { label: 'Aberto', color: '#3b82f6', bgColor: 'rgba(59,130,246,0.15)' },
    3:  { label: 'Pendente', color: '#f59e0b', bgColor: 'rgba(245,158,11,0.15)' },
    4:  { label: 'Resolvido', color: '#10b981', bgColor: 'rgba(16,185,129,0.15)' },
    5:  { label: 'Fechado', color: '#10b981', bgColor: 'rgba(16,185,129,0.15)' },
    6:  { label: 'Em Homologa√ß√£o', color: '#8b5cf6', bgColor: 'rgba(139,92,246,0.15)' },
    7:  { label: 'Aguardando Cliente', color: '#f59e0b', bgColor: 'rgba(245,158,11,0.15)' },
    8:  { label: 'Em Tratativa', color: '#06b6d4', bgColor: 'rgba(6,182,212,0.15)' },
    10: { label: 'Em An√°lise', color: '#06b6d4', bgColor: 'rgba(6,182,212,0.15)' },
    11: { label: 'Interno', color: '#64748b', bgColor: 'rgba(100,116,139,0.15)' },
    12: { label: 'Aguardando Publicar HML', color: '#3b82f6', bgColor: 'rgba(59,130,246,0.15)' },
    13: { label: 'Aguardando Publicar PROD', color: '#8b5cf6', bgColor: 'rgba(139,92,246,0.15)' },
    14: { label: 'MVP', color: '#ec4899', bgColor: 'rgba(236,72,153,0.15)' },
    15: { label: 'Valida√ß√£o-Atendimento', color: '#f97316', bgColor: 'rgba(249,115,22,0.15)' },
    16: { label: 'Aguardando Parceiros', color: '#a855f7', bgColor: 'rgba(168,85,247,0.15)' },
    17: { label: 'Pausado', color: '#64748b', bgColor: 'rgba(100,116,139,0.15)' },
    18: { label: 'Valida√ß√£o-CS', color: '#f97316', bgColor: 'rgba(249,115,22,0.15)' },
    19: { label: 'Levantamento de Esfor√ßo', color: '#6366f1', bgColor: 'rgba(99,102,241,0.15)' },
    20: { label: 'Em Fila DEV', color: '#ef4444', bgColor: 'rgba(239,68,68,0.15)' },
    21: { label: 'Em Produ√ß√£o', color: '#10b981', bgColor: 'rgba(16,185,129,0.15)' }
  };
  
  const priorityMap = {
    1: { label: 'Baixa', color: '#6b7280', bgColor: 'rgba(100,116,139,0.15)' },
    2: { label: 'M√©dia', color: '#f59e0b', bgColor: 'rgba(245,158,11,0.15)' },
    3: { label: 'Alta', color: '#f97316', bgColor: 'rgba(249,115,22,0.15)' },
    4: { label: 'Urgente', color: '#ef4444', bgColor: 'rgba(239,68,68,0.15)' }
  };
  
  // Fun√ß√£o para gerar √≠cone de status como SVG
  const getStatusIcon = (statusCode) => {
    const icons = {
      2: '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="8"/></svg>',
      3: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
      4: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
      5: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
      10: '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>'
    };
    return icons[statusCode] || '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="6"/></svg>';
  };
  
  // Fun√ß√£o para gerar √≠cone de prioridade como dot
  const getPriorityDot = (priority) => `<span style="width:8px;height:8px;border-radius:50%;background:${priority.color};display:inline-block;"></span>`;
  
  tableBody.innerHTML = pageTickets.map((ticket, index) => {
    const status = statusMap[ticket.status] || { label: `Status ${ticket.status}`, color: '#6b7280', bgColor: 'rgba(100,116,139,0.15)' };
    const priority = priorityMap[ticket.priority] || { label: 'N√£o definida', color: '#6b7280', bgColor: 'rgba(100,116,139,0.15)' };
    const createdDate = formatDateTime(ticket.created_at);
    const updatedDate = formatDateTime(ticket.updated_at);
    const closureDate = formatDateTime(ticket.stats_resolved_at || ticket.stats_closed_at);
    const rowNumber = startIndex + index + 1;
    const groupName = resolveGroupName(ticket.group_id);
    const agentName = resolveAgentName(ticket.responder_id);
    
    // Zebra striping - linhas alternadas
    const isEven = index % 2 === 0;
    const rowBg = isEven ? 'transparent' : 'rgba(255,255,255,0.02)';
    
    return `
      <tr style="border-bottom: 1px solid rgba(63,63,90,0.3); transition: all 0.15s ease; background: ${rowBg};" 
          onmouseover="this.style.background='rgba(59,130,246,0.08)'; this.style.boxShadow='inset 0 0 0 1px rgba(59,130,246,0.2)';" 
          onmouseout="this.style.background='${rowBg}'; this.style.boxShadow='none';">
        <td style="padding: 0.5rem 1rem; color: var(--text-secondary); font-size: 0.75rem; width: 50px;">
          ${rowNumber}
        </td>
        <td style="padding: 1rem; color: var(--text-primary); font-weight: 600;">
          <a href="#" onclick="showTicketDetails(${ticket.id}); return false;" 
             style="color: #3b82f6; text-decoration: none; cursor: pointer;" 
             onmouseover="this.style.textDecoration='underline'" 
             onmouseout="this.style.textDecoration='none'">#${ticket.id}</a>
        </td>
        <td style="padding: 1rem; color: var(--text-primary);">
          <div style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
               title="${ticket.subject || 'Sem assunto'}">
            ${ticket.subject || 'Sem assunto'}
          </div>
        </td>
        <td class="col-description" style="padding: 1rem; color: var(--text-secondary); font-size: 0.8rem;">
          <div style="max-width: 300px; max-height: 60px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;"
               title="${(ticket.description_text || ticket.description || '').replace(/"/g, '&quot;').replace(/<[^>]*>/g, '').substring(0, 500)}">
            ${((ticket.description_text || ticket.description || '-').replace(/<[^>]*>/g, '')).substring(0, 150)}${(ticket.description_text || ticket.description || '').length > 150 ? '...' : ''}
          </div>
        </td>
        <td style="padding: 0.75rem;">
          <span style="display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.35rem 0.75rem; 
                       background: ${status.bgColor || status.color + '15'}; color: ${status.color}; 
                       border-radius: 6px; font-size: 0.8rem; font-weight: 500; white-space: nowrap;
                       border: 1px solid ${status.color}30;">
            ${getStatusIcon(ticket.status)} ${status.label}
          </span>
        </td>
        <td style="padding: 0.75rem;">
          <span style="display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.35rem 0.75rem; 
                       background: ${priority.bgColor || priority.color + '15'}; color: ${priority.color}; 
                       border-radius: 6px; font-size: 0.8rem; font-weight: 500;
                       border: 1px solid ${priority.color}30;">
            ${getPriorityDot(priority)} ${priority.label}
          </span>
        </td>
        <td style="padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">${createdDate}</td>
        <td style="padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">${updatedDate}</td>
        <td class="col-sla" style="padding: 1rem;">${slaBadgeHtml(ticket)}</td>
        <td class="col-type" style="padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">${ticket.type || '-'}</td>
        <td class="col-company" style="padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">${ticket.company_name || '-'}</td>
        <td class="col-group" style="padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">${groupName || '-'}</td>
        <td class="col-agent" style="padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">${agentName || '-'}</td>
        <td class="col-sla-deadlines" style="padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">${formatDateTime(ticket.fr_due_by)}</td>
        <td class="col-sla-deadlines" style="padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">${formatDateTime(ticket.due_by)}</td>
        <td class="col-closure" style="padding: 1rem; color: var(--text-secondary); font-size: 0.875rem;">${closureDate}</td>
      </tr>
    `;
  }).join('');

  // Aplicar visibilidade conforme toggles
  if (typeof applyColumnVisibility === 'function') applyColumnVisibility();
}

// Create pagination controls
function createPaginationControls() {
  let paginationDiv = document.getElementById('ticketsPagination');
  
  // Create pagination div if it doesn't exist
  if (!paginationDiv) {
    const tableContainer = document.getElementById('ticketsTableContainer');
    if (!tableContainer) {
      console.error('Container da tabela n√£o encontrado!');
      return;
    }
    paginationDiv = document.createElement('div');
    paginationDiv.id = 'ticketsPagination';
    paginationDiv.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 0 0 12px 12px;
      margin-top: -1px;
      border-top: 1px solid var(--border);
    `;
    tableContainer.parentNode.insertBefore(paginationDiv, tableContainer.nextSibling);
  }
  
  const totalPages = Math.ceil(paginatedTickets.length / itemsPerPage);
  const startItem = ((currentPage - 1) * itemsPerPage) + 1;
  const endItem = Math.min(currentPage * itemsPerPage, paginatedTickets.length);
  
  paginationDiv.innerHTML = `
    <div style="display: flex; align-items: center; gap: 1rem;">
      <label style="color: var(--text-secondary); font-size: 0.875rem;">
        Itens por p√°gina:
      </label>
      <select id="itemsPerPageSelect" onchange="changeItemsPerPage(this.value)" 
              style="background: var(--bg-primary); color: var(--text-primary); 
                     border: 1px solid var(--border); padding: 0.5rem; 
                     border-radius: 6px; font-size: 0.875rem;">
        <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10</option>
        <option value="30" ${itemsPerPage === 30 ? 'selected' : ''}>30</option>
        <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50</option>
        <option value="100" ${itemsPerPage === 100 ? 'selected' : ''}>100</option>
      </select>
      <span style="color: var(--text-secondary); font-size: 0.875rem;">
        Mostrando ${startItem}-${endItem} de ${paginatedTickets.length} tickets
      </span>
    </div>
    
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <button onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}
              style="padding: 0.5rem 0.75rem; background: ${currentPage === 1 ? 'var(--bg-tertiary)' : 'var(--gradient)'}; 
                     color: white; border: none; border-radius: 6px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; 
                     opacity: ${currentPage === 1 ? '0.5' : '1'}; font-size: 0.875rem;">
        ‚èÆÔ∏è Primeira
      </button>
      <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}
              style="padding: 0.5rem 0.75rem; background: ${currentPage === 1 ? 'var(--bg-tertiary)' : 'var(--gradient)'}; 
                     color: white; border: none; border-radius: 6px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; 
                     opacity: ${currentPage === 1 ? '0.5' : '1'}; font-size: 0.875rem;">
        ‚óÄÔ∏è Anterior
      </button>
      <span style="padding: 0.5rem 1rem; background: var(--bg-primary); 
                   border: 1px solid var(--border); border-radius: 6px; 
                   color: var(--text-primary); font-size: 0.875rem;">
        P√°gina ${currentPage} de ${totalPages}
      </span>
      <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}
              style="padding: 0.5rem 0.75rem; background: ${currentPage === totalPages ? 'var(--bg-tertiary)' : 'var(--gradient)'}; 
                     color: white; border: none; border-radius: 6px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; 
                     opacity: ${currentPage === totalPages ? '0.5' : '1'}; font-size: 0.875rem;">
        Pr√≥xima ‚ñ∂Ô∏è
      </button>
      <button onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}
              style="padding: 0.5rem 0.75rem; background: ${currentPage === totalPages ? 'var(--bg-tertiary)' : 'var(--gradient)'}; 
                     color: white; border: none; border-radius: 6px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; 
                     opacity: ${currentPage === totalPages ? '0.5' : '1'}; font-size: 0.875rem;">
        √öltima ‚è≠Ô∏è
      </button>
    </div>
  `;
  
  paginationDiv.style.display = 'flex';
}

// Change items per page
function changeItemsPerPage(value) {
  itemsPerPage = parseInt(value);
  currentPage = 1;
  renderTicketsPage();
  createPaginationControls();
}

// Go to specific page
function goToPage(page) {
  const totalPages = Math.ceil(paginatedTickets.length / itemsPerPage);
  if (page < 1 || page > totalPages) return;
  
  currentPage = page;
  renderTicketsPage();
  createPaginationControls();
  
  // Scroll to top of table
  const tableElement = document.getElementById('ticketsTable');
  if (tableElement) {
    tableElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

// Toggle ticket filters visibility
let filtersVisible = true;
function toggleTicketFilters() {
  const container = document.getElementById('ticketFiltersContainer');
  const icon = document.getElementById('toggleFiltersIcon');
  const btn = document.getElementById('toggleFiltersBtn');
  
  if (!container) return;
  
  filtersVisible = !filtersVisible;
  
  if (filtersVisible) {
    container.style.display = 'flex';
    container.style.opacity = '1';
    container.style.maxHeight = '500px';
    icon.textContent = '‚ñº';
    btn.title = 'Ocultar filtros';
  } else {
    container.style.display = 'none';
    container.style.opacity = '0';
    container.style.maxHeight = '0';
    icon.textContent = '‚ñ∂';
    btn.title = 'Mostrar filtros';
  }
  
  // Salvar prefer√™ncia
  localStorage.setItem('ticketFiltersVisible', filtersVisible);
}

// Restaurar estado dos filtros ao carregar
document.addEventListener('DOMContentLoaded', function() {
  const saved = localStorage.getItem('ticketFiltersVisible');
  if (saved === 'false') {
    filtersVisible = true; // Inverter para que o toggle funcione
    toggleTicketFilters();
  }
});

// Filter tickets from cache
function filterTicketsFromCache() {
  // Verificar se j√° est√° carregando para evitar chamadas duplicadas
  if (window.isLoadingTickets) {
    console.log('‚è≥ Carregamento j√° em andamento, aguardando...');
    return;
  }
  
  if (!allTicketsCache || allTicketsCache.length === 0) {
    // S√≥ recarregar se NUNCA foi carregado (n√£o se o cache estiver temporariamente vazio)
    if (!window.ticketsLoaded) {
      console.warn('Cache vazio e dados nunca carregados, carregando do Supabase...');
      loadTicketsFromSupabase();
    } else {
      console.log('üìã Cache vazio mas dados j√° foram carregados anteriormente');
    }
    return;
  }
  
  console.log(`üîç Filtrando ${allTicketsCache.length} tickets do cache...`);
  
  // Get filter values
  const periodFilter = document.getElementById('ticketPeriodFilter').value;
  const statusFilter = document.getElementById('ticketStatusFilter').value;
  const priorityFilter = document.getElementById('ticketPriorityFilter').value;
  const typeFilter = document.getElementById('ticketTypeFilter')?.value || 'all';
  const sourceFilter = document.getElementById('ticketSourceFilter')?.value || 'all';
  const companyFilter = document.getElementById('ticketCompanyFilter')?.value || 'all';
  const groupFilter = document.getElementById('ticketGroupFilter')?.value || 'all';
  const agentFilter = document.getElementById('ticketAgentFilter')?.value || 'all';
  const requesterFilter = document.getElementById('ticketRequesterFilter')?.value || 'all';
  const slaFilter = document.getElementById('ticketSlaFilter')?.value || 'all';
  const tagFilter = (document.getElementById('ticketTagFilter')?.value || '').trim().toLowerCase();
  const orderBy = document.getElementById('ticketOrderBy').value;
  const maxResults = 99999; // Sem limite - carrega todos do Supabase
  
  // Start with all cached tickets
  let filteredTickets = [...allTicketsCache];
  
  // Apply filters locally
  // 1. Filter by period
  // Verificar se h√° um per√≠odo personalizado selecionado no calend√°rio
  const customRange = window._ticketCustomRange;
  
  if (customRange && customRange.preset === 'custom' && customRange.start && customRange.end) {
    // Per√≠odo personalizado com datas espec√≠ficas (start/end s√£o objetos Date)
    const startDate = new Date(customRange.start);
    startDate.setHours(0, 0, 0, 0);
    const endDate = new Date(customRange.end);
    endDate.setHours(23, 59, 59, 999);
    
    const beforePeriod = filteredTickets.length;
    filteredTickets = filteredTickets.filter(ticket => {
      const createdDate = new Date(ticket.created_at);
      return createdDate >= startDate && createdDate <= endDate;
    });
    console.log(`üìÖ Filtro de per√≠odo personalizado: ${beforePeriod} ‚Üí ${filteredTickets.length} tickets (${startDate.toLocaleDateString('pt-BR')} at√© ${endDate.toLocaleDateString('pt-BR')})`);
  } else if (periodFilter !== 'all') {
    // Per√≠odo predefinido (7, 30, 90 dias, etc.)
    const days = parseInt(periodFilter);
    const cutoffDate = new Date(Date.now() - (days * 24 * 60 * 60 * 1000));
    
    const beforePeriod = filteredTickets.length;
    filteredTickets = filteredTickets.filter(ticket => {
      const createdDate = new Date(ticket.created_at);
      return createdDate >= cutoffDate;
    });
    console.log(`üìÖ Filtro de per√≠odo: ${beforePeriod} ‚Üí ${filteredTickets.length} tickets (√∫ltimos ${days} dias)`);
  }
  
  // 2. Filter by status
  if (statusFilter !== 'all') {
    const beforeStatus = filteredTickets.length;
    filteredTickets = filteredTickets.filter(ticket => 
      ticket.status === parseInt(statusFilter)
    );
    console.log(`üìã Filtro de status: ${beforeStatus} ‚Üí ${filteredTickets.length} tickets`);
  }
  
  // 3. Filter by priority
  if (priorityFilter !== 'all') {
    const beforePriority = filteredTickets.length;
    filteredTickets = filteredTickets.filter(ticket => 
      ticket.priority === parseInt(priorityFilter)
    );
    console.log(`üéØ Filtro de prioridade: ${beforePriority} ‚Üí ${filteredTickets.length} tickets`);
  }

  // 4. Filter by type
  if (typeFilter !== 'all') {
    const before = filteredTickets.length;
    filteredTickets = filteredTickets.filter(t => (t.type || '').toString() === typeFilter);
    console.log(`üçï Filtro de tipo: ${before} ‚Üí ${filteredTickets.length} tickets`);
  }

  // 5. Filter by source
  if (sourceFilter !== 'all') {
    const before = filteredTickets.length;
    filteredTickets = filteredTickets.filter(t => (t.source != null ? String(t.source) : '') === sourceFilter);
    console.log(`üåê Filtro de origem: ${before} ‚Üí ${filteredTickets.length} tickets`);
  }

  // 6. Filter by company
  if (companyFilter !== 'all') {
    const before = filteredTickets.length;
    filteredTickets = filteredTickets.filter(t => (t.company_name || '‚Äî') === companyFilter);
    console.log(`üè¢ Filtro de empresa: ${before} ‚Üí ${filteredTickets.length} tickets`);
  }

  // 7. Filter by group
  if (groupFilter !== 'all') {
    const before = filteredTickets.length;
    filteredTickets = filteredTickets.filter(t => String(t.group_id || '') === groupFilter);
    console.log(`üë• Filtro de time: ${before} ‚Üí ${filteredTickets.length} tickets`);
  }

  // 8. Filter by agent
  if (agentFilter !== 'all') {
    const before = filteredTickets.length;
    filteredTickets = filteredTickets.filter(t => String(t.responder_id || '') === agentFilter);
    console.log(`üë§ Filtro de agente: ${before} ‚Üí ${filteredTickets.length} tickets`);
  }

  // 8.5 Filter by requester/contato
  if (requesterFilter !== 'all') {
    const before = filteredTickets.length;
    filteredTickets = filteredTickets.filter(t => String(t.requester_id || '') === requesterFilter);
    console.log(`üìû Filtro de contato: ${before} ‚Üí ${filteredTickets.length} tickets`);
  }

  // 9. Filter by SLA state
  if (slaFilter !== 'all') {
    const before = filteredTickets.length;
    const now = new Date();
    filteredTickets = filteredTickets.filter(t => {
      const { first, res, finishedAt } = computeSlaStatus(t);
      switch (slaFilter) {
        case 'first_ok': return first.label === '1¬™ OK';
        case 'first_late': return first.label === '1¬™ SLA';
        case 'res_ok': return res.label === 'Res OK';
        case 'res_late': return res.label === 'Res SLA';
        case 'overdue': {
          const due = t.due_by ? new Date(t.due_by) : null;
          return due && now > due && !finishedAt;
        }
        case 'escalated': return !!t.is_escalated;
        case 'reopened': return !!t.stats_reopened_at;
        default: return true;
      }
    });
    console.log(`‚è±Ô∏è Filtro de SLA (${slaFilter}): ${before} ‚Üí ${filteredTickets.length} tickets`);
  }

  // 10. Filter by tag contains
  if (tagFilter) {
    const before = filteredTickets.length;
    filteredTickets = filteredTickets.filter(t => {
      const tags = Array.isArray(t.tags) ? t.tags : [];
      return tags.some(tag => String(tag).toLowerCase().includes(tagFilter));
    });
    console.log(`üîñ Filtro de tag: ${before} ‚Üí ${filteredTickets.length} tickets`);
  }
  
  // 4. Sort tickets
  sortTickets(filteredTickets, orderBy);
  
  // Limit to maxResults
  ticketsData = filteredTickets.slice(0, maxResults);
  window.ticketsData = ticketsData;
  
  console.log(`‚úÖ Filtros aplicados: ${ticketsData.length} tickets resultantes`);
  
  // Update statistics
  updateTicketStats(ticketsData);
  
  // Render tickets table
  renderTicketsTable(ticketsData);
}

// Buscar conversas do ticket via API Freshdesk
async function fetchTicketConversations(ticketId) {
  try {
    const domain = freshdeskConfig?.domain?.replace('https://', '').replace('http://', '') || 'suportetryvia.freshdesk.com';
    const apiKey = freshdeskConfig?.apiKey || '';
    
    if (!apiKey) {
      console.warn('API Key n√£o configurada');
      return [];
    }
    
    const url = `https://${domain}/api/v2/tickets/${ticketId}/conversations`;
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': 'Basic ' + btoa(apiKey + ':X'),
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      console.error('Erro ao buscar conversas:', response.status);
      return [];
    }
    
    const conversations = await response.json();
    return conversations || [];
  } catch (error) {
    console.error('Erro ao buscar conversas:', error);
    return [];
  }
}

// Renderizar conversas no modal
function renderConversations(conversations) {
  if (!conversations || conversations.length === 0) {
    return '<p style="color: #71717a; text-align: center; padding: 2rem;">Nenhuma conversa encontrada.</p>';
  }
  
  return conversations.map(conv => {
    const isPrivate = conv.private;
    const isIncoming = conv.incoming;
    const fromEmail = conv.from_email || 'Desconhecido';
    const createdAt = formatDateTime(conv.created_at);
    
    // Sanitizar body
    let body = conv.body || conv.body_text || '';
    body = body.replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '').replace(/on\w+="[^"]*"/gi, '');
    
    // Determinar tipo e cor
    let typeLabel, typeColor, typeIcon;
    if (isPrivate) {
      typeLabel = 'Nota Privada';
      typeColor = '#f59e0b';
      typeIcon = 'üîí';
    } else if (isIncoming) {
      typeLabel = 'Cliente';
      typeColor = '#8b5cf6';
      typeIcon = 'üì®';
    } else {
      typeLabel = 'Resposta';
      typeColor = '#10b981';
      typeIcon = 'üì§';
    }
    
    // Anexos
    const attachments = conv.attachments || [];
    const attachmentsHtml = attachments.length > 0 ? `
      <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1);">
        <span style="color: #71717a; font-size: 0.8rem;">üìé Anexos:</span>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
          ${attachments.map(att => `
            <a href="${att.attachment_url}" target="_blank" rel="noopener"
               style="padding: 0.25rem 0.75rem; background: rgba(59,130,246,0.2); color: #60a5fa; 
                      border-radius: 6px; font-size: 0.8rem; text-decoration: none;"
               onmouseover="this.style.background='rgba(59,130,246,0.3)'"
               onmouseout="this.style.background='rgba(59,130,246,0.2)'">
              üìÑ ${att.name || 'Anexo'}
            </a>
          `).join('')}
        </div>
      </div>
    ` : '';
    
    return `
      <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1rem 1.25rem; 
                  border-left: 4px solid ${typeColor}; margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <span style="padding: 0.25rem 0.75rem; background: ${typeColor}20; color: ${typeColor}; 
                         border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
              ${typeIcon} ${typeLabel}
            </span>
            <span style="color: #a1a1aa; font-size: 0.85rem;">${fromEmail}</span>
          </div>
          <span style="color: #71717a; font-size: 0.8rem;">üïê ${createdAt}</span>
        </div>
        <div class="ticket-description-content" style="color: #d4d4d8; line-height: 1.6; font-size: 0.9rem;">
          <style>
            .ticket-description-content, .ticket-description-content * { color: #d4d4d8 !important; }
            .ticket-description-content table { border-collapse: collapse; width: 100%; margin: 0.5rem 0; background: rgba(255,255,255,0.05) !important; }
            .ticket-description-content th, .ticket-description-content td { 
              border: 1px solid rgba(255,255,255,0.2) !important; 
              padding: 0.5rem !important; 
              color: #e4e4e7 !important;
              background: transparent !important;
            }
            .ticket-description-content th { background: rgba(59, 130, 246, 0.2) !important; }
            .ticket-description-content a { color: #60a5fa !important; }
            .ticket-description-content img { max-width: 100%; height: auto; }
          </style>
          ${body}
        </div>
        ${attachmentsHtml}
      </div>
    `;
  }).join('');
}

// Modal para detalhes do ticket
async function showTicketDetails(ticketId) {
  // Buscar ticket nos dados carregados
  const ticket = (window.ticketsData || []).find(t => t.id === ticketId) || 
                 (window.paginatedTickets || []).find(t => t.id === ticketId);
  
  if (!ticket) {
    alert('Ticket n√£o encontrado nos dados carregados.');
    return;
  }
  
  // Usar m√≥dulo centralizado de status se dispon√≠vel
  const statusMap = window.FRESHDESK_STATUS?.MAP || {
    2:  { label: 'Aberto', color: '#3b82f6', icon: 'üîµ' },
    3:  { label: 'Pendente', color: '#f59e0b', icon: '‚è≥' },
    4:  { label: 'Resolvido', color: '#10b981', icon: '‚úÖ' },
    5:  { label: 'Fechado', color: '#6b7280', icon: '‚úîÔ∏è' },
    6:  { label: 'Em Homologa√ß√£o', color: '#8b5cf6', icon: 'üß™' },
    7:  { label: 'Aguardando Cliente', color: '#f59e0b', icon: '‚è∏Ô∏è' },
    8:  { label: 'Em Tratativa', color: '#06b6d4', icon: 'üîÑ' },
    10: { label: 'Em An√°lise', color: '#06b6d4', icon: 'üîç' },
    11: { label: 'Interno', color: '#64748b', icon: 'üè†' },
    12: { label: 'Aguardando Publicar HML', color: '#3b82f6', icon: 'üì¶' },
    13: { label: 'Aguardando Publicar PROD', color: '#8b5cf6', icon: 'üöÄ' },
    14: { label: 'MVP', color: '#ec4899', icon: '‚≠ê' },
    15: { label: 'Valida√ß√£o-Atendimento', color: '#f97316', icon: '‚úçÔ∏è' },
    16: { label: 'Aguardando Parceiros', color: '#a855f7', icon: 'ü§ù' },
    17: { label: 'Pausado', color: '#64748b', icon: '‚è∏Ô∏è' },
    18: { label: 'Valida√ß√£o-CS', color: '#f97316', icon: '‚úçÔ∏è' },
    19: { label: 'Levantamento de Esfor√ßo', color: '#6366f1', icon: 'üìä' },
    20: { label: 'Em Fila DEV', color: '#ef4444', icon: 'üë®‚Äçüíª' },
    21: { label: 'Em Produ√ß√£o', color: '#10b981', icon: 'üü¢' }
  };
  
  const priorityMap = {
    1: { label: 'Baixa', color: '#6b7280' },
    2: { label: 'M√©dia', color: '#f59e0b' },
    3: { label: 'Alta', color: '#f97316' },
    4: { label: 'Urgente', color: '#ef4444' }
  };
  
  const status = statusMap[ticket.status] || { label: `Status ${ticket.status}`, color: '#6b7280', icon: '‚ùì' };
  const priority = priorityMap[ticket.priority] || { label: 'N√£o definida', color: '#6b7280' };
  const groupName = typeof resolveGroupName === 'function' ? resolveGroupName(ticket.group_id) : (ticket.group_id || '-');
  const agentName = typeof resolveAgentName === 'function' ? resolveAgentName(ticket.responder_id) : (ticket.responder_id || '-');
  
  // Limpar HTML da descri√ß√£o mas manter formata√ß√£o b√°sica
  let descriptionHtml = ticket.description || ticket.description_text || '<em>Sem descri√ß√£o</em>';
  // Sanitizar mas manter tags b√°sicas
  descriptionHtml = descriptionHtml
    .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
    .replace(/on\w+="[^"]*"/gi, '');
  
  // Remover modal existente se houver
  const existingModal = document.getElementById('ticketDetailModal');
  if (existingModal) existingModal.remove();
  
  // Criar modal
  const modal = document.createElement('div');
  modal.id = 'ticketDetailModal';
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.85); z-index: 10000;
    display: flex; align-items: center; justify-content: center;
    animation: fadeIn 0.2s ease-out; backdrop-filter: blur(4px);
  `;
  
  modal.innerHTML = `
    <div style="background: linear-gradient(145deg, #1a1a2e, #16213e); border-radius: 16px; 
                width: 95%; max-width: 1200px; max-height: 95vh; overflow: hidden;
                box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
                display: flex; flex-direction: column;">
      
      <!-- Header -->
      <div style="padding: 1.5rem 2rem; background: linear-gradient(90deg, #3b82f6, #8b5cf6);
                  display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h2 style="margin: 0; color: white; font-size: 1.5rem;">
            üé´ Ticket #${ticket.id}
          </h2>
          <p style="margin: 0.25rem 0 0 0; color: rgba(255,255,255,0.8); font-size: 0.9rem;">
            Criado em ${formatDateTime(ticket.created_at)}
          </p>
        </div>
        <button onclick="document.getElementById('ticketDetailModal').remove()" 
                style="background: rgba(255,255,255,0.2); border: none; color: white; 
                       width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
                       font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
                       transition: background 0.2s;"
                onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                onmouseout="this.style.background='rgba(255,255,255,0.2)'">√ó</button>
      </div>
      
      <!-- Content -->
      <div style="padding: 2rem; overflow-y: auto; flex: 1;">
        
        <!-- Badges -->
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
          <span style="padding: 0.5rem 1rem; background: ${status.color}20; color: ${status.color}; 
                       border-radius: 20px; font-weight: 600; border: 1px solid ${status.color}40;">
            ${status.icon} ${status.label}
          </span>
          <span style="padding: 0.5rem 1rem; background: ${priority.color}20; color: ${priority.color}; 
                       border-radius: 20px; font-weight: 600; border: 1px solid ${priority.color}40;">
            ‚ö° ${priority.label}
          </span>
          ${ticket.type ? `<span style="padding: 0.5rem 1rem; background: #06b6d420; color: #06b6d4; 
                                        border-radius: 20px; border: 1px solid #06b6d440;">
            üìÅ ${ticket.type}
          </span>` : ''}
        </div>
        
        <!-- Subject -->
        <div style="margin-bottom: 1.5rem;">
          <h3 style="color: #e4e4e7; margin: 0 0 0.5rem 0; font-size: 1.25rem;">
            ${ticket.subject || 'Sem assunto'}
          </h3>
        </div>
        
        <!-- Info Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
          <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;">
            <div style="color: #a1a1aa; font-size: 0.8rem; margin-bottom: 0.25rem;">üë§ Solicitante</div>
            <div style="color: #e4e4e7; font-weight: 500;">${ticket.requester_name || ticket.requester?.name || ticket.requester_email || '-'}</div>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;">
            <div style="color: #a1a1aa; font-size: 0.8rem; margin-bottom: 0.25rem;">üè¢ Empresa</div>
            <div style="color: #e4e4e7; font-weight: 500;">${ticket.company_name || '-'}</div>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;">
            <div style="color: #a1a1aa; font-size: 0.8rem; margin-bottom: 0.25rem;">üë• Grupo</div>
            <div style="color: #e4e4e7; font-weight: 500;">${groupName}</div>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;">
            <div style="color: #a1a1aa; font-size: 0.8rem; margin-bottom: 0.25rem;">üßë‚Äçüíº Agente</div>
            <div style="color: #e4e4e7; font-weight: 500;">${agentName}</div>
          </div>
        </div>
        
        <!-- Dates -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
          <div style="background: rgba(59, 130, 246, 0.1); padding: 0.75rem 1rem; border-radius: 8px; border-left: 3px solid #3b82f6;">
            <div style="color: #a1a1aa; font-size: 0.75rem;">üìÖ Criado</div>
            <div style="color: #e4e4e7; font-size: 0.9rem;">${formatDateTime(ticket.created_at)}</div>
          </div>
          <div style="background: rgba(139, 92, 246, 0.1); padding: 0.75rem 1rem; border-radius: 8px; border-left: 3px solid #8b5cf6;">
            <div style="color: #a1a1aa; font-size: 0.75rem;">üîÑ Atualizado</div>
            <div style="color: #e4e4e7; font-size: 0.9rem;">${formatDateTime(ticket.updated_at)}</div>
          </div>
          ${ticket.stats_resolved_at ? `
          <div style="background: rgba(16, 185, 129, 0.1); padding: 0.75rem 1rem; border-radius: 8px; border-left: 3px solid #10b981;">
            <div style="color: #a1a1aa; font-size: 0.75rem;">‚úÖ Resolvido</div>
            <div style="color: #e4e4e7; font-size: 0.9rem;">${formatDateTime(ticket.stats_resolved_at)}</div>
          </div>` : ''}
          ${ticket.stats_first_responded_at ? `
          <div style="background: rgba(245, 158, 11, 0.1); padding: 0.75rem 1rem; border-radius: 8px; border-left: 3px solid #f59e0b;">
            <div style="color: #a1a1aa; font-size: 0.75rem;">üí¨ 1¬™ Resposta</div>
            <div style="color: #e4e4e7; font-size: 0.9rem;">${formatDateTime(ticket.stats_first_responded_at)}</div>
          </div>` : ''}
        </div>
        
        <!-- Description -->
        <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1.5rem; 
                    border: 1px solid rgba(255,255,255,0.08);">
          <h4 style="color: #a1a1aa; margin: 0 0 1rem 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
            üìù Descri√ß√£o do Ticket
          </h4>
          <div class="ticket-description-content" style="color: #d4d4d8; line-height: 1.7; font-size: 0.95rem; max-height: 300px; overflow-y: auto;">
            <style>
              .ticket-description-content, .ticket-description-content * { color: #d4d4d8 !important; }
              .ticket-description-content table { border-collapse: collapse; width: 100%; margin: 0.5rem 0; background: rgba(255,255,255,0.05) !important; }
              .ticket-description-content th, .ticket-description-content td { 
                border: 1px solid rgba(255,255,255,0.2) !important; 
                padding: 0.5rem !important; 
                color: #e4e4e7 !important;
                background: transparent !important;
              }
              .ticket-description-content th { background: rgba(59, 130, 246, 0.2) !important; font-weight: 600; }
              .ticket-description-content tr:nth-child(even) { background: rgba(255,255,255,0.03) !important; }
              .ticket-description-content a { color: #60a5fa !important; }
              .ticket-description-content img { max-width: 100%; height: auto; border-radius: 8px; }
            </style>
            ${descriptionHtml}
          </div>
        </div>
        
        ${ticket.tags && ticket.tags.length > 0 ? `
        <!-- Tags -->
        <div style="margin-top: 1.5rem;">
          <h4 style="color: #a1a1aa; margin: 0 0 0.75rem 0; font-size: 0.9rem;">üè∑Ô∏è Tags</h4>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            ${ticket.tags.map(tag => `
              <span style="padding: 0.25rem 0.75rem; background: rgba(99, 102, 241, 0.2); 
                           color: #818cf8; border-radius: 12px; font-size: 0.8rem;">
                ${tag}
              </span>
            `).join('')}
          </div>
        </div>` : ''}
        
        <!-- Custom Fields if any -->
        ${ticket.custom_fields && Object.keys(ticket.custom_fields).length > 0 ? `
        <div style="margin-top: 1.5rem;">
          <h4 style="color: #a1a1aa; margin: 0 0 0.75rem 0; font-size: 0.9rem;">üìã Campos Personalizados</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
            ${Object.entries(ticket.custom_fields).filter(([k,v]) => v).map(([key, value]) => `
              <div style="background: rgba(255,255,255,0.03); padding: 0.5rem 0.75rem; border-radius: 6px;">
                <span style="color: #71717a; font-size: 0.75rem;">${key.replace('cf_', '').replace(/_/g, ' ')}: </span>
                <span style="color: #d4d4d8;">${value}</span>
              </div>
            `).join('')}
          </div>
        </div>` : ''}
        
        <!-- Conversas -->
        <div style="margin-top: 1.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h4 style="color: #a1a1aa; margin: 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
              üí¨ Hist√≥rico de Conversas
            </h4>
            <span id="conversationsCount" style="color: #71717a; font-size: 0.8rem;"></span>
          </div>
          <div id="conversationsContainer" style="max-height: 400px; overflow-y: auto; padding-right: 0.5rem;">
            <div style="display: flex; align-items: center; justify-content: center; padding: 2rem; color: #71717a;">
              <div style="text-align: center;">
                <div class="loading-spinner" style="width: 32px; height: 32px; border: 3px solid rgba(255,255,255,0.1); 
                            border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                <span>Carregando conversas...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div style="padding: 1rem 2rem; background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.1);
                  display: flex; justify-content: space-between; align-items: center;">
        <a href="${(freshdeskConfig?.domain || 'https://suportetryvia.freshdesk.com').replace(/\/$/, '')}/a/tickets/${ticket.id}" 
           target="_blank" rel="noopener"
           style="color: #3b82f6; text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;"
           onmouseover="this.style.textDecoration='underline'"
           onmouseout="this.style.textDecoration='none'">
          üîó Abrir no Freshdesk
        </a>
        <button onclick="document.getElementById('ticketDetailModal').remove()"
                style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                       border: none; border-radius: 8px; color: white; cursor: pointer;
                       font-weight: 600; transition: transform 0.2s, box-shadow 0.2s;"
                onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(59,130,246,0.4)'"
                onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
          Fechar
        </button>
      </div>
    </div>
    <style>
      @keyframes spin { to { transform: rotate(360deg); } }
    </style>
  `;
  
  // Fechar ao clicar fora
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.remove();
  });
  
  // Fechar com ESC
  const escHandler = (e) => {
    if (e.key === 'Escape') {
      modal.remove();
      document.removeEventListener('keydown', escHandler);
    }
  };
  document.addEventListener('keydown', escHandler);
  
  document.body.appendChild(modal);
  
  // Buscar conversas em background
  fetchTicketConversations(ticketId).then(conversations => {
    const container = document.getElementById('conversationsContainer');
    const countSpan = document.getElementById('conversationsCount');
    
    if (container) {
      container.innerHTML = renderConversations(conversations);
    }
    if (countSpan) {
      countSpan.textContent = conversations.length > 0 ? `${conversations.length} mensagem(ns)` : '';
    }
  }).catch(err => {
    console.error('Erro ao carregar conversas:', err);
    const container = document.getElementById('conversationsContainer');
    if (container) {
      container.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 1rem;">Erro ao carregar conversas. Verifique a configura√ß√£o da API.</p>';
    }
  });
}

function populateDynamicFilters(tickets) {
  const setOptions = (selectId, values, formatter = (v)=>v) => {
    const sel = document.getElementById(selectId);
    if (!sel) return;
    const current = sel.value;
    const unique = Array.from(values).filter(v => v !== undefined && v !== null);
    unique.sort((a,b) => String(formatter(a)).localeCompare(String(formatter(b)), 'pt-BR'));
    const placeholder = sel.querySelector('option[value="all"]')?.outerHTML || '<option value="all">Todos</option>';
    sel.innerHTML = placeholder + unique.map(v => `<option value="${String(v)}">${formatter(v)}</option>`).join('');
    if ([...sel.options].some(o => o.value === current)) sel.value = current; // preserve selection
  };

  // Type
  setOptions('ticketTypeFilter', new Set(tickets.map(t => t.type).filter(Boolean)));

  // Source with label
  const sourceMap = {
    1: 'Email', 2: 'Portal', 3: 'Telefone', 4: 'Feedback', 5: 'Chat', 6: 'Sa√≠da', 7: 'Facebook', 8: 'Twitter'
  };
  setOptions('ticketSourceFilter', new Set(tickets.map(t => t.source).filter(v => v !== undefined && v !== null)), v => `${sourceMap[v] || v}`);

  // Company by name
  setOptions('ticketCompanyFilter', new Set(tickets.map(t => t.company_name || '‚Äî')));

  // Group and Agent (IDs) com labels resolvidos por lookup
  setOptions('ticketGroupFilter', new Set(tickets.map(t => t.group_id).filter(v => v !== undefined && v !== null)), v => resolveGroupName(v));
  setOptions('ticketAgentFilter', new Set(tickets.map(t => t.responder_id).filter(v => v !== undefined && v !== null)), v => resolveAgentName(v));
  
  // Requester/Contatos - usar requester_name ou requester_email
  const requesterSet = new Set();
  tickets.forEach(t => {
    if (t.requester_id) {
      requesterSet.add(t.requester_id);
    }
  });
  setOptions('ticketRequesterFilter', requesterSet, v => {
    const ticket = tickets.find(t => t.requester_id === v);
    return ticket?.requester_name || ticket?.requester_email || `ID: ${v}`;
  });
}

// Sort tickets
function sortTickets(tickets, orderBy) {
  tickets.sort((a, b) => {
    switch(orderBy) {
      case 'created_at':
        return new Date(b.created_at) - new Date(a.created_at);
      case 'updated_at':
        return new Date(b.updated_at) - new Date(a.updated_at);
      case 'priority':
        return b.priority - a.priority;
      case 'status':
        return a.status - b.status;
      default:
        return 0;
    }
  });
  return tickets;
}

// Filter change handlers
window.addEventListener('DOMContentLoaded', () => {
  // Period filter - reload from API as it might get more data
  document.getElementById('ticketPeriodFilter')?.addEventListener('change', () => {
    if (allTicketsCache.length > 0) {
      filterTicketsFromCache();
    } else {
      loadTicketsFromSupabase();
    }
  });
  
  // Status filter - use cache
  document.getElementById('ticketStatusFilter')?.addEventListener('change', () => {
    if (allTicketsCache.length > 0) {
      filterTicketsFromCache();
    } else {
      loadTicketsFromSupabase();
    }
  });

  // Priority filter - use cache
  document.getElementById('ticketPriorityFilter')?.addEventListener('change', () => {
    if (allTicketsCache.length > 0) {
      filterTicketsFromCache();
    } else {
      loadTicketsFromSupabase();
    }
  });

  // Order by - use cache
  document.getElementById('ticketOrderBy')?.addEventListener('change', () => {
    if (allTicketsCache.length > 0) {
      filterTicketsFromCache();
    } else if (ticketsData.length > 0) {
      // Just re-sort existing data
      const orderBy = document.getElementById('ticketOrderBy').value;
      sortTickets(ticketsData, orderBy);
      renderTicketsTable(ticketsData);
    }
  });
  
  // New dynamic filters
  ['ticketTypeFilter','ticketSourceFilter','ticketCompanyFilter','ticketGroupFilter','ticketAgentFilter','ticketRequesterFilter','ticketSlaFilter']
    .forEach(id => {
      document.getElementById(id)?.addEventListener('change', () => {
        if (allTicketsCache.length > 0) filterTicketsFromCache();
      });
    });
  document.getElementById('ticketTagFilter')?.addEventListener('input', () => {
    if (allTicketsCache.length > 0) filterTicketsFromCache();
  });
  
  // Column toggles
  document.querySelectorAll('#ticketColumnsControls input[type=checkbox]')
    .forEach(chk => chk.addEventListener('change', applyColumnVisibility));
});

// =============================================
// END OF FRESHDESK API INTEGRATION
// =============================================

// Fun√ß√£o de teste r√°pido para Supabase (usar no console)
window.testSupabase = async function() {
  console.log('üß™ Testando conex√£o Supabase...');
  
  // Teste 1: Biblioteca carregada
  if (!window.supabase) {
    console.error('‚ùå Biblioteca Supabase n√£o carregada');
    return;
  }
  console.log('‚úÖ Biblioteca Supabase carregada');
  
  // Teste 2: Cliente inicializado
  const client = await initSupabase();
  if (!client) {
    console.error('‚ùå Cliente Supabase n√£o inicializado');
    return;
  }
  console.log('‚úÖ Cliente Supabase inicializado');
  
  // Teste 3: Buscar dados
  try {
    const { data, error, count } = await client
      .from('tickets')
      .select('*', { count: 'exact', head: true });
    
    if (error) throw error;
    
    console.log(`‚úÖ Conex√£o com Supabase OK - Total de tickets: ${count || 0}`);
    return true;
  } catch (error) {
    console.error('‚ùå Erro ao conectar com Supabase:', error);
    return false;
  }
};
 </script>

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Supabase Loader -->
  <script src="js/supabase-loader.js"></script>
  
  <!-- Supabase Chunked Loader para grandes volumes -->
  <script src="js/supabase-chunked-loader.js"></script>
  
  <!-- Core Data Module - DATA, lookups, resolvers -->
  <script src="js/core-data.js?v=20260108T1700"></script>
  
  <!-- Configura√ß√£o centralizada de Status do Freshdesk -->
  <script src="js/status-config.js?v=20251204T1420"></script>
  
  <!-- BI Analytics (Unified) -->
  <script src="js/bi-analytics.js?v=20251203T1140"></script>
  <script src="js/bi-analytics-methods.js?v=20251215T1510"></script>
  <script src="js/bi-analytics-charts.js?v=20251203T0935"></script>
  <script src="js/bi-analytics-metrics.js?v=20251203T0935"></script>
  
  <!-- Navigation Functions Fix -->
  <script src="js/navigation-functions.js?v=20251215T1400"></script>
  
  <!-- CSAT Module - Satisfa√ß√£o do Cliente -->
  <script src="js/csat-module.js?v=20251209T1740"></script>
  
  <!-- BI CSAT & Time Entries Module -->
  <script src="js/bi-csat-time-module.js?v=20251210T1515"></script>
  
  <!-- BI Acompanhamento Module (Tags) -->
  <script src="js/bi-acompanhamento-module.js?v=20251211T0900"></script>
  
  <!-- BI Analytics Init -->
  <script src="js/bi-analytics-init.js?v=20251201T1115"></script>
  
  <!-- M√≥dulos de Funcionalidades Extras -->
  <script src="js/global-search.js?v=20251217T1600"></script>
  <script src="js/interactive-charts.js?v=20251217T1600"></script>
  
  <!-- Conquistas de Gamifica√ß√£o (300 badges) -->
  <script src="js/gamification-badges.js?v=20251218T0100"></script>
  <script src="js/gamification-badges-2.js?v=20251218T0100"></script>
  <script src="js/gamification-badges-3.js?v=20251218T0100"></script>
  <script src="js/gamification-badges-4.js?v=20251218T0100"></script>
  <script src="js/gamification-badges-loader.js?v=20251218T0100"></script>
  
  <script src="js/gamification.js?v=20251218T0100"></script>
  <script src="js/chatbot.js?v=20251217T1640"></script>
  
  <!-- Premium Icons (SVG) -->
  <script src="js/premium-icons.js?v=20251223"></script>
  
  <!-- IA Tryviano Premium v4.0 -->
  <script src="js/chatbot-intelligence.js?v=20251218T0200"></script>
  <script src="js/chatbot-premium.js?v=20260108T1500"></script>
  
  <!-- Inicializa√ß√£o autom√°tica na aba Tickets -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log(' Iniciando sistema na aba Tickets...');
      
      // Esconder Dashboard e Analytics
      const mainContent = document.getElementById('mainContent');
      if (mainContent) mainContent.style.display = 'none';
      
      const biContainer = document.getElementById('biContainer');
      if (biContainer) biContainer.classList.remove('active');
      
      const analyticsContainer = document.getElementById('analyticsContainer');
      if (analyticsContainer) analyticsContainer.style.display = 'none';
      
      // Mostrar Tickets
      const ticketsContainer = document.getElementById('ticketsContainer');
      if (ticketsContainer) {
        ticketsContainer.style.display = 'block';
        
        // Carregar prefer√™ncia do checkbox
        const autoLoadCheckbox = document.getElementById('autoLoadTickets');
        const autoLoad = localStorage.getItem('autoLoadTickets');
        if (autoLoadCheckbox) {
          autoLoadCheckbox.checked = autoLoad === 'true';
        }
        
        // Carregar tickets automaticamente se configurado
        if (autoLoad === 'true') {
          console.log(' Carregando tickets automaticamente...');
          setTimeout(() => {
            if (typeof loadFreshdeskTickets === 'function') {
              loadFreshdeskTickets();
            }
          }, 1000);
        }
      }
      
      // Atualizar sidebar
      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
      });
      const ticketsMenuItem = document.querySelector('[onclick="showTickets()"]');
      if (ticketsMenuItem) ticketsMenuItem.classList.add('active');
    });
  </script>

  <!-- Scripts adicionais (BI Analytics j√° carregado acima) -->
  <script src="js/presentation-mode-v2.js?v=20251203T0935"></script>
  <script src="js/reports-module-v2.js?v=20260112T1200"></script>
  <script src="js/date-range-picker.js?v=20251204T1156"></script>
  <script src="js/ai-transformers.js?v=20251201T1115"></script>
  <script src="js/insights-module.js?v=20251201T1115"></script>
  <script src="js/glossary-module.js?v=20251201T1200"></script>
  <script src="js/reports-module.js?v=20251215T1500"></script>
  <script src="js/bi-extra-data-module.js?v=20251215T1555"></script>
  <script src="js/annotations-module.js?v=20250126T0100"></script>
  
  <script>
    // Aguardar carregamento completo
    document.addEventListener('DOMContentLoaded', function() {
      console.log('‚úÖ BI Analytics carregado e pronto para uso');
      
      // Verificar se biAnalytics foi criado
      if (window.biAnalytics) {
        console.log('‚úÖ window.biAnalytics dispon√≠vel');
        
        // üöÄ AUTO-CARREGAR DADOS DO SUPABASE AO INICIAR
        console.log('üîÑ Iniciando carregamento autom√°tico dos dados...');
        setTimeout(() => {
          if (typeof loadTicketsFromSupabase === 'function') {
            loadTicketsFromSupabase();
          } else if (window.biAnalytics && typeof window.biAnalytics.loadFromSupabase === 'function') {
            window.biAnalytics.loadFromSupabase();
          } else {
            console.log('‚ö†Ô∏è Fun√ß√£o de carregamento n√£o encontrada, tentando loadFreshdeskTickets...');
            if (typeof loadFreshdeskTickets === 'function') {
              loadFreshdeskTickets();
            }
          }
        }, 500);
      } else {
        console.error('‚ùå window.biAnalytics n√£o foi criado');
      }
      
      // Inicializar Date Range Picker para todos os inputs de data
      setTimeout(() => {
        if (window.dateRangePicker) {
          // Relat√≥rios
          const reportStart = document.getElementById('reportStartDate');
          const reportEnd = document.getElementById('reportEndDate');
          if (reportStart && reportEnd) {
            window.dateRangePicker.attachTo(reportStart, reportEnd, (start, end) => {
              console.log('üìÖ Per√≠odo relat√≥rio:', start.toLocaleDateString(), '-', end.toLocaleDateString());
            });
          }
          console.log('üìÖ Date Range Picker inicializado');
        }
        
        // Substituir select de per√≠odo da aba Tickets por date picker unificado
        if (window.DateRangePicker && window.DateRangePicker.replaceSelectWithPicker) {
          window.DateRangePicker.replaceSelectWithPicker('ticketPeriodFilter', (range) => {
            console.log('üìÖ Tickets - Per√≠odo alterado:', range);
            // Atualizar o select hidden para manter compatibilidade
            const select = document.getElementById('ticketPeriodFilter');
            if (select) {
              if (range.preset === 'all') {
                select.value = 'all';
                window._ticketCustomRange = null; // Limpar per√≠odo personalizado
              } else if (range.preset === 'custom') {
                // Para per√≠odo personalizado, usar 'all' e filtrar pelas datas espec√≠ficas
                select.value = 'all';
                window._ticketCustomRange = range;
                console.log('üìÖ Per√≠odo personalizado definido:', range.start?.toLocaleDateString('pt-BR'), 'at√©', range.end?.toLocaleDateString('pt-BR'));
              } else {
                select.value = range.preset;
                window._ticketCustomRange = null; // Limpar per√≠odo personalizado
              }
              select.dispatchEvent(new Event('change'));
            }
          });
          console.log('üìÖ Date Picker unificado aplicado na aba Tickets');
        }
      }, 800);
    });
    
    // Fun√ß√£o de navega√ß√£o para Apresenta√ß√£o V2
    function showPresentationMode() {
      // Esconder topbar
      if (typeof window.showTopbar === 'function') {
        window.showTopbar(false);
      }
      
      // Esconder containers espec√≠ficos PRIMEIRO (inclui biAnalyticsContainer)
      const containersToHide = [
        'biAnalyticsContainer', 'ticketsContainer', 'mainContent',
        'comparativeContainer', 'reportsSetup', 'biContainer', 'insightsContainer', 'glossaryContainer',
        'presentation-container', 'presentationContainer', 'reportsContainer'
      ];
      containersToHide.forEach(id => {
        const elem = document.getElementById(id);
        if (elem) {
          elem.style.display = 'none';
          elem.classList.remove('active');
        }
      });
      
      // Ocultar todas as se√ß√µes (menos o presentation-container)
      document.querySelectorAll('main, section:not(#presentation-container)').forEach(s => s.style.display = 'none');
      
      // Usar helper se dispon√≠vel
      if (typeof window.hideBIAnalyticsContainer === 'function') {
        window.hideBIAnalyticsContainer();
      }
      
      // Mostrar container de apresenta√ß√£o V2
      const container = document.getElementById('presentation-container');
      if (container) {
        container.style.display = 'block';
        
        // Renderizar interface V2
        if (window.presentationModeV2) {
          window.presentationModeV2.render();
        }
      }
      
      // Atualizar menu ativo
      document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
      const menuItem = document.querySelector('.sidebar-item[onclick*="showPresentationMode"]');
      if (menuItem) menuItem.classList.add('active');
    }
    
    // üêä Easter Egg: Crocodilo do Nilo (Ctrl+√á)
    (function() {
      let crocoActive = false;
      
      document.addEventListener('keydown', function(e) {
        // Ctrl+√á (c√≥digo 186 ou 221 dependendo do layout, ou 'Dead' em pt-BR)
        if (e.ctrlKey && (e.key === '√ß' || e.key === '√á' || e.code === 'BracketRight' || e.code === 'Semicolon')) {
          e.preventDefault();
          if (!crocoActive) spawnCrocodile();
        }
      });
      
      function spawnCrocodile() {
        crocoActive = true;
        
        // Criar container do crocodilo
        const croco = document.createElement('div');
        croco.id = 'nile-crocodile';
        croco.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%) scale(0);
          z-index: 999999;
          pointer-events: none;
          filter: drop-shadow(0 20px 40px rgba(0,0,0,0.6));
          animation: crocoAppear 0.3s ease-out forwards;
        `;
        
        // Crocodilo em GIF - maior e centralizado
        croco.innerHTML = `
          <img src="8sHa.gif" style="width: 600px; height: auto;" alt="Crocodilo">
        `;
        
        // Adicionar estilos de anima√ß√£o
        const style = document.createElement('style');
        style.id = 'croco-styles';
        style.textContent = `
          @keyframes crocoAppear {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
          }
          @keyframes crocoDisappear {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
          }
        `;
        
        document.head.appendChild(style);
        document.body.appendChild(croco);
        
        // Mensagem divertida no console
        console.log('%cüêä CROCODILO DO NILO AVISTADO! üêä', 'font-size: 24px; color: #22c55e; font-weight: bold;');
        
        // Remover ap√≥s 4 segundos
        setTimeout(() => {
          croco.style.animation = 'crocoDisappear 0.3s ease-in forwards';
          setTimeout(() => {
            croco.remove();
            document.getElementById('croco-styles')?.remove();
            crocoActive = false;
          }, 300);
        }, 4000);
      }
    })();

    /// (function() {
    ///         // Verificar se o usu√°rio veio da p√°gina Portal.html
    ///        const referrerPermitido = 'https://tryvia.github.io/TryviaBI/Portal.html';
    ///        const paginaLogin = 'https://tryvia.github.io/TryviaBI/tryvia_bi_login%20(1).html';
            
    ///         // Obter o referrer atual
    ///         const referrerAtual = document.referrer;
            
    ///         // Verificar se o referrer est√° vazio (acesso direto) ou n√£o √© o permitido
    ///         if (!referrerAtual || !referrerAtual.includes(referrerPermitido)) {
    ///             // Verificar se n√£o estamos j√° na p√°gina de login para evitar loop infinito
    ///             if (window.location.href !== paginaLogin) {
    ///                 // Redirecionar para a p√°gina de login
    ///                 window.location.replace(paginaLogin);
    ///             }
    ///         }
    ///     })();
       
  </script>
</body>
</html>
